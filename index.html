<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better QWERTY - Improve Your Typing Skills</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f8f8;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
            border-radius: 0;
            padding: 48px 24px;
            box-shadow: none;
        }

        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 2.25em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .subtitle {
            text-align: center;
            color: #737373;
            margin-bottom: 40px;
            font-size: 1em;
            font-weight: 400;
        }

        .finger-selector {
            margin-bottom: 24px;
            padding: 20px 24px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .finger-buttons {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .hand-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hand-label {
            font-weight: 500;
            color: #525252;
            font-size: 0.875em;
            white-space: nowrap;
        }

        .fingers-visual {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }

        .keyboard {
            margin: 16px 0;
            padding: 32px;
            background: white;
            border-radius: 16px;
            width: 100%;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .keyboard-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            justify-content: center;
        }

        .keyboard-row:nth-child(2) {
            margin-left: 30px;
        }

        .keyboard-row:nth-child(3) {
            margin-left: 45px;
        }

        .keyboard-row:nth-child(4) {
            margin-left: 60px;
        }

        .key {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f8f8;
            border: 1.5px solid #ececec;
            border-radius: 10px;
            color: #525252;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            position: relative;
        }

        .key:hover {
            background: #f0f0f0;
            border-color: #e0e0e0;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .key.selected {
            background: white;
            border-color: #e2b714;
            border-width: 2px;
            color: #404040;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(226, 183, 20, 0.15);
        }

        .key.space {
            width: 350px;
            opacity: 0.6;
            cursor: default;
        }

        .key.space:hover {
            transform: none;
        }

        .key.tab {
            width: 80px;
        }

        .key.caps {
            width: 90px;
        }

        .key.shift-left {
            width: 105px;
        }

        .key.shift-right {
            width: 120px;
        }

        .key.backspace {
            width: 90px;
        }

        .key.enter {
            width: 100px;
        }

        .key-label {
            font-size: 0.7em;
            position: absolute;
            top: 5px;
            left: 8px;
            opacity: 0.6;
        }

        .key-main {
            font-size: 1.15em;
            margin-top: 10px;
        }

        .key.tab, .key.caps, .key.shift-left, .key.shift-right,
        .key.backspace, .key.enter {
            font-size: 0.75em;
            background: #efefef;
            color: #737373;
            font-weight: 500;
        }

        .key.tab:hover, .key.caps:hover, .key.shift-left:hover,
        .key.shift-right:hover, .key.backspace:hover, .key.enter:hover {
            background: #e5e5e5;
            color: #525252;
        }

        .key.tab.selected, .key.caps.selected, .key.shift-left.selected,
        .key.shift-right.selected, .key.backspace.selected, .key.enter.selected {
            background: white;
            border-color: #e2b714;
            border-width: 2px;
            color: #404040;
        }

        .key.home-row {
            position: relative;
        }

        .key.home-row::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #95a5a6;
            border-radius: 2px;
        }

        .key.home-row.selected::after {
            background: white;
        }

        /* Finger color coding - ONLY when selected */
        .key.selected[data-finger="left-pinky"] {
            background: #ec4899;
            border-color: #db2777;
            color: #831843;
        }

        .key.selected[data-finger="left-ring"] {
            background: #8b5cf6;
            border-color: #7c3aed;
            color: #4c1d95;
        }

        .key.selected[data-finger="left-middle"] {
            background: #3b82f6;
            border-color: #2563eb;
            color: #1e3a8a;
        }

        .key.selected[data-finger="left-index"] {
            background: #10b981;
            border-color: #059669;
            color: #064e3b;
        }

        .key.selected[data-finger="right-index"] {
            background: #e2b714;
            border-color: #d1a513;
            color: #78350f;
        }

        .key.selected[data-finger="right-middle"] {
            background: #ef4444;
            border-color: #dc2626;
            color: #7f1d1d;
        }

        .key.selected[data-finger="right-ring"] {
            background: #ec4899;
            border-color: #db2777;
            color: #831843;
        }

        .key.selected[data-finger="right-pinky"] {
            background: #8b5cf6;
            border-color: #7c3aed;
            color: #4c1d95;
        }

        .key.selected[data-finger] {
            transform: translateY(-2px);
            filter: none;
        }

        .key.selected[data-finger]:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        .key.selected[data-finger="left-pinky"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        .key.selected[data-finger="left-ring"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        .key.selected[data-finger="left-middle"]:hover {
            background: #60a5fa;
            border-color: #93c5fd;
        }

        .key.selected[data-finger="left-index"]:hover {
            background: #34d399;
            border-color: #6ee7b7;
        }

        .key.selected[data-finger="right-index"]:hover {
            background: #fbbf24;
            border-color: #fcd34d;
        }

        .key.selected[data-finger="right-middle"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        .key.selected[data-finger="right-ring"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        .key.selected[data-finger="right-pinky"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        /* Visual Feedback Animations */
        @keyframes keyPressCorrect {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                transform: scale(0.95);
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes keyPressError {
            0% {
                transform: scale(1) translateX(0);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            25% {
                transform: scale(0.95) translateX(-2px);
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
            50% {
                transform: scale(0.95) translateX(2px);
            }
            75% {
                transform: scale(0.95) translateX(-2px);
            }
            100% {
                transform: scale(1) translateX(0);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .key.flash-correct {
            animation: keyPressCorrect 0.3s ease;
        }

        .key.flash-error {
            animation: keyPressError 0.4s ease;
        }

        .finger-btn {
            width: 28px;
            border: none;
            border-radius: 14px 14px 4px 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            overflow: visible;
        }

        .finger-visual {
            width: 100%;
            border-radius: 14px 14px 4px 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0;
            transition: all 0.15s ease;
            opacity: 0.85;
        }

        .finger-label {
            display: none;
        }

        /* Compact finger heights */
        .finger-btn[data-finger="left-pinky"] .finger-visual,
        .finger-btn[data-finger="right-pinky"] .finger-visual {
            height: 35px;
        }

        .finger-btn[data-finger="left-ring"] .finger-visual,
        .finger-btn[data-finger="right-ring"] .finger-visual {
            height: 45px;
        }

        .finger-btn[data-finger="left-middle"] .finger-visual,
        .finger-btn[data-finger="right-middle"] .finger-visual {
            height: 50px;
        }

        .finger-btn[data-finger="left-index"] .finger-visual,
        .finger-btn[data-finger="right-index"] .finger-visual {
            height: 42px;
        }

        /* Finger colors */
        .finger-btn[data-finger="left-pinky"] .finger-visual {
            background: #ec4899;
        }

        .finger-btn[data-finger="left-ring"] .finger-visual {
            background: #8b5cf6;
        }

        .finger-btn[data-finger="left-middle"] .finger-visual {
            background: #3b82f6;
        }

        .finger-btn[data-finger="left-index"] .finger-visual {
            background: #10b981;
        }

        .finger-btn[data-finger="right-index"] .finger-visual {
            background: #e2b714;
        }

        .finger-btn[data-finger="right-middle"] .finger-visual {
            background: #ef4444;
        }

        .finger-btn[data-finger="right-ring"] .finger-visual {
            background: #ec4899;
        }

        .finger-btn[data-finger="right-pinky"] .finger-visual {
            background: #8b5cf6;
        }

        .finger-btn:hover {
            transform: translateY(-1px);
        }

        .finger-btn:hover .finger-visual {
            opacity: 1;
        }

        .finger-btn.active {
            transform: translateY(-2px);
        }

        .finger-btn.active .finger-visual {
            opacity: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .finger-btn.active::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .selected-keys {
            text-align: center;
            margin: 24px 0;
            padding: 20px 24px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e8e8e8;
            font-size: 0.95em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .selected-keys strong {
            color: #262626;
            font-weight: 600;
        }

        /* Main Layout - Push design */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Lessons Sidebar */
        .lessons-sidebar {
            width: 380px;
            min-width: 380px;
            height: 100vh;
            background: white;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
            position: sticky;
            top: 0;
            will-change: transform;
            margin-left: -380px;
        }

        body.dark-mode .lessons-sidebar {
            background: #18191a;
        }

        .lessons-sidebar.open {
            transform: translateX(0);
            margin-left: 0;
        }

        .lessons-sidebar-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 24px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        body.dark-mode .lessons-sidebar-header {
            background: #18191a;
            border-bottom-color: #2a2d32;
        }

        .lessons-sidebar-header h3 {
            font-size: 1.5em;
            color: #1a1a1a;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lessons-sidebar-header h3::before {
            content: "ðŸ“š";
            font-size: 1.2em;
            line-height: 1;
        }

        body.dark-mode .lessons-sidebar-header h3 {
            color: #e8e8e8;
        }

        .sidebar-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f8f8f8;
            border-radius: 8px;
            font-size: 24px;
            color: #525252;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .sidebar-close:hover {
            background: #e8e8e8;
            color: #1a1a1a;
        }

        body.dark-mode .sidebar-close {
            background: #2a2d32;
            color: #a0a0a0;
        }

        body.dark-mode .sidebar-close:hover {
            background: #3a3d42;
            color: #e8e8e8;
        }

        .lessons-sidebar-content {
            padding: 24px;
        }

        .lessons-subtitle {
            color: #737373;
            font-size: 0.9em;
            margin-bottom: 20px;
            text-align: center;
        }

        body.dark-mode .lessons-subtitle {
            color: #888;
        }

        /* Container - grows to fill available space */
        .container {
            flex: 1;
            min-width: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Lessons Toggle Button */
        .lessons-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 900;
            padding: 10px;
            color: #2d3748;
        }

        body.dark-mode .lessons-toggle {
            background: #2c2e31;
            color: #d1d0c5;
        }

        .lessons-toggle:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.05);
        }

        body.dark-mode .lessons-toggle:hover {
            background: #3a3c3f;
        }

        .lessons-toggle:active {
            transform: translateY(0) scale(1);
        }

        .lessons-toggle svg {
            color: inherit;
        }

        .lessons-toggle .toggle-text {
            display: none;
        }

        /* Active Course Title */
        .active-course-title {
            position: fixed;
            top: 20px;
            left: 72px;
            height: 44px;
            padding: 0 16px;
            border-radius: 22px;
            background: white;
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 900;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode .active-course-title {
            background: #2c2e31;
            color: #d1d0c5;
        }

        .active-course-title.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .lessons-toggle .progress-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            font-size: 0.65em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        body.dark-mode .lessons-toggle .progress-badge {
            border-color: #2c2e31;
        }

        body.focus-mode .lessons-toggle {
            opacity: 0.3;
        }

        body.focus-mode .lessons-toggle:hover {
            opacity: 1;
        }

        .lessons-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .lesson-card {
            padding: 20px;
            background: #f8f8f8;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .lesson-card {
            background: #1e2023;
            border-color: #2a2d32;
        }

        .lesson-card:hover {
            border-color: #d0d0d0;
        }

        body.dark-mode .lesson-card:hover {
            border-color: #4a4d52;
        }

        .lesson-card.active {
            border-color: #e2b714;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        body.dark-mode .lesson-card.active {
            background: linear-gradient(135deg, #2a2415 0%, #3a2f1a 100%);
            border-color: #e2b714;
        }

        .lesson-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 1;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .lesson-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.1);
        }

        body.dark-mode .lesson-delete-btn {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        body.dark-mode .lesson-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        /* Mark as Finished button */
        .lesson-mark-finished-btn {
            width: 100%;
            padding: 8px 12px;
            margin-top: 12px;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lesson-mark-finished-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
            transform: translateY(-1px);
        }

        body.dark-mode .lesson-mark-finished-btn {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.4);
        }

        body.dark-mode .lesson-mark-finished-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Completed badge */
        .lesson-completed-badge {
            width: 100%;
            padding: 8px 12px;
            margin-top: 12px;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lesson-completed-badge:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        body.dark-mode .lesson-completed-badge {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.4);
        }

        body.dark-mode .lesson-completed-badge:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
        }

        /* Completed course card styling */
        .lesson-card.completed {
            opacity: 0.88;
        }

        .lesson-card.completed:hover {
            opacity: 1;
        }

        /* Placeholder card for creating custom courses */
        .lesson-card-placeholder {
            border: 2px dashed #d0d0d0 !important;
            background: #fafafa !important;
        }

        body.dark-mode .lesson-card-placeholder {
            border-color: #3a3d42 !important;
            background: #1a1c1e !important;
        }

        .lesson-card-placeholder .lesson-title,
        .lesson-card-placeholder .lesson-description {
            outline: none;
            transition: all 0.2s;
            cursor: text;
        }

        .lesson-card-placeholder .lesson-title:hover,
        .lesson-card-placeholder .lesson-description:hover {
            background: rgba(226, 183, 20, 0.03);
            border-radius: 4px;
        }

        .lesson-card-placeholder .lesson-title:focus,
        .lesson-card-placeholder .lesson-description:focus {
            background: rgba(226, 183, 20, 0.08);
            border-radius: 4px;
        }

        body.dark-mode .lesson-card-placeholder .lesson-title:hover,
        body.dark-mode .lesson-card-placeholder .lesson-description:hover {
            background: rgba(226, 183, 20, 0.05);
        }

        body.dark-mode .lesson-card-placeholder .lesson-title:focus,
        body.dark-mode .lesson-card-placeholder .lesson-description:focus {
            background: rgba(226, 183, 20, 0.1);
        }

        .lesson-card-placeholder .lesson-title:empty:before,
        .lesson-card-placeholder .lesson-description:empty:before {
            content: attr(data-placeholder);
            color: #a0a0a0;
        }

        .difficulty-cycle-badge {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .difficulty-cycle-badge:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .difficulty-cycle-badge:active {
            transform: scale(0.95);
        }

        .create-course-inline-btn {
            width: 100%;
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #e2b714 0%, #d1a513 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .create-course-inline-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(226, 183, 20, 0.3);
        }

        .lesson-card-number {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e8e8e8;
            color: #525252;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
        }

        body.dark-mode .lesson-number {
            background: #2a2d32;
            color: #888;
        }

        .lesson-card.active .lesson-number {
            background: #e2b714;
            color: #78350f;
        }

        .lesson-card.completed .lesson-number {
            background: #10b981;
            color: white;
        }

        .lesson-card.completed .lesson-number::before {
            content: 'âœ“';
        }

        .lesson-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .lesson-title {
            font-size: 1.15em;
            font-weight: 700;
            color: #1a1a1a;
            flex: 1;
        }

        body.dark-mode .lesson-title {
            color: #e8e8e8;
        }

        .lesson-description {
            font-size: 0.88em;
            color: #737373;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        body.dark-mode .lesson-description {
            color: #888;
        }

        .lesson-keys-count {
            font-size: 0.75em;
            color: #525252;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        body.dark-mode .lesson-keys-count {
            color: #888;
        }

        .lesson-keys {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.8em;
            color: #525252;
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 14px;
            line-height: 1.6;
            word-spacing: 2px;
        }

        body.dark-mode .lesson-keys {
            background: #0f1012;
            color: #a0a0a0;
        }

        .lesson-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .lesson-stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: #525252;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
        }

        body.dark-mode .lesson-stat-item {
            background: #0f1012;
            color: #a0a0a0;
        }

        .stat-icon {
            font-size: 1.1em;
            line-height: 1;
        }

        .stat-text {
            font-weight: 600;
        }

        .lesson-new-badge {
            font-size: 0.85em;
            color: #e2b714;
            font-weight: 600;
            padding: 8px 0;
            text-align: center;
        }

        body.dark-mode .lesson-new-badge {
            color: #fde68a;
        }

        .lesson-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 8px;
        }

        .lesson-badge.in-progress {
            background: #fef3c7;
            color: #78350f;
        }

        .lesson-badge.completed {
            background: #d1fae5;
            color: #064e3b;
        }

        body.dark-mode .lesson-badge.completed {
            background: #065f46;
            color: #d1fae5;
        }

        .lesson-badge.locked {
            background: #e8e8e8;
            color: #737373;
        }

        body.dark-mode .lesson-badge.locked {
            background: #2a2d32;
            color: #888;
        }

        .lesson-badge.difficulty-beginner {
            background: #d1fae5;
            color: #064e3b;
        }

        body.dark-mode .lesson-badge.difficulty-beginner {
            background: #065f46;
            color: #d1fae5;
        }

        .lesson-badge.difficulty-intermediate {
            background: #fef3c7;
            color: #78350f;
        }

        body.dark-mode .lesson-badge.difficulty-intermediate {
            background: #3a2f1a;
            color: #fde68a;
        }

        .lesson-badge.difficulty-advanced {
            background: #fecaca;
            color: #7f1d1d;
        }

        body.dark-mode .lesson-badge.difficulty-advanced {
            background: #7f1d1d;
            color: #fecaca;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            /* Fix main layout for mobile */
            .main-layout {
                display: block;
            }

            .lessons-sidebar {
                position: fixed;
                width: 85%;
                max-width: 320px;
                min-width: 0;
                left: 0;
                top: 0;
                z-index: 1000;
                transform: translateX(-100%);
                margin-left: 0;
            }

            .lessons-sidebar.open {
                transform: translateX(0);
                margin-left: 0;
            }

            /* Container takes full width on mobile */
            .container {
                width: 100%;
                max-width: 100%;
            }

            /* Add backdrop when sidebar is open on mobile */
            .lessons-sidebar.open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }

            .lessons-toggle {
                width: 40px;
                height: 40px;
                top: 12px;
                left: 12px;
            }

            .active-course-title {
                top: 12px;
                left: 60px;
                height: 40px;
                font-size: 13px;
                padding: 0 12px;
            }

            .lessons-toggle .toggle-text {
                font-size: 0.65em;
            }

            .lesson-card {
                padding: 16px;
            }

            .lessons-sidebar-header {
                padding: 20px;
            }

            .lessons-sidebar-content {
                padding: 16px;
            }

            /* Hide finger visualization on small screens */
            .finger-groups {
                display: none;
            }

            /* Make keyboard smaller */
            .keyboard {
                transform: scale(0.7);
                transform-origin: top center;
                margin-bottom: -60px;
            }

            /* Reduce header size */
            h1 {
                font-size: 2em !important;
                margin-bottom: 8px !important;
            }

            .subtitle {
                font-size: 0.9em !important;
                margin-bottom: 16px !important;
            }

            /* Compact stats */
            .stats-container {
                gap: 8px !important;
                margin-bottom: 12px !important;
            }

            .stat-box {
                padding: 8px 12px !important;
                min-width: 70px !important;
            }

            .stat-label {
                font-size: 0.65em !important;
            }

            .stat-value {
                font-size: 1.2em !important;
            }

            /* Selected keys compact */
            #selectedKeysList {
                font-size: 0.75em !important;
                padding: 8px !important;
            }

            /* Smaller buttons */
            .top-right-buttons {
                gap: 8px !important;
            }

            .stats-btn, .settings-btn {
                width: 40px !important;
                height: 40px !important;
                top: 12px !important;
            }

            /* Target text smaller */
            .target-text {
                font-size: 1.8em !important;
                max-height: 15em !important;
            }

            /* Input smaller */
            #typingInput {
                font-size: 1.2em !important;
                padding: 8px 12px !important;
            }

            /* Progress bar thinner */
            .progress-bar-container {
                height: 3px !important;
            }

            /* Container padding */
            .container {
                padding: 12px !important;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .keyboard {
                transform: scale(0.5);
                margin-bottom: -100px;
            }

            h1 {
                font-size: 1.5em !important;
            }

            .target-text {
                font-size: 1.5em !important;
            }

            .stat-box {
                min-width: 60px !important;
                padding: 6px 8px !important;
            }
        }

        .practice-area {
            margin-top: 48px;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .practice-area h2 {
            color: #737373;
            margin-bottom: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.7;
        }

        .target-text {
            font-size: 2.8em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            margin-bottom: 24px;
            transition: font-size 0.2s ease;
            padding: 0;
            padding-left: 2px;
            padding-right: 8px;
            background: transparent;
            border-radius: 0;
            line-height: 1.75;
            max-height: 25.2em;
            overflow-y: auto;
            overflow-x: hidden;
            letter-spacing: 0.01em;
            word-break: break-word;
            white-space: pre-wrap;
            text-align: left;
            color: #262626;
            font-weight: 400;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.08) transparent;
        }

        .target-text::-webkit-scrollbar {
            width: 6px;
        }

        .target-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .target-text::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .target-text::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .target-text.font-small {
            font-size: 1.8em;
        }

        .target-text.font-medium {
            font-size: 2.2em;
        }

        .target-text.font-large {
            font-size: 2.6em;
        }

        .target-text.font-xlarge {
            font-size: 3.0em;
        }

        .target-text span {
            transition: all 0.15s ease;
        }

        .target-text .correct {
            color: #2d3748;
            font-weight: 400;
            opacity: 1;
        }

        .target-text .error {
            color: #ef4444;
            font-weight: 400;
            background: #fef2f2;
            padding: 0 2px;
            border-radius: 2px;
        }

        .target-text .current {
            background: transparent;
            color: #a0aec0;
            font-weight: 400;
            opacity: 0.7;
            border-left: 3px solid #2d3748;
            padding-left: 2px;
            margin-left: -3px;
            border-radius: 0;
            animation: blink-cursor 1.2s ease-in-out infinite;
        }

        .target-text .upcoming {
            color: #a0aec0;
            font-weight: 400;
            opacity: 0.7;
        }

        /* Space character styling */
        .target-text .space-char {
            opacity: 0.4;
            font-size: 0.9em;
        }

        /* Word wrapper to prevent mid-word breaks */
        .word-wrapper {
            display: inline-block;
        }

        /* Error typed character display */
        .error-typed {
            position: absolute;
            top: -0.7em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            color: #ca4754;
            font-weight: 600;
            opacity: 0.9;
            text-decoration: line-through;
        }

        .target-text .incorrect {
            position: relative;
        }

        @keyframes blink-cursor {
            0%, 49% { border-left-color: #2d3748; }
            50%, 100% { border-left-color: transparent; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .practice-area {
            cursor: text;
        }

        .input-area {
            position: relative;
        }

        .typing-input {
            position: fixed;
            top: -100px;
            left: -100px;
            opacity: 0;
            pointer-events: none;
            width: 1px;
            height: 1px;
            border: none;
            padding: 0;
        }

        .typing-input:focus {
            outline: none;
        }

        .stats {
            display: flex;
            gap: 32px;
            margin-bottom: 32px;
            padding: 0;
            border: none;
            flex-wrap: wrap;
            align-items: center;
            opacity: 0.8;
        }

        .stat-box {
            padding: 0;
            background: transparent;
            border-radius: 0;
            text-align: left;
            box-shadow: none;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .stat-label {
            color: #737373;
            font-size: 0.75em;
            margin-bottom: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .stat-value {
            color: #262626;
            font-size: 1em;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .practice-header h2 {
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin: 0;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .button-group:hover {
            opacity: 1;
        }

        .btn-generate, .btn-restart {
            padding: 8px 16px;
            background: white;
            color: #525252;
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-restart {
            color: #737373;
        }

        .btn-generate:hover {
            background: #f8f8f8;
            border-color: #d4d4d4;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .btn-restart:hover {
            background: #f8f8f8;
            border-color: #d4d4d4;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .btn-generate:disabled, .btn-restart:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .settings-container {
            position: relative;
        }

        .instructions {
            text-align: left;
            color: #cbd5e0;
            margin-top: 12px;
            font-style: normal;
            font-size: 0.7em;
        }

        .shortcuts {
            text-align: left;
            margin-top: 6px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            font-size: 0.7em;
            color: #cbd5e0;
        }

        .shortcuts strong {
            color: #a0aec0;
            font-weight: 500;
        }

        .shortcut-key {
            display: inline-block;
            padding: 2px 4px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 2px;
            font-family: monospace;
            font-weight: normal;
            margin: 0 1px;
            box-shadow: none;
            font-size: 0.85em;
        }

        .settings-panel {
            margin-bottom: 12px;
            padding: 15px 20px;
            background: #e8e8e8;
            border-radius: 8px;
        }

        .settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item.full-width {
            flex-basis: 100%;
            width: 100%;
        }

        .setting-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Compact Mode Toggle */
        .mode-toggle {
            display: flex;
            background: transparent;
            border-radius: 6px;
            padding: 0;
            gap: 6px;
        }

        .mode-toggle input[type="radio"] {
            display: none;
        }

        .mode-toggle label {
            padding: 6px 14px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
            transition: all 0.2s;
            color: #4b5563;
            user-select: none;
            background: white;
            border: 1px solid #d0d0d0;
        }

        .mode-toggle input[type="radio"]:checked + label {
            background: #fffbeb;
            color: #92400e;
            border-color: #e2b714;
            box-shadow: 0 1px 3px rgba(226, 183, 20, 0.1);
        }

        .mode-toggle input[type="radio"]:checked + label:hover {
            background: #fef9c3;
            color: #78350f;
            border-color: #d1a513;
        }

        /* Compact Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider {
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2d3748;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2d3748;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.85em;
        }

        /* Compact Radio Buttons */
        .radio-group {
            display: flex;
            gap: 6px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 6px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            color: #6c757d;
            transition: all 0.2s;
            user-select: none;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #fffbeb;
            color: #92400e;
            border-color: #e2b714;
            box-shadow: 0 1px 3px rgba(226, 183, 20, 0.1);
        }

        .radio-option input[type="radio"]:checked + label:hover {
            background: #fef9c3;
            color: #78350f;
            border-color: #d1a513;
        }

        /* Compact Toggle Switch */
        .toggle-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e8e8e8;
            border: none;
            transition: background 0.3s;
            border-radius: 11px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: transform 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #e2b714;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
        }

        .progress-bar-container {
            width: 100%;
            height: 2px;
            background: #e9ecef;
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: #2d3748;
            transition: width 0.3s ease;
            border-radius: 0;
        }

        .timer-display {
            font-size: 0.9em;
            font-weight: 500;
            color: #6c757d;
            text-align: left;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .timer-display.warning {
            color: #f39c12;
            animation: none;
        }

        .timer-display.danger {
            color: #e74c3c;
            animation: none;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Focus Mode */
        body.focus-mode h1,
        body.focus-mode .subtitle,
        body.focus-mode .settings-panel,
        body.focus-mode .finger-selector,
        body.focus-mode .keyboard,
        body.focus-mode .selected-keys {
            display: none;
        }

        body.focus-mode .container {
            padding: 20px;
        }

        body.focus-mode .practice-area {
            margin-top: 0;
            padding: 60px 0;
        }

        body.focus-mode .practice-area h2 {
            display: none;
        }

        body.focus-mode .stats {
            margin-bottom: 40px;
        }

        .focus-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 24px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            z-index: 1000;
        }

        .focus-toggle:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.02);
        }

        .focus-toggle:active {
            transform: translateY(0) scale(1);
        }

        body.focus-mode .focus-toggle {
            background: #e8e8e8;
        }

        body.focus-mode .focus-toggle:hover {
            background: #f5f5f5;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 18px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 24px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            z-index: 1000;
        }

        .dark-mode-toggle:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.02);
        }

        .dark-mode-toggle:active {
            transform: translateY(0) scale(1);
        }

        body.dark-mode .focus-toggle {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .focus-toggle:hover {
            background: #3a3c3f;
        }

        body.dark-mode.focus-mode .focus-toggle {
            background: #3a3c3f;
            color: #d1d0c5;
        }

        body.dark-mode.focus-mode .focus-toggle:hover {
            background: #4a4c4f;
        }

        body.dark-mode .dark-mode-toggle {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: #3a3c3f;
        }

        /* Settings Dropdown */
        .settings-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .settings-btn {
            padding: 10px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.05);
        }

        .settings-btn:active {
            transform: translateY(0) scale(1);
        }

        .settings-menu {
            position: absolute;
            top: 54px;
            right: 0;
            background: white;
            border-radius: 16px;
            padding: 20px;
            min-width: 320px;
            max-width: 400px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-8px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid #e8e8e8;
        }

        .settings-menu.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .settings-menu-item {
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.15s ease;
        }

        .settings-menu-item:hover {
            background: #fafafa;
        }

        .settings-menu-divider {
            height: 1px;
            background: #e5e5e5;
            margin: 12px 0;
        }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            color: #dc2626;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .reset-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }

        .reset-btn svg {
            flex-shrink: 0;
        }

        /* Settings header */
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .settings-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: #262626;
        }

        .save-btn-dropdown {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #e2b714;
            color: #78350f;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .save-btn-dropdown.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .save-btn-dropdown:hover {
            background: #d1a513;
            color: #451a03;
            transform: translateY(-1px);
        }

        .save-btn-dropdown:active {
            transform: translateY(0);
        }

        .save-btn-dropdown svg {
            flex-shrink: 0;
        }

        /* Settings sections and items */
        .settings-section {
            margin-bottom: 8px;
        }

        .setting-item-dropdown {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            gap: 12px;
        }

        .setting-label-dropdown {
            font-size: 13px;
            font-weight: 500;
            min-width: 90px;
            flex-shrink: 0;
        }

        .toggle-switch-small {
            position: relative;
            width: 42px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle-switch-small input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-small {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0e0e0;
            border: none;
            transition: background 0.3s;
            border-radius: 11px;
        }

        .toggle-slider-small::before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: transform 0.3s;
            border-radius: 50%;
        }

        .toggle-switch-small input:checked + .toggle-slider-small {
            background: #e2b714;
        }

        .toggle-switch-small input:checked + .toggle-slider-small::before {
            transform: translateX(20px);
        }

        .sound-cycle-btn {
            padding: 6px 16px;
            background: rgba(226, 183, 20, 0.1);
            border: 1px solid rgba(226, 183, 20, 0.3);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #d4a017;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .sound-cycle-btn:hover {
            background: rgba(226, 183, 20, 0.15);
            border-color: rgba(226, 183, 20, 0.4);
            transform: scale(1.02);
        }

        .sound-cycle-btn:active {
            transform: scale(0.98);
        }

        body.dark-mode .sound-cycle-btn {
            background: rgba(226, 183, 20, 0.15);
            border-color: rgba(226, 183, 20, 0.4);
        }

        body.dark-mode .sound-cycle-btn:hover {
            background: rgba(226, 183, 20, 0.2);
            border-color: rgba(226, 183, 20, 0.5);
        }

        .settings-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .settings-switch input[type="checkbox"] {
            display: none;
        }

        .settings-slider {
            position: relative;
            width: 40px;
            height: 22px;
            background: #e0e0e0;
            border-radius: 11px;
            transition: background 0.3s;
        }

        .settings-slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .settings-switch input[type="checkbox"]:checked + .settings-slider {
            background: #e2b714;
        }

        .settings-switch input[type="checkbox"]:checked + .settings-slider::after {
            transform: translateX(18px);
        }

        .settings-label {
            font-size: 0.9em;
            font-weight: 500;
            color: #2d3748;
        }

        /* Dark mode styles */
        body.dark-mode .settings-btn {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .settings-btn:hover {
            background: #3a3c3f;
        }

        body.dark-mode .settings-menu {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .settings-menu-item:hover {
            background: #2a2a2a;
        }

        body.dark-mode .settings-menu-divider {
            background: #404040;
        }

        body.dark-mode .reset-btn {
            color: #f87171;
        }

        body.dark-mode .reset-btn:hover {
            background: #3a1f1f;
            color: #fca5a5;
        }

        body.dark-mode .settings-header {
            border-bottom-color: #404040;
        }

        body.dark-mode .settings-header h3 {
            color: #fafafa;
        }

        body.dark-mode .save-btn-dropdown {
            background: #e2b714;
            color: #78350f;
        }

        body.dark-mode .save-btn-dropdown:hover {
            background: #d1a513;
            color: #451a03;
        }

        body.dark-mode .setting-label-dropdown {
            color: #d1d0c5;
        }

        body.dark-mode .toggle-slider-small {
            background: #646669;
        }

        body.dark-mode .toggle-switch-small input:checked + .toggle-slider-small {
            background: #e2b714;
        }

        body.dark-mode .settings-slider {
            background: #646669;
        }

        body.dark-mode .settings-slider::after {
            background: #d1d0c5;
        }

        body.dark-mode .settings-label {
            color: #d1d0c5;
        }

        .focus-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.05);
            color: #a0aec0;
            border-radius: 4px;
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        body.focus-mode .focus-hint {
            opacity: 1;
        }

        .focus-hint.hidden {
            opacity: 0 !important;
        }

        .focus-hint kbd {
            display: inline-block;
            padding: 2px 6px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 0 2px;
        }

        /* Completion Tooltip */
        .completion-tooltip {
            position: fixed;
            padding: 24px 32px;
            background: white;
            border: 3px solid #e2b714;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            opacity: 0;
            transform: translateX(-50%) translateY(-50%) translateY(20px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 10000;
            box-shadow: 0 16px 48px rgba(226, 183, 20, 0.2), 0 8px 16px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            min-width: 280px;
        }

        .completion-tooltip.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1);
        }

        .completion-tooltip .stats-line {
            margin: 4px 0;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .completion-tooltip .stat-label {
            color: #718096;
            font-size: 13px;
        }

        .completion-tooltip .stat-value {
            color: #e2b714;
            font-weight: 600;
            font-size: 15px;
        }

        body.dark-mode .completion-tooltip {
            background: #2d3748;
            color: #d1d0c5;
            border-color: #e2b714;
        }

        body.dark-mode .completion-tooltip .stat-label {
            color: #9ca3af;
        }

        /* Typing Overlay */
        .typing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }

        .typing-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .overlay-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
        }

        .overlay-content svg {
            color: #666;
        }

        .typing-area {
            position: relative;
        }

        /* Stats Button */
        .stats-btn {
            padding: 10px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
        }

        .stats-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.05);
        }

        .stats-btn:active {
            transform: translateY(0) scale(1);
        }

        body.dark-mode .stats-btn {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .stats-btn:hover {
            background: #3a3c3f;
        }

        /* Stats Modal */
        .stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .stats-modal.show {
            display: flex;
        }

        .stats-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .stats-content {
            background: #2c2e31;
            color: #d1d0c5;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e8e8e8;
        }

        body.dark-mode .stats-header {
            border-bottom-color: #3a3c3f;
        }

        .stats-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .stats-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .stats-close:hover {
            background: #f5f5f5;
            color: #666;
        }

        body.dark-mode .stats-close:hover {
            background: #3a3c3f;
            color: #d1d0c5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #f8f8f8;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        body.dark-mode .stat-card {
            background: #1e2023;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        body.dark-mode .stat-value {
            color: #d1d0c5;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .stat-label {
            color: #888;
        }

        .stats-section {
            margin-bottom: 32px;
        }

        .stats-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2d3748;
        }

        body.dark-mode .stats-section h3 {
            color: #d1d0c5;
        }

        /* Streaks Section */
        .streaks-section {
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #e2b714;
        }

        body.dark-mode .streaks-section {
            background: linear-gradient(135deg, #2a2415 0%, #3a3020 100%);
            border-color: #d1a513;
        }

        .streaks-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .streaks-header h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #92400e;
        }

        body.dark-mode .streaks-header h3 {
            color: #d1a513;
        }

        .streaks-subtitle {
            margin: 0;
            font-size: 14px;
            color: #78350f;
            opacity: 0.8;
        }

        body.dark-mode .streaks-subtitle {
            color: #d1a513;
        }

        .streaks-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .streak-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(226, 183, 20, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .streak-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(226, 183, 20, 0.25);
        }

        body.dark-mode .streak-card {
            background: #1e2023;
            box-shadow: 0 2px 8px rgba(209, 165, 19, 0.2);
        }

        body.dark-mode .streak-card:hover {
            box-shadow: 0 4px 12px rgba(209, 165, 19, 0.3);
        }

        .streak-icon {
            font-size: 48px;
            margin-bottom: 8px;
            display: block;
        }

        .streak-value {
            font-size: 36px;
            font-weight: 700;
            color: #d97706;
            margin-bottom: 4px;
        }

        body.dark-mode .streak-value {
            color: #e2b714;
        }

        .streak-label {
            font-size: 14px;
            color: #78350f;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .streak-label {
            color: #92400e;
        }

        .streak-message {
            margin-top: 12px;
            font-size: 13px;
            color: #92400e;
            font-style: italic;
        }

        body.dark-mode .streak-message {
            color: #a16207;
        }

        .error-keys-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .error-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        body.dark-mode .error-key-item {
            background: #1e2023;
        }

        .error-key-name {
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: 600;
            font-size: 18px;
            color: #e2b714;
        }

        .error-key-count {
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        body.dark-mode .error-key-count {
            color: #888;
        }

        .insight-card {
            background: #fffbeb;
            border-left: 4px solid #e2b714;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        body.dark-mode .insight-card {
            background: #2a2415;
            border-left-color: #e2b714;
        }

        .insight-card p {
            margin: 0;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }

        body.dark-mode .insight-card p {
            color: #d1a513;
        }

        /* Keyboard Heatmap */
        .heatmap-subtitle {
            text-align: center;
            color: #737373;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        body.dark-mode .heatmap-subtitle {
            color: #888;
        }

        .heatmap-keyboard {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 24px;
            background: #f8f8f8;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        body.dark-mode .heatmap-keyboard {
            background: #1e2023;
        }

        .heatmap-row {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .heatmap-key {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e8e8e8;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            color: #404040;
            transition: all 0.3s ease;
            position: relative;
        }

        body.dark-mode .heatmap-key {
            background: #2a2d32;
            border-color: #3a3d42;
            color: #a0a0a0;
        }

        .heatmap-key.heatmap-space {
            width: 200px;
        }

        .heatmap-key[data-error-level="1"] {
            background: #fef3c7;
            border-color: #fde68a;
            color: #78350f;
        }

        .heatmap-key[data-error-level="2"] {
            background: #fde68a;
            border-color: #fcd34d;
            color: #78350f;
        }

        .heatmap-key[data-error-level="3"] {
            background: #fbbf24;
            border-color: #f59e0b;
            color: #78350f;
        }

        .heatmap-key[data-error-level="4"] {
            background: #fb923c;
            border-color: #f97316;
            color: #7c2d12;
        }

        .heatmap-key[data-error-level="5"] {
            background: #f87171;
            border-color: #ef4444;
            color: #7f1d1d;
        }

        .heatmap-key[data-error-level="6"] {
            background: #ef4444;
            border-color: #dc2626;
            color: white;
        }

        .heatmap-key[data-error-level="7"] {
            background: #dc2626;
            border-color: #b91c1c;
            color: white;
            font-weight: 700;
        }

        /* Dark mode error levels */
        body.dark-mode .heatmap-key[data-error-level="1"] {
            background: #fef3c7;
            border-color: #fde68a;
            color: #78350f;
        }

        body.dark-mode .heatmap-key[data-error-level="2"] {
            background: #fde68a;
            border-color: #fcd34d;
            color: #78350f;
        }

        body.dark-mode .heatmap-key[data-error-level="3"] {
            background: #fbbf24;
            border-color: #f59e0b;
            color: #78350f;
        }

        body.dark-mode .heatmap-key[data-error-level="4"] {
            background: #fb923c;
            border-color: #f97316;
            color: #7c2d12;
        }

        body.dark-mode .heatmap-key[data-error-level="5"] {
            background: #f87171;
            border-color: #ef4444;
            color: #7f1d1d;
        }

        body.dark-mode .heatmap-key[data-error-level="6"] {
            background: #ef4444;
            border-color: #dc2626;
            color: white;
        }

        body.dark-mode .heatmap-key[data-error-level="7"] {
            background: #dc2626;
            border-color: #b91c1c;
            color: white;
            font-weight: 700;
        }

        .heatmap-key::after {
            content: attr(data-error-count);
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: 0.65em;
            font-weight: 700;
            opacity: 0.7;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
        }

        .legend-label {
            font-size: 0.85em;
            color: #737373;
        }

        body.dark-mode .legend-label {
            color: #888;
        }

        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, #e8e8e8, #fde68a, #fbbf24, #fb923c, #f87171, #ef4444, #dc2626);
            border-radius: 10px;
            border: 1px solid #d0d0d0;
        }

        body.dark-mode .legend-gradient {
            background: linear-gradient(to right, #2a2d32, #fde68a, #fbbf24, #fb923c, #f87171, #ef4444, #dc2626);
            border-color: #3a3d42;
        }

        .reset-stats-btn {
            width: 100%;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
        }

        .reset-stats-btn:hover {
            background: #dc2626;
        }

        /* Custom Modal */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .custom-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 440px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: modalFadeIn 0.3s ease;
            overflow: hidden;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-body {
            color: #2d3748;
            font-size: 1em;
            line-height: 1.6;
            padding: 32px;
            text-align: center;
        }

        .modal-header {
            background: linear-gradient(135deg, #e2b714 0%, #d1a513 100%);
            padding: 24px 32px;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: white;
            margin: 0 0 8px 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .modal-subtitle {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 24px 0;
        }

        .modal-info-item {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 16px;
        }

        body.dark-mode .modal-info-item {
            background: #1e2023;
        }

        .modal-info-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #737373;
            font-weight: 600;
            margin-bottom: 6px;
        }

        body.dark-mode .modal-info-label {
            color: #888;
        }

        .modal-info-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a1a1a;
        }

        body.dark-mode .modal-info-value {
            color: #e8e8e8;
        }

        .modal-message {
            font-size: 0.95em;
            color: #525252;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e8e8e8;
        }

        body.dark-mode .modal-message {
            color: #a0a0a0;
            border-top-color: #2a2d32;
        }

        .modal-btn {
            width: calc(100% - 64px);
            margin: 0 32px 32px 32px;
            padding: 14px 24px;
            background: #e2b714;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }

        .modal-btn:hover {
            background: #d1a513;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(226, 183, 20, 0.3);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
            color: #e5e5e5;
        }

        body.dark-mode h1 {
            color: #fafafa;
        }

        body.dark-mode .subtitle {
            color: #a3a3a3;
        }

        body.dark-mode .settings-panel {
            background: #262626;
            border: 1px solid #404040;
        }

        body.dark-mode .finger-selector {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .setting-label {
            color: #a3a3a3;
        }

        body.dark-mode .hand-label {
            color: #a3a3a3;
        }

        body.dark-mode .mode-toggle label {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
        }

        body.dark-mode .mode-toggle label:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .mode-toggle input:checked + label {
            background: #2a2a2a;
            color: #fbbf24;
            border-color: #e2b714;
        }

        body.dark-mode .mode-toggle input:checked + label:hover {
            background: #333333;
            color: #fcd34d;
            border-color: #e2b714;
        }

        body.dark-mode .radio-option label {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
        }

        body.dark-mode .radio-option label:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .radio-option input:checked + label {
            background: #e2b714;
            color: white;
            border-color: #e2b714;
        }

        body.dark-mode .radio-option input:checked + label:hover {
            background: #f0c520;
            border-color: #f0c520;
        }

        body.dark-mode .toggle-slider {
            background-color: #525252;
        }

        body.dark-mode .toggle-slider:before {
            background-color: #e5e5e5;
        }

        body.dark-mode input:checked + .toggle-slider {
            background-color: #e2b714;
        }

        body.dark-mode input:checked + .toggle-slider:before {
            background-color: white;
        }

        body.dark-mode .slider {
            background: #2c2e31;
        }

        body.dark-mode .slider::-webkit-slider-thumb {
            background: #e2b714;
        }

        body.dark-mode .slider::-moz-range-thumb {
            background: #e2b714;
        }

        body.dark-mode .slider-value {
            color: #d1d0c5;
            background: #2c2e31;
            border-color: #646669;
        }

        body.dark-mode .finger-btn {
            background: #2c2e31;
            color: #646669;
            border-color: #646669;
        }

        body.dark-mode .finger-btn:hover {
            background: #646669;
            border-color: #646669;
            color: #d1d0c5;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .finger-btn.active {
            color: white;
        }

        body.dark-mode .finger-btn.active:hover {
            transform: translateY(-1px);
        }

        body.dark-mode .selected-keys {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .selected-keys strong {
            color: #fafafa;
        }

        body.dark-mode .selected-keys-list {
            color: #a3a3a3;
        }

        body.dark-mode .key-chip {
            background: #333333;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .keyboard {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .key {
            background: #333333;
            color: #a3a3a3;
            border-color: #525252;
        }

        body.dark-mode .key:hover {
            background: #3a3a3a;
            color: #e5e5e5;
            border-color: #737373;
            transform: translateY(-1px);
        }

        body.dark-mode .key.selected[data-finger]:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        body.dark-mode .key.selected[data-finger="left-pinky"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        body.dark-mode .key.selected[data-finger="left-ring"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        body.dark-mode .key.selected[data-finger="left-middle"]:hover {
            background: #60a5fa;
            border-color: #93c5fd;
        }

        body.dark-mode .key.selected[data-finger="left-index"]:hover {
            background: #34d399;
            border-color: #6ee7b7;
        }

        body.dark-mode .key.selected[data-finger="right-index"]:hover {
            background: #fbbf24;
            border-color: #fcd34d;
        }

        body.dark-mode .key.selected[data-finger="right-middle"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        body.dark-mode .key.selected[data-finger="right-ring"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        body.dark-mode .key.selected[data-finger="right-pinky"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        body.dark-mode .key.disabled {
            background: #2c2e31;
            color: #3a3a3d;
        }

        body.dark-mode .key.disabled:hover {
            transform: none;
        }

        body.dark-mode .typing-area {
            background: #2c2e31;
            border: none;
        }

        body.dark-mode .progress-bar-container {
            background: #2c2e31;
        }

        body.dark-mode .progress-bar {
            background: #646669;
        }

        body.dark-mode .target-text {
            color: #737373;
        }

        body.dark-mode .target-text .correct {
            color: #e5e5e5;
        }

        body.dark-mode .target-text .incorrect {
            color: #f87171;
            background: rgba(248, 113, 113, 0.15);
        }

        body.dark-mode .target-text .upcoming {
            color: #737373;
            opacity: 1;
        }

        body.dark-mode .target-text .current {
            color: #737373;
            opacity: 1;
            background: transparent;
            font-weight: 400;
            border-left-color: #e2b714;
            animation: blink-cursor-dark 1.2s ease-in-out infinite;
        }

        @keyframes blink-cursor-dark {
            0%, 49% { border-left-color: #e2b714; }
            50%, 100% { border-left-color: transparent; }
        }

        body.dark-mode .typing-input {
            background: #2c2e31;
            color: #d1d0c5;
            border: none;
        }

        body.dark-mode .stats {
            background: transparent;
            border: none;
        }

        body.dark-mode .stats h3 {
            color: #d1d0c5;
        }

        body.dark-mode .stat-item {
            color: #a3a3a3;
        }

        body.dark-mode .stat-value {
            color: #fafafa;
        }

        body.dark-mode .stat-label {
            color: #a3a3a3;
        }

        body.dark-mode .restart-btn {
            background: #e2b714;
            color: white;
            border-color: #e2b714;
        }

        body.dark-mode .restart-btn:hover {
            background: #c29a12;
            border-color: #c29a12;
        }

        body.dark-mode .btn-generate,
        body.dark-mode .btn-restart {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
            box-shadow: none;
        }

        body.dark-mode .btn-generate:hover,
        body.dark-mode .btn-restart:hover {
            background: #2a2a2a;
            border-color: #525252;
            color: #e5e5e5;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .btn-generate:disabled,
        body.dark-mode .btn-restart:disabled {
            opacity: 0.3;
            color: #3a3a3d;
        }

        body.dark-mode .instructions {
            color: #646669;
        }

        body.dark-mode .shortcuts {
            color: #646669;
        }

        body.dark-mode .shortcuts strong {
            color: #646669;
        }

        body.dark-mode .shortcut-key {
            background: #2c2e31;
            border-color: #646669;
            color: #d1d0c5;
        }

        body.dark-mode .focus-hint {
            background: rgba(0, 0, 0, 0.5);
            color: #646669;
        }

        body.dark-mode .focus-hint kbd {
            background: #2c2e31;
            border-color: #646669;
            color: #d1d0c5;
        }

        body.dark-mode .typing-overlay {
            background: rgba(50, 52, 55, 0.8);
            backdrop-filter: blur(8px);
        }

        body.dark-mode .overlay-content {
            color: #d1d0c5;
        }

        body.dark-mode .overlay-content svg {
            color: #d1d0c5;
        }

        body.dark-mode .modal-content {
            background: #2c2e31;
        }

        body.dark-mode .modal-body {
            color: #d1d0c5;
        }

        body.dark-mode .key.home-row::after {
            background: #646669;
        }

        body.dark-mode .key.home-row.selected::after {
            background: #d1d0c5;
        }
    </style>
</head>
<body>
    <!-- Stats Button -->
    <button class="stats-btn" id="statsBtn" title="View Statistics">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
    </button>

    <!-- Settings Dropdown -->
    <div class="settings-dropdown">
        <button class="settings-btn" id="settingsBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="save-btn-dropdown" id="saveSettingsBtn" title="Save Settings">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>

            <!-- App Settings -->
            <div class="settings-section">
                <div class="settings-menu-item">
                    <label class="settings-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="settings-slider"></span>
                        <span class="settings-label">Dark Mode</span>
                    </label>
                </div>
                <div class="settings-menu-item">
                    <label class="settings-switch">
                        <input type="checkbox" id="focusToggle">
                        <span class="settings-slider"></span>
                        <span class="settings-label">Focus Mode</span>
                    </label>
                </div>
                <div class="settings-menu-item">
                    <label class="settings-switch">
                        <input type="checkbox" id="soundFeedbackToggle" checked>
                        <span class="settings-slider"></span>
                        <span class="settings-label">Sound Feedback</span>
                    </label>
                </div>

                <!-- Sound Type -->
                <div class="setting-item-dropdown" style="margin-top: 12px;">
                    <span class="setting-label-dropdown">Sound:</span>
                    <button id="soundTypeCycle" class="sound-cycle-btn" onclick="cycleSoundType()">Classic</button>
                </div>
            </div>

            <div class="settings-menu-divider"></div>

            <!-- Practice Settings -->
            <div class="settings-section">
                <h4 style="margin: 8px 0; font-size: 13px; font-weight: 600; opacity: 0.7;">Practice Settings</h4>

                <!-- Mode -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Mode:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="modeWords" name="mode" value="words">
                        <label for="modeWords">Words</label>
                        <input type="radio" id="modeTimed" name="mode" value="timed">
                        <label for="modeTimed">Time</label>
                        <input type="radio" id="modeUnlimited" name="mode" value="unlimited" checked>
                        <label for="modeUnlimited">Infinited</label>
                    </div>
                </div>

                <!-- Word Count -->
                <div class="setting-item-dropdown" id="wordCountSetting" style="display: none;">
                    <span class="setting-label-dropdown">Words:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordCount10" name="wordCount" value="10" checked>
                        <label for="wordCount10">10</label>
                        <input type="radio" id="wordCount25" name="wordCount" value="25">
                        <label for="wordCount25">25</label>
                        <input type="radio" id="wordCount50" name="wordCount" value="50">
                        <label for="wordCount50">50</label>
                        <input type="radio" id="wordCount100" name="wordCount" value="100">
                        <label for="wordCount100">100</label>
                    </div>
                </div>

                <!-- Time Limit -->
                <div class="setting-item-dropdown" id="timeLimitSetting" style="display: none;">
                    <span class="setting-label-dropdown">Time:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="time15" name="timeLimit" value="15">
                        <label for="time15">15</label>
                        <input type="radio" id="time30" name="timeLimit" value="30" checked>
                        <label for="time30">30</label>
                        <input type="radio" id="time60" name="timeLimit" value="60">
                        <label for="time60">60</label>
                        <input type="radio" id="time120" name="timeLimit" value="120">
                        <label for="time120">120</label>
                    </div>
                </div>

                <!-- Word Set -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Words:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordSetGibberish" name="wordSet" value="gibberish">
                        <label for="wordSetGibberish">Gibberish</label>
                        <input type="radio" id="wordSetReal" name="wordSet" value="real" checked>
                        <label for="wordSetReal">Real</label>
                    </div>
                </div>

                <!-- Error Mode -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Error Mode:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="errorModeBlock" name="errorMode" value="block" checked>
                        <label for="errorModeBlock">Block</label>
                        <input type="radio" id="errorModeBackspace" name="errorMode" value="backspace">
                        <label for="errorModeBackspace">Continue</label>
                    </div>
                </div>

                <!-- Word Bank -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Word Bank:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordBank1k" name="wordBank" value="1k">
                        <label for="wordBank1k">1K</label>
                        <input type="radio" id="wordBank10k" name="wordBank" value="10k" checked>
                        <label for="wordBank10k">10K</label>
                        <input type="radio" id="wordBank25k" name="wordBank" value="25k">
                        <label for="wordBank25k">25K</label>
                        <input type="radio" id="wordBank450k" name="wordBank" value="450k">
                        <label for="wordBank450k">450K</label>
                    </div>
                </div>

                <!-- Font Size -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Font Size:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="fontSizeSmall" name="fontSize" value="small">
                        <label for="fontSizeSmall">S</label>
                        <input type="radio" id="fontSizeMedium" name="fontSize" value="medium" checked>
                        <label for="fontSizeMedium">M</label>
                        <input type="radio" id="fontSizeLarge" name="fontSize" value="large">
                        <label for="fontSizeLarge">L</label>
                        <input type="radio" id="fontSizeXLarge" name="fontSize" value="xlarge">
                        <label for="fontSizeXLarge">XL</label>
                    </div>
                </div>
            </div>

            <div class="settings-menu-divider"></div>

            <!-- Content Filter -->
            <div class="settings-section">
                <h4 style="margin: 8px 0; font-size: 13px; font-weight: 600; opacity: 0.7;">Content Filter</h4>

                <!-- Numbers Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Numbers:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeNumbers">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Capitals Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Capitals:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeCapitals">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Special Characters Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Special Chars:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeSpecialChars">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Spaces Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Spaces:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeSpaces" checked>
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>
            </div>

            <div class="settings-menu-divider"></div>

            <!-- Reset -->
            <div class="settings-menu-item">
                <button class="reset-btn" id="resetBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    Reset All Settings
                </button>
            </div>
        </div>
    </div>
    <div class="focus-hint">Press <kbd>Esc</kbd> to exit focus mode</div>

    <!-- Completion Tooltip -->
    <div class="completion-tooltip" id="completionTooltip"></div>

    <!-- Lessons Toggle Button -->
    <button class="lessons-toggle" id="lessonsToggle" title="Open Courses">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
        <span class="toggle-text">Courses</span>
        <span class="progress-badge" id="lessonProgress" style="display: none;">0</span>
    </button>

    <!-- Active Course Title -->
    <div class="active-course-title" id="activeCourseTitle" style="display: none;"></div>

    <!-- Main Layout Wrapper -->
    <div class="main-layout">
        <!-- Lessons Sidebar -->
        <div class="lessons-sidebar" id="lessonsSidebar">
            <div class="lessons-sidebar-header">
                <h3>Courses</h3>
                <button class="sidebar-close" id="sidebarClose">&times;</button>
            </div>
            <div class="lessons-sidebar-content">
                <p class="lessons-subtitle">Quick key presets for focused practice</p>
                <div class="lessons-grid" id="lessonsGrid">
                    <!-- Lessons will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
        <h1>Better QWERTY</h1>
        <p class="subtitle">Improve your typing skills by practicing specific keys and fingers</p>

        <div class="finger-selector">
            <div class="finger-buttons">
                <div class="hand-section">
                    <span class="hand-label">Left:</span>
                    <div class="fingers-visual">
                        <button class="finger-btn" data-finger="left-pinky" title="Pinky: 1, Q, A, Z">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-ring" title="Ring: 2, W, S, X">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-middle" title="Middle: 3, E, D, C">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-index" title="Index: 4, 5, R, T, F, G, V, B">
                            <div class="finger-visual"></div>
                        </button>
                    </div>
                </div>
                <div class="hand-section">
                    <span class="hand-label">Right:</span>
                    <div class="fingers-visual">
                        <button class="finger-btn" data-finger="right-index" title="Index: 6, 7, Y, U, H, J, N, M">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-middle" title="Middle: 8, I, K, ,">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-ring" title="Ring: 9, O, L, .">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-pinky" title="Pinky: 0, -, =, P, [, ], \, ;, '">
                            <div class="finger-visual"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="keyboard">
            <!-- Number Row -->
            <div class="keyboard-row">
                <div class="key" data-key="`" data-finger="left-pinky"><span class="key-label">~</span><span class="key-main">`</span></div>
                <div class="key" data-key="1" data-finger="left-pinky"><span class="key-label">!</span><span class="key-main">1</span></div>
                <div class="key" data-key="2" data-finger="left-ring"><span class="key-label">@</span><span class="key-main">2</span></div>
                <div class="key" data-key="3" data-finger="left-middle"><span class="key-label">#</span><span class="key-main">3</span></div>
                <div class="key" data-key="4" data-finger="left-index"><span class="key-label">$</span><span class="key-main">4</span></div>
                <div class="key" data-key="5" data-finger="left-index"><span class="key-label">%</span><span class="key-main">5</span></div>
                <div class="key" data-key="6" data-finger="right-index"><span class="key-label">^</span><span class="key-main">6</span></div>
                <div class="key" data-key="7" data-finger="right-index"><span class="key-label">&</span><span class="key-main">7</span></div>
                <div class="key" data-key="8" data-finger="right-middle"><span class="key-label">*</span><span class="key-main">8</span></div>
                <div class="key" data-key="9" data-finger="right-ring"><span class="key-label">(</span><span class="key-main">9</span></div>
                <div class="key" data-key="0" data-finger="right-pinky"><span class="key-label">)</span><span class="key-main">0</span></div>
                <div class="key" data-key="-" data-finger="right-pinky"><span class="key-label">_</span><span class="key-main">-</span></div>
                <div class="key" data-key="=" data-finger="right-pinky"><span class="key-label">+</span><span class="key-main">=</span></div>
                <div class="key backspace" data-key="backspace" data-finger="right-pinky">âŒ«</div>
            </div>

            <!-- QWERTY Row -->
            <div class="keyboard-row">
                <div class="key tab" data-key="tab" data-finger="left-pinky">Tab</div>
                <div class="key" data-key="q" data-finger="left-pinky">Q</div>
                <div class="key" data-key="w" data-finger="left-ring">W</div>
                <div class="key" data-key="e" data-finger="left-middle">E</div>
                <div class="key" data-key="r" data-finger="left-index">R</div>
                <div class="key" data-key="t" data-finger="left-index">T</div>
                <div class="key" data-key="y" data-finger="right-index">Y</div>
                <div class="key" data-key="u" data-finger="right-index">U</div>
                <div class="key" data-key="i" data-finger="right-middle">I</div>
                <div class="key" data-key="o" data-finger="right-ring">O</div>
                <div class="key" data-key="p" data-finger="right-pinky">P</div>
                <div class="key" data-key="[" data-finger="right-pinky"><span class="key-label">{</span><span class="key-main">[</span></div>
                <div class="key" data-key="]" data-finger="right-pinky"><span class="key-label">}</span><span class="key-main">]</span></div>
                <div class="key" data-key="\" data-finger="right-pinky"><span class="key-label">|</span><span class="key-main">\</span></div>
            </div>

            <!-- ASDF Row (Home Row) -->
            <div class="keyboard-row">
                <div class="key caps" data-key="caps" data-finger="left-pinky">Caps</div>
                <div class="key" data-key="a" data-finger="left-pinky">A</div>
                <div class="key" data-key="s" data-finger="left-ring">S</div>
                <div class="key" data-key="d" data-finger="left-middle">D</div>
                <div class="key home-row" data-key="f" data-finger="left-index">F</div>
                <div class="key" data-key="g" data-finger="left-index">G</div>
                <div class="key" data-key="h" data-finger="right-index">H</div>
                <div class="key home-row" data-key="j" data-finger="right-index">J</div>
                <div class="key" data-key="k" data-finger="right-middle">K</div>
                <div class="key" data-key="l" data-finger="right-ring">L</div>
                <div class="key" data-key=";" data-finger="right-pinky"><span class="key-label">:</span><span class="key-main">;</span></div>
                <div class="key" data-key="'" data-finger="right-pinky"><span class="key-label">"</span><span class="key-main">'</span></div>
                <div class="key enter" data-key="enter" data-finger="right-pinky">Enter</div>
            </div>

            <!-- ZXCV Row -->
            <div class="keyboard-row">
                <div class="key shift-left" data-key="shift" data-finger="left-pinky">Shift</div>
                <div class="key" data-key="z" data-finger="left-pinky">Z</div>
                <div class="key" data-key="x" data-finger="left-ring">X</div>
                <div class="key" data-key="c" data-finger="left-middle">C</div>
                <div class="key" data-key="v" data-finger="left-index">V</div>
                <div class="key" data-key="b" data-finger="left-index">B</div>
                <div class="key" data-key="n" data-finger="right-index">N</div>
                <div class="key" data-key="m" data-finger="right-index">M</div>
                <div class="key" data-key="," data-finger="right-middle"><span class="key-label">&lt;</span><span class="key-main">,</span></div>
                <div class="key" data-key="." data-finger="right-ring"><span class="key-label">&gt;</span><span class="key-main">.</span></div>
                <div class="key" data-key="/" data-finger="right-pinky"><span class="key-label">?</span><span class="key-main">/</span></div>
                <div class="key shift-right" data-key="shift-right" data-finger="right-pinky">Shift</div>
            </div>

            <!-- Space Row -->
            <div class="keyboard-row" style="justify-content: center; margin-left: 0;">
                <div class="key space" data-key=" " style="background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%); border-color: #b2bec3;">SPACE</div>
            </div>
        </div>

        <div class="selected-keys">
            <strong>Selected Keys:</strong> <span id="selectedKeysList">None - Click keys above or use finger shortcuts</span>
        </div>

        <div class="practice-area">
            <div class="practice-header">
                <h2>Typing Practice</h2>
                <div class="button-group">
                    <button class="btn-restart" id="restartBtn" disabled>Restart</button>
                    <button class="btn-generate" id="generateBtn" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        New Exercise
                    </button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">WPM</div>
                    <div class="stat-value" id="wpm">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" id="accuracy">100%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progress">0/0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Errors</div>
                    <div class="stat-value" id="errors">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value" id="timeElapsed">0s</div>
                </div>
            </div>

            <div class="timer-display" id="timerDisplay" style="display: none;">
                Time: <span id="timeRemaining">--</span>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>

            <div class="target-text" id="targetText">
                <div class="typing-overlay" id="typingOverlay">
                    <div class="overlay-content">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                        </svg>
                        <span>Click here or press any key to focus</span>
                    </div>
                </div>
                Select keys above to generate practice text
            </div>
            <div class="input-area">
                <input type="text" class="typing-input" id="typingInput" placeholder="Start typing here..." disabled>
            </div>

            <p class="instructions">Select keys and start typing! Use buttons or keyboard shortcuts below.</p>
            <div class="shortcuts">
                <strong>Keyboard Shortcuts:</strong>
                <span class="shortcut-key">F</span> Focus Mode â€¢
                <span class="shortcut-key">Shift</span>+<span class="shortcut-key">Enter</span> Restart â€¢
                <span class="shortcut-key" id="modKey1">Cmd</span>+<span class="shortcut-key">N</span> New â€¢
                <span class="shortcut-key" id="modKey2">Cmd</span>+<span class="shortcut-key">K</span> Focus Input
            </div>
        </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="stats-modal" id="statsModal">
        <div class="stats-content">
            <div class="stats-header">
                <h2>Typing Statistics</h2>
                <button class="stats-close" id="statsClose">&times;</button>
            </div>

            <!-- Main Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats cards will be dynamically inserted here -->
            </div>

            <!-- Streaks Section -->
            <div class="streaks-section" id="streaksSection">
                <div class="streaks-header">
                    <h3>ðŸ”¥ Daily Streaks</h3>
                    <p class="streaks-subtitle">Keep your momentum going!</p>
                </div>
                <div class="streaks-container" id="streaksContainer">
                    <!-- Streaks will be dynamically inserted here -->
                </div>
            </div>

            <!-- Insights Section -->
            <div class="stats-section" id="insightsSection">
                <h3>Insights & Recommendations</h3>
                <div id="insightsContainer">
                    <!-- Insights will be dynamically inserted here -->
                </div>
            </div>

            <!-- Most Frequent Errors -->
            <div class="stats-section" id="errorsSection">
                <h3>Most Frequent Error Keys</h3>
                <div class="error-keys-list" id="errorKeysList">
                    <!-- Error keys will be dynamically inserted here -->
                </div>
            </div>

            <!-- Keyboard Heatmap -->
            <div class="stats-section" id="heatmapSection">
                <h3>Error Heatmap</h3>
                <p class="heatmap-subtitle">Visual representation of your most problematic keys</p>
                <div class="heatmap-keyboard">
                    <!-- Number Row -->
                    <div class="heatmap-row">
                        <div class="heatmap-key" data-key="`">`</div>
                        <div class="heatmap-key" data-key="1">1</div>
                        <div class="heatmap-key" data-key="2">2</div>
                        <div class="heatmap-key" data-key="3">3</div>
                        <div class="heatmap-key" data-key="4">4</div>
                        <div class="heatmap-key" data-key="5">5</div>
                        <div class="heatmap-key" data-key="6">6</div>
                        <div class="heatmap-key" data-key="7">7</div>
                        <div class="heatmap-key" data-key="8">8</div>
                        <div class="heatmap-key" data-key="9">9</div>
                        <div class="heatmap-key" data-key="0">0</div>
                        <div class="heatmap-key" data-key="-">-</div>
                        <div class="heatmap-key" data-key="=">=</div>
                    </div>
                    <!-- QWERTY Row -->
                    <div class="heatmap-row">
                        <div class="heatmap-key" data-key="q">Q</div>
                        <div class="heatmap-key" data-key="w">W</div>
                        <div class="heatmap-key" data-key="e">E</div>
                        <div class="heatmap-key" data-key="r">R</div>
                        <div class="heatmap-key" data-key="t">T</div>
                        <div class="heatmap-key" data-key="y">Y</div>
                        <div class="heatmap-key" data-key="u">U</div>
                        <div class="heatmap-key" data-key="i">I</div>
                        <div class="heatmap-key" data-key="o">O</div>
                        <div class="heatmap-key" data-key="p">P</div>
                        <div class="heatmap-key" data-key="[">[</div>
                        <div class="heatmap-key" data-key="]">]</div>
                        <div class="heatmap-key" data-key="\">\</div>
                    </div>
                    <!-- Home Row -->
                    <div class="heatmap-row">
                        <div class="heatmap-key" data-key="a">A</div>
                        <div class="heatmap-key" data-key="s">S</div>
                        <div class="heatmap-key" data-key="d">D</div>
                        <div class="heatmap-key" data-key="f">F</div>
                        <div class="heatmap-key" data-key="g">G</div>
                        <div class="heatmap-key" data-key="h">H</div>
                        <div class="heatmap-key" data-key="j">J</div>
                        <div class="heatmap-key" data-key="k">K</div>
                        <div class="heatmap-key" data-key="l">L</div>
                        <div class="heatmap-key" data-key=";">;</div>
                        <div class="heatmap-key" data-key="'">'</div>
                    </div>
                    <!-- Bottom Row -->
                    <div class="heatmap-row">
                        <div class="heatmap-key" data-key="z">Z</div>
                        <div class="heatmap-key" data-key="x">X</div>
                        <div class="heatmap-key" data-key="c">C</div>
                        <div class="heatmap-key" data-key="v">V</div>
                        <div class="heatmap-key" data-key="b">B</div>
                        <div class="heatmap-key" data-key="n">N</div>
                        <div class="heatmap-key" data-key="m">M</div>
                        <div class="heatmap-key" data-key=",">,</div>
                        <div class="heatmap-key" data-key=".">.</div>
                        <div class="heatmap-key" data-key="/">/</div>
                    </div>
                    <!-- Space Row -->
                    <div class="heatmap-row" style="justify-content: center;">
                        <div class="heatmap-key heatmap-space" data-key=" ">SPACE</div>
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span class="legend-label">Fewer errors</span>
                    <div class="legend-gradient"></div>
                    <span class="legend-label">More errors</span>
                </div>
            </div>

            <!-- Reset Button -->
            <button class="reset-stats-btn" id="resetStatsBtn">Reset All Statistics</button>
        </div>
    </div>

    <!-- Custom Modal -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-body" id="modalBody"></div>
            <button class="modal-btn" id="modalBtn">OK</button>
        </div>
    </div>

    <script>
        // Detect platform and update modifier key display
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const modifierKeyName = isMac ? 'Cmd' : 'Alt';

        // Update modifier key displays on page load
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modKey1').textContent = modifierKeyName;
            document.getElementById('modKey2').textContent = modifierKeyName;
            // Load default word bank
            loadWordBank('10k');
        });

        // Function to load word bank from Monkeytype
        async function loadWordBank(size) {
            const urls = {
                '1k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_1k.json',
                '10k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_10k.json',
                '25k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_25k.json',
                '450k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_450k.json'
            };

            try {
                const response = await fetch(urls[size]);
                const data = await response.json();
                realWords = data.words;
                wordBankSize = size;
                console.log(`Loaded ${realWords.length} words from ${size} word bank`);
            } catch (error) {
                console.error('Failed to load word bank, using fallback:', error);
                realWords = fallbackWords;
            }
        }

        const fingerMap = {
            'left-pinky': ['`', '1', 'q', 'a', 'z', 'tab', 'caps', 'shift'],
            'left-ring': ['2', 'w', 's', 'x'],
            'left-middle': ['3', 'e', 'd', 'c'],
            'left-index': ['4', '5', 'r', 't', 'f', 'g', 'v', 'b'],
            'right-index': ['6', '7', 'y', 'u', 'h', 'j', 'n', 'm'],
            'right-middle': ['8', 'i', 'k', ','],
            'right-ring': ['9', 'o', 'l', '.'],
            'right-pinky': ['0', '-', '=', 'p', '[', ']', '\\', ';', "'", '/', 'enter', 'backspace', 'shift-right']
        };

        // Fallback word list
        const fallbackWords = [
            'the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at', 'this',
            'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there', 'their', 'what', 'so',
            'up', 'out', 'if', 'about', 'who', 'get', 'which', 'go', 'me', 'when', 'make', 'can', 'like', 'time', 'no', 'just', 'him', 'know', 'take', 'people',
            'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 'other', 'than', 'then', 'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also', 'back',
            'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well', 'way', 'even', 'new', 'want', 'because', 'any', 'these', 'give', 'day', 'most', 'us', 'is',
            'was', 'are', 'been', 'has', 'had', 'were', 'said', 'did', 'may', 'should', 'could', 'being', 'does', 'am', 'might', 'must', 'shall', 'having', 'been', 'able',
            'need', 'man', 'find', 'here', 'thing', 'give', 'many', 'well', 'only', 'those', 'tell', 'very', 'even', 'back', 'good', 'woman', 'through', 'us', 'life', 'child',
            'there', 'work', 'down', 'call', 'come', 'still', 'try', 'last', 'ask', 'need', 'too', 'feel', 'three', 'when', 'state', 'never', 'become', 'between', 'high', 'really',
            'something', 'most', 'another', 'much', 'family', 'own', 'leave', 'put', 'old', 'while', 'mean', 'keep', 'student', 'great', 'same', 'big', 'group', 'begin', 'seem', 'country',
            'help', 'talk', 'where', 'turn', 'problem', 'every', 'start', 'hand', 'might', 'show', 'part', 'against', 'place', 'over', 'such', 'again', 'few', 'case', 'week', 'company',
            'where', 'system', 'each', 'right', 'program', 'hear', 'question', 'during', 'work', 'play', 'government', 'run', 'small', 'number', 'off', 'always', 'move', 'night', 'live', 'point',
            'believe', 'hold', 'today', 'bring', 'happen', 'next', 'without', 'before', 'large', 'must', 'home', 'under', 'water', 'room', 'write', 'mother', 'area', 'money', 'story', 'young',
            'fact', 'month', 'different', 'lot', 'study', 'book', 'eye', 'job', 'word', 'though', 'business', 'issue', 'side', 'kind', 'four', 'head', 'far', 'black', 'long', 'both',
            'little', 'house', 'yes', 'since', 'provide', 'service', 'around', 'friend', 'important', 'father', 'sit', 'away', 'until', 'power', 'hour', 'game', 'often', 'yet', 'line', 'political',
            'end', 'among', 'ever', 'stand', 'bad', 'lose', 'however', 'member', 'pay', 'law', 'meet', 'car', 'city', 'almost', 'include', 'continue', 'set', 'later', 'community', 'name',
            'five', 'once', 'white', 'least', 'president', 'learn', 'real', 'change', 'team', 'minute', 'best', 'several', 'idea', 'kid', 'body', 'information', 'nothing', 'ago', 'lead', 'social',
            'understand', 'whether', 'watch', 'together', 'follow', 'around', 'parent', 'only', 'stop', 'face', 'anything', 'create', 'public', 'already', 'speak', 'others', 'read', 'level', 'allow', 'add',
            'office', 'spend', 'door', 'health', 'person', 'art', 'sure', 'war', 'history', 'party', 'within', 'grow', 'result', 'open', 'morning', 'walk', 'reason', 'low', 'win', 'research',
            'girl', 'guy', 'early', 'food', 'moment', 'himself', 'air', 'teacher', 'force', 'offer', 'enough', 'both', 'across', 'although', 'remember', 'foot', 'second', 'boy', 'maybe', 'toward',
            'able', 'age', 'policy', 'everything', 'love', 'process', 'music', 'including', 'consider', 'appear', 'actually', 'buy', 'probably', 'human', 'wait', 'serve', 'market', 'die', 'send', 'expect',
            'sense', 'build', 'stay', 'fall', 'oh', 'nation', 'plan', 'cut', 'college', 'interest', 'death', 'course', 'someone', 'experience', 'behind', 'reach', 'local', 'kill', 'six', 'remain',
            'effect', 'yeah', 'suggest', 'class', 'control', 'raise', 'care', 'perhaps', 'little', 'late', 'hard', 'field', 'else', 'pass', 'former', 'sell', 'major', 'sometimes', 'require', 'along',
            'development', 'themselves', 'report', 'role', 'better', 'economic', 'effort', 'decide', 'rate', 'strong', 'possible', 'heart', 'drug', 'leader', 'light', 'voice', 'wife', 'whole', 'police', 'mind',
            'finally', 'pull', 'return', 'free', 'military', 'price', 'less', 'according', 'decision', 'explain', 'son', 'hope', 'develop', 'view', 'relationship', 'carry', 'town', 'road', 'drive', 'arm',
            'true', 'federal', 'break', 'difference', 'thank', 'receive', 'value', 'international', 'building', 'action', 'full', 'model', 'join', 'season', 'society', 'tax', 'director', 'position', 'player', 'agree',
            'especially', 'record', 'pick', 'wear', 'paper', 'special', 'space', 'ground', 'form', 'support', 'event', 'official', 'whose', 'matter', 'everyone', 'center', 'couple', 'site', 'project', 'hit',
            'base', 'activity', 'star', 'table', 'court', 'produce', 'eat', 'teach', 'half', 'situation', 'easy', 'cost', 'industry', 'figure', 'street', 'image', 'itself', 'phone', 'either', 'data',
            'cover', 'quite', 'picture', 'clear', 'practice', 'piece', 'land', 'recent', 'describe', 'product', 'doctor', 'wall', 'patient', 'worker', 'news', 'test', 'movie', 'certain', 'north', 'simply',
            'third', 'technology', 'catch', 'step', 'baby', 'computer', 'type', 'attention', 'draw', 'film', 'Republican', 'tree', 'source', 'red', 'nearly', 'organization', 'choose', 'cause', 'hair', 'century',
            'evidence', 'window', 'difficult', 'listen', 'soon', 'culture', 'billion', 'chance', 'brother', 'energy', 'period', 'summer', 'realize', 'hundred', 'available', 'plant', 'likely', 'opportunity', 'term', 'short',
            'letter', 'condition', 'choice', 'place', 'single', 'rule', 'daughter', 'administration', 'south', 'husband', 'Congress', 'floor', 'campaign', 'material', 'population', 'economy', 'medical', 'hospital', 'church', 'close',
            'thousand', 'risk', 'current', 'fire', 'future', 'wrong', 'involve', 'defense', 'anyone', 'increase', 'security', 'bank', 'myself', 'certainly', 'west', 'sport', 'board', 'seek', 'per', 'subject',
            'officer', 'private', 'rest', 'behavior', 'deal', 'performance', 'fight', 'throw', 'top', 'quickly', 'past', 'goal', 'bed', 'order', 'author', 'fill', 'represent', 'focus', 'foreign', 'drop',
            'plan', 'blood', 'upon', 'agency', 'push', 'nature', 'color', 'recently', 'store', 'reduce', 'sound', 'note', 'fine', 'near', 'movement', 'page', 'enter', 'share', 'common', 'poor',
            'natural', 'race', 'concern', 'series', 'significant', 'similar', 'hot', 'language', 'each', 'usually', 'response', 'dead', 'rise', 'animal', 'factor', 'decade', 'article', 'shoot', 'east', 'save',
            'seven', 'artist', 'scene', 'stock', 'career', 'despite', 'central', 'eight', 'thus', 'treatment', 'beyond', 'happy', 'exactly', 'protect', 'approach', 'lie', 'size', 'dog', 'fund', 'serious',
            'occur', 'media', 'ready', 'sign', 'thought', 'list', 'individual', 'simple', 'quality', 'pressure', 'accept', 'answer', 'resource', 'identify', 'left', 'meeting', 'determine', 'prepare', 'disease', 'whatever',
            'success', 'argue', 'cup', 'particularly', 'amount', 'ability', 'staff', 'recognize', 'indicate', 'character', 'growth', 'loss', 'degree', 'wonder', 'attack', 'herself', 'region', 'television', 'box', 'TV',
            'training', 'pretty', 'trade', 'election', 'everybody', 'physical', 'lay', 'general', 'feeling', 'standard', 'bill', 'message', 'fail', 'outside', 'arrive', 'analysis', 'benefit', 'sex', 'forward', 'lawyer',
            'present', 'section', 'environmental', 'glass', 'skill', 'sister', 'PM', 'professor', 'operation', 'financial', 'crime', 'stage', 'compare', 'authority', 'miss', 'design', 'sort', 'act', 'ten', 'knowledge',
            'gun', 'station', 'blue', 'strategy', 'clearly', 'discuss', 'indeed', 'truth', 'song', 'example', 'democratic', 'check', 'environment', 'leg', 'dark', 'various', 'rather', 'laugh', 'guess', 'executive',
            'prove', 'hang', 'entire', 'rock', 'forget', 'claim', 'remove', 'manager', 'enjoy', 'network', 'legal', 'religious', 'cold', 'form', 'final', 'main', 'science', 'green', 'memory', 'card',
            'above', 'seat', 'cell', 'establish', 'nice', 'trial', 'expert', 'spring', 'firm', 'Democrat', 'radio', 'visit', 'management', 'avoid', 'imagine', 'tonight', 'huge', 'ball', 'finish', 'yourself',
            'theory', 'impact', 'respond', 'statement', 'maintain', 'charge', 'popular', 'traditional', 'onto', 'reveal', 'direction', 'weapon', 'employee', 'cultural', 'contain', 'peace', 'head', 'control', 'base', 'pain',
            'apply', 'play', 'measure', 'wide', 'shake', 'fly', 'interview', 'manage', 'chair', 'fish', 'particular', 'camera', 'structure', 'politics', 'perform', 'bit', 'weight', 'suddenly', 'discover', 'candidate',
            'production', 'treat', 'trip', 'evening', 'affect', 'inside', 'conference', 'unit', 'best', 'style', 'adult', 'worry', 'range', 'mention', 'rather', 'deep', 'edge', 'specific', 'writer', 'trouble',
            'necessary', 'throughout', 'challenge', 'fear', 'shoulder', 'institution', 'middle', 'sea', 'dream', 'bar', 'beautiful', 'property', 'instead', 'improve', 'stuff', 'claim', 'professor', 'else', 'magazine', 'hotel',
            'soldier', 'reflect', 'heavy', 'sexual', 'bag', 'heat', 'marriage', 'tough', 'sing', 'surface', 'purpose', 'exist', 'pattern', 'whom', 'skin', 'agent', 'owner', 'machine', 'gas', 'ahead',
            'generation', 'commercial', 'address', 'cancer', 'item', 'reality', 'coach', 'Mrs', 'yard', 'beat', 'violence', 'total', 'tend', 'investment', 'discussion', 'finger', 'garden', 'notice', 'collection', 'modern',
            'task', 'partner', 'positive', 'civil', 'kitchen', 'consumer', 'shot', 'budget', 'wish', 'painting', 'scientist', 'safe', 'agreement', 'capital', 'mouth', 'nor', 'victim', 'newspaper', 'threat', 'responsibility',
            'smile', 'attorney', 'score', 'account', 'interesting', 'break', 'audience', 'rich', 'dinner', 'figure', 'vote', 'western', 'relate', 'travel', 'debate', 'prevent', 'citizen', 'majority', 'none', 'front',
            'born', 'admit', 'senior', 'assume', 'wind', 'key', 'professional', 'mission', 'fast', 'alone', 'customer', 'suffer', 'speech', 'successful', 'option', 'participant', 'southern', 'fresh', 'eventually', 'forest',
            'video', 'global', 'reform', 'access', 'restaurant', 'judge', 'publish', 'cost', 'relation', 'like', 'release', 'own', 'bird', 'opinion', 'credit', 'critical', 'corner', 'concerned', 'recall', 'version',
            'stare', 'safety', 'effective', 'neighborhood', 'original', 'act', 'troop', 'income', 'directly', 'hurt', 'species', 'immediately', 'track', 'basic', 'strike', 'hope', 'freedom', 'absolutely', 'plane', 'nobody',
            'achieve', 'object', 'attitude', 'labor', 'refer', 'concept', 'client', 'powerful', 'perfect', 'nine', 'therefore', 'conduct', 'announce', 'conversation', 'examine', 'touch', 'please', 'attend', 'completely', 'vote',
            'variety', 'sleep', 'turn', 'involved', 'investigation', 'nuclear', 'researcher', 'press', 'conflict', 'spirit', 'replace', 'British', 'encourage', 'argument', 'by', 'once', 'camp', 'brain', 'feature', 'afternoon',
            'AM', 'weekend', 'dozen', 'possibility', 'insurance', 'department', 'battle', 'beginning', 'date', 'generally', 'African', 'very', 'sorry', 'crisis', 'complete', 'fan', 'stick', 'define', 'easily', 'through',
            'hole', 'element', 'vision', 'status', 'normal', 'Chinese', 'ship', 'solution', 'stone', 'slowly', 'scale', 'driver', 'attempt', 'park', 'spot', 'lack', 'ice', 'boat', 'drink', 'sun',
            'front', 'distance', 'wood', 'handle', 'truck', 'mountain', 'survey', 'supposed', 'tradition', 'winter', 'village', 'Soviet', 'refuse', 'sales', 'roll', 'communication', 'run', 'screen', 'gain', 'resident',
            'hide', 'gold', 'club', 'farm', 'potential', 'increase', 'middle', 'European', 'presence', 'independent', 'district', 'shape', 'reader', 'Ms', 'contract', 'crowd', 'Christian', 'express', 'apartment', 'willing',
            'strength', 'previous', 'band', 'obviously', 'horse', 'interested', 'target', 'prison', 'ride', 'guard', 'terms', 'demand', 'reporter', 'deliver', 'text', 'tool', 'wild', 'vehicle', 'observe', 'flight',
            'facility', 'understanding', 'average', 'emerge', 'advantage', 'quick', 'light', 'leadership', 'earn', 'pound', 'basis', 'bright', 'operate', 'guest', 'sample', 'contribute', 'tiny', 'block', 'protection', 'settle',
            'feed', 'collect', 'additional', 'while', 'highly', 'identity', 'title', 'mostly', 'lesson', 'faith', 'river', 'promote', 'living', 'count', 'unless', 'marry', 'tomorrow', 'technique', 'path', 'ear',
            'shop', 'folk', 'principle', 'survive', 'lift', 'border', 'competition', 'jump', 'gather', 'limit', 'fit', 'claim', 'cry', 'equipment', 'worth', 'associate', 'critic', 'warm', 'aspect', 'result',
            'insist', 'failure', 'annual', 'French', 'Christmas', 'comment', 'responsible', 'affair', 'procedure', 'regular', 'spread', 'chairman', 'baseball', 'soft', 'ignore', 'egg', 'belief', 'demonstrate', 'anybody', 'murder',
            'gift', 'religion', 'review', 'editor', 'engage', 'coffee', 'document', 'speed', 'cross', 'influence', 'anyway', 'threaten', 'commit', 'female', 'youth', 'wave', 'afraid', 'quarter', 'background', 'native',
            'broad', 'wonderful', 'deny', 'apparently', 'slightly', 'reaction', 'twice', 'suit', 'perspective', 'growing', 'blow', 'construction', 'kind', 'intelligence', 'destroy', 'cook', 'connection', 'burn', 'shoe', 'grade',
            'context', 'committee', 'hey', 'mistake', 'focus', 'smile', 'location', 'clothes', 'Indian', 'quiet', 'dress', 'promise', 'aware', 'neighbor', 'function', 'bone', 'active', 'extend', 'chief', 'combine',
            'wine', 'below', 'cool', 'voter', 'learning', 'bus', 'hell', 'dangerous', 'remind', 'moral', 'United', 'category', 'relatively', 'victory', 'academic', 'Internet', 'healthy', 'negative', 'following', 'historical',
            'medicine', 'tour', 'depend', 'photo', 'finding', 'grab', 'direct', 'classroom', 'contact', 'justice', 'participate', 'daily', 'fair', 'pair', 'famous', 'separate', 'quote', 'German', 'pound', 'double',
            'conversation', 'develop', 'seek', 'connection', 'works', 'brown', 'lead', 'trouble', 'action', 'propose', 'next', 'careful', 'driver', 'conservative', 'present', 'liberal', 'lip', 'launch', 'accurate', 'career',
            'dog', 'scene', 'peace', 'citizen', 'weapon', 'perspective', 'advantage', 'tone', 'ocean', 'signal', 'sentence', 'discipline', 'elsewhere', 'iron', 'perception', 'pack', 'contempor'
        ];

        // Real words - loaded from Monkeytype API
        let realWords = fallbackWords;
        let wordBankSize = '10k'; // Default to 10K

        let selectedKeys = new Set();
        let currentText = '';
        let currentPosition = 0;
        let errorCount = 0;
        let totalTyped = 0;
        let startTime = null;
        let lastWpmUpdate = 0;
        let timerInterval = null;
        let errorPositions = new Map(); // Track positions with errors and what was typed
        let timeLimit = 30;
        let isTimedMode = false;
        let isUnlimitedMode = true;

        // Settings
        let wordCount = 10;
        let includeNumbers = false;
        let useRealWords = true;
        let useCapitals = false;
        let includeSpecialChars = false;
        let includeSpaces = true;
        let errorMode = 'block'; // 'block', 'skip', 'backspace'
        let fontSize = 'medium'; // 'small', 'medium', 'large', 'xlarge'
        let soundFeedbackEnabled = true;
        let soundType = 'classic';

        // Sound presets
        const soundPresets = {
            classic: {
                correct: { freq: 800, type: 'sine', duration: 0.05, volume: 0.03 },
                error: { freq: 200, type: 'sawtooth', duration: 0.1, volume: 0.05 }
            },
            mechanical: {
                correct: { freq: 1200, type: 'square', duration: 0.03, volume: 0.02 },
                error: { freq: 150, type: 'square', duration: 0.08, volume: 0.04 }
            },
            soft: {
                correct: { freq: 600, type: 'sine', duration: 0.08, volume: 0.02 },
                error: { freq: 300, type: 'sine', duration: 0.15, volume: 0.03 }
            },
            minimal: {
                correct: { freq: 1000, type: 'sine', duration: 0.02, volume: 0.015 },
                error: { freq: 250, type: 'triangle', duration: 0.05, volume: 0.025 }
            }
        };

        // Audio Context for sound feedback
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playCorrectSound() {
            if (!soundFeedbackEnabled) return;
            initAudioContext();

            const preset = soundPresets[soundType].correct;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = preset.freq;
            oscillator.type = preset.type;

            gainNode.gain.setValueAtTime(preset.volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + preset.duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + preset.duration);
        }

        function playErrorSound() {
            if (!soundFeedbackEnabled) return;
            initAudioContext();

            const preset = soundPresets[soundType].error;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = preset.freq;
            oscillator.type = preset.type;

            gainNode.gain.setValueAtTime(preset.volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + preset.duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + preset.duration);
        }

        function flashKey(keyChar, isCorrect) {
            const keyElement = document.querySelector(`.key[data-key="${keyChar.toLowerCase()}"]`);
            if (!keyElement) return;

            const className = isCorrect ? 'flash-correct' : 'flash-error';
            keyElement.classList.add(className);

            setTimeout(() => {
                keyElement.classList.remove(className);
            }, isCorrect ? 300 : 400);
        }

        // Stats tracking
        let typingStats = {
            totalSessions: 0,
            totalCharactersTyped: 0,
            totalErrors: 0,
            totalTimeSeconds: 0,
            keyErrorCounts: {}, // { 'a': 5, 'b': 3, ... }
            sessionHistory: [], // Array of session objects
            bestWPM: 0,
            bestAccuracy: 0,
            practiceDates: [], // Array of date strings (YYYY-MM-DD) when user practiced
            longestStreak: 0 // Longest consecutive days streak
        };
        let sessionKeyErrors = {}; // Track errors for current session

        // Practice Courses - Convenient key presets
        const lessons = [
            {
                id: 1,
                title: "Home Row",
                description: "Practice the foundation keys",
                keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';'],
                difficulty: "Beginner"
            },
            {
                id: 2,
                title: "Top Row",
                description: "QWERTY row practice",
                keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';', 'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
                difficulty: "Beginner"
            },
            {
                id: 3,
                title: "Bottom Row",
                description: "Complete alphabet practice",
                keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';', 'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/'],
                difficulty: "Intermediate"
            },
            {
                id: 4,
                title: "Numbers",
                description: "Letters + number keys practice",
                keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';', 'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
                difficulty: "Intermediate"
            },
            {
                id: 5,
                title: "Full Keyboard",
                description: "All keys including special characters",
                keys: ['a', 's', 'd', 'f', 'j', 'k', 'l', ';', 'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '`', '-', '=', '[', ']', '\\', "'"],
                difficulty: "Advanced"
            },
            {
                id: 6,
                title: "Left Hand",
                description: "Left hand keys only",
                keys: ['q', 'w', 'e', 'r', 't', 'a', 's', 'd', 'f', 'g', 'z', 'x', 'c', 'v', 'b', '1', '2', '3', '4', '5'],
                difficulty: "Intermediate"
            },
            {
                id: 7,
                title: "Right Hand",
                description: "Right hand keys only",
                keys: ['y', 'u', 'i', 'o', 'p', 'h', 'j', 'k', 'l', ';', 'n', 'm', ',', '.', '/', '6', '7', '8', '9', '0'],
                difficulty: "Intermediate"
            }
        ];

        let courseStats = {
            courseData: {} // { courseId: { bestWPM: 45, bestAccuracy: 92, sessions: 5 } }
        };

        let activeCourseId = null;

        function loadCourseStats() {
            const saved = localStorage.getItem('courseStats');
            if (saved) {
                try {
                    courseStats = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load course stats', e);
                }
            }
        }

        function saveCourseStats() {
            localStorage.setItem('courseStats', JSON.stringify(courseStats));
        }

        // Custom courses management
        let customCourses = [];

        function loadCustomCourses() {
            const saved = localStorage.getItem('customCourses');
            if (saved) {
                try {
                    customCourses = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load custom courses', e);
                    customCourses = [];
                }
            }
        }

        function saveCustomCourses() {
            localStorage.setItem('customCourses', JSON.stringify(customCourses));
        }

        function deleteCustomCourse(courseId) {
            customCourses = customCourses.filter(c => c.id !== courseId);
            saveCustomCourses();

            // Also remove stats for this course
            if (courseStats.courseData[courseId]) {
                delete courseStats.courseData[courseId];
                saveCourseStats();
            }

            renderLessons();
        }

        function toggleCourseCompletion(courseId) {
            // Initialize course data if it doesn't exist
            if (!courseStats.courseData[courseId]) {
                courseStats.courseData[courseId] = {
                    bestWPM: 0,
                    bestAccuracy: 0,
                    sessions: 0,
                    completed: false
                };
            }

            // Toggle completion status
            courseStats.courseData[courseId].completed = !courseStats.courseData[courseId].completed;
            saveCourseStats();
            renderLessons();
        }

        window.toggleCourseCompletion = toggleCourseCompletion;

        function getAllCourses() {
            return [...lessons, ...customCourses];
        }

        function createCustomCourseFromPlaceholder(title, description, difficulty) {
            // Validation
            if (!title || title.trim() === '' || title === 'New Custom Course') {
                alert('Please enter a course name');
                return false;
            }

            if (selectedKeys.size === 0) {
                alert('Please select at least one key for your course');
                return false;
            }

            // Create new course with unique ID
            const newCourse = {
                id: `custom-${Date.now()}`,
                title: title.trim(),
                description: description.trim() || 'Custom course',
                keys: Array.from(selectedKeys),
                difficulty: difficulty,
                custom: true
            };

            customCourses.push(newCourse);
            saveCustomCourses();
            renderLessons();
            return true;
        }

        window.deleteCustomCourse = deleteCustomCourse;
        window.createCustomCourseFromPlaceholder = createCustomCourseFromPlaceholder;

        function renderLessons() {
            const lessonsGrid = document.getElementById('lessonsGrid');
            if (!lessonsGrid) return;

            const allCourses = getAllCourses();

            lessonsGrid.innerHTML = allCourses.map(lesson => {
                const isActive = activeCourseId == lesson.id;
                const courseData = courseStats.courseData[lesson.id];
                const isCustom = lesson.custom === true;

                let cardClass = 'lesson-card';
                if (isActive) {
                    cardClass += ' active';
                }

                const keysDisplay = lesson.keys.slice(0, 18).join(' ').toUpperCase() + (lesson.keys.length > 18 ? ' ...' : '');

                // Check completion status
                const isCompleted = courseData && courseData.completed;

                let statsText = '';
                if (courseData) {
                    // Show stats
                    statsText = `
                        <div class="lesson-stats">
                            <div class="lesson-stat-item">
                                <span class="stat-icon">âš¡</span>
                                <span class="stat-text">${courseData.bestWPM} WPM</span>
                            </div>
                            <div class="lesson-stat-item">
                                <span class="stat-icon">ðŸŽ¯</span>
                                <span class="stat-text">${courseData.bestAccuracy}%</span>
                            </div>
                            <div class="lesson-stat-item">
                                <span class="stat-icon">ðŸ“Š</span>
                                <span class="stat-text">${courseData.sessions} session${courseData.sessions !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                    `;

                    // Add completion action
                    if (isCompleted) {
                        statsText += `<button class="lesson-completed-badge" onclick="event.stopPropagation(); toggleCourseCompletion('${lesson.id}');">âœ“ Finished</button>`;
                    } else {
                        statsText += `<button class="lesson-mark-finished-btn" onclick="event.stopPropagation(); toggleCourseCompletion('${lesson.id}');">Mark as Finished</button>`;
                    }
                } else {
                    statsText = `<div class="lesson-new-badge">âœ¨ Try this course</div>`;
                }

                let difficultyBadge = '';
                if (lesson.difficulty === 'Beginner') {
                    difficultyBadge = '<span class="lesson-badge difficulty-beginner">Beginner</span>';
                } else if (lesson.difficulty === 'Intermediate') {
                    difficultyBadge = '<span class="lesson-badge difficulty-intermediate">Intermediate</span>';
                } else if (lesson.difficulty === 'Advanced') {
                    difficultyBadge = '<span class="lesson-badge difficulty-advanced">Advanced</span>';
                }

                // Add custom badge and delete button for custom courses
                const customBadge = isCustom ? '<span class="lesson-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Custom</span>' : '';
                const deleteBtn = isCustom ? `<button class="lesson-delete-btn" onclick="event.stopPropagation(); deleteCustomCourse('${lesson.id}');" title="Delete custom course">Ã—</button>` : '';

                return `
                    <div class="${cardClass}${isCompleted ? ' completed' : ''}" data-lesson-id="${lesson.id}" onclick="selectLesson('${lesson.id}')">
                        ${deleteBtn}
                        <div class="lesson-header-row">
                            <div class="lesson-title">${lesson.title}</div>
                            <div style="display: flex; gap: 6px;">
                                ${customBadge}
                                ${difficultyBadge}
                            </div>
                        </div>
                        <div class="lesson-description">${lesson.description}</div>
                        <div class="lesson-keys-count">${lesson.keys.length} keys</div>
                        <div class="lesson-keys">${keysDisplay}</div>
                        ${statsText}
                    </div>
                `;
            }).join('');

            // Add placeholder card for creating new custom course
            const keysDisplay = selectedKeys.size > 0
                ? Array.from(selectedKeys).slice(0, 18).join(' ').toUpperCase() + (selectedKeys.size > 18 ? ' ...' : '')
                : 'Select keys from keyboard first';

            const placeholderCard = `
                <div class="lesson-card lesson-card-placeholder" onclick="event.stopPropagation();">
                    <div class="lesson-header-row">
                        <div class="lesson-title" contenteditable="true" id="newCourseTitle" data-placeholder="New Custom Course">New Custom Course</div>
                        <span class="lesson-badge difficulty-intermediate difficulty-cycle-badge" id="difficultyCycleBadge" onclick="cycleDifficulty()" title="Click to cycle difficulty">Intermediate</span>
                    </div>
                    <div class="lesson-description" contenteditable="true" id="newCourseDescription" data-placeholder="Add a description...">Add a description...</div>
                    <div class="lesson-keys-count">${selectedKeys.size} keys</div>
                    <div class="lesson-keys">${keysDisplay}</div>
                    <button class="create-course-inline-btn" onclick="saveNewCourse()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Create Course
                    </button>
                </div>
            `;

            lessonsGrid.innerHTML += placeholderCard;

            // Update progress badge on toggle button - show number of courses tried
            const progressBadge = document.getElementById('lessonProgress');
            if (progressBadge) {
                const triedCount = Object.keys(courseStats.courseData).length;
                if (triedCount > 0) {
                    progressBadge.textContent = `${triedCount}`;
                    progressBadge.style.display = 'flex';
                } else {
                    progressBadge.style.display = 'none';
                }
            }
        }

        let selectedDifficulty = 'Intermediate';
        const difficultyLevels = ['Beginner', 'Intermediate', 'Advanced'];

        window.cycleDifficulty = function() {
            const badge = document.getElementById('difficultyCycleBadge');
            if (!badge) return;

            // Get current index and move to next
            const currentIndex = difficultyLevels.indexOf(selectedDifficulty);
            const nextIndex = (currentIndex + 1) % difficultyLevels.length;
            selectedDifficulty = difficultyLevels[nextIndex];

            // Update badge text
            badge.textContent = selectedDifficulty;

            // Update badge class
            badge.className = 'lesson-badge difficulty-cycle-badge';
            if (selectedDifficulty === 'Beginner') {
                badge.classList.add('difficulty-beginner');
            } else if (selectedDifficulty === 'Intermediate') {
                badge.classList.add('difficulty-intermediate');
            } else if (selectedDifficulty === 'Advanced') {
                badge.classList.add('difficulty-advanced');
            }
        };

        window.saveNewCourse = function() {
            const title = document.getElementById('newCourseTitle').textContent;
            const description = document.getElementById('newCourseDescription').textContent;

            if (createCustomCourseFromPlaceholder(title, description, selectedDifficulty)) {
                // Success - course was created and renderLessons was called
                selectedDifficulty = 'Intermediate'; // Reset to default
            }
        };

        function updatePlaceholderKeys() {
            const keysCountEl = document.querySelector('.lesson-card-placeholder .lesson-keys-count');
            const keysDisplayEl = document.querySelector('.lesson-card-placeholder .lesson-keys');

            if (!keysCountEl || !keysDisplayEl) return;

            // Update keys count
            keysCountEl.textContent = `${selectedKeys.size} keys`;

            // Update keys display
            const keysDisplay = selectedKeys.size > 0
                ? Array.from(selectedKeys).slice(0, 18).join(' ').toUpperCase() + (selectedKeys.size > 18 ? ' ...' : '')
                : 'Select keys from keyboard first';
            keysDisplayEl.textContent = keysDisplay;
        }

        window.selectLesson = function(lessonId) {
            const allCourses = getAllCourses();
            // Handle both string and number IDs (numeric IDs come as strings from onclick)
            const lesson = allCourses.find(l => l.id == lessonId);
            if (!lesson) return;

            activeCourseId = lessonId;

            // Update active course title display
            const activeCourseTitle = document.getElementById('activeCourseTitle');
            if (activeCourseTitle) {
                activeCourseTitle.textContent = lesson.title;
                activeCourseTitle.style.display = 'flex';
            }

            // Clear current selection
            selectedKeys.clear();
            document.querySelectorAll('.key.selected').forEach(key => {
                key.classList.remove('selected');
            });
            document.querySelectorAll('.finger-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Select lesson keys
            lesson.keys.forEach(key => {
                selectedKeys.add(key);
                const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                if (keyEl) keyEl.classList.add('selected');
            });

            // Auto-enable settings based on lesson
            if (lesson.keys.some(k => ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'].includes(k))) {
                includeNumbers = true;
                includeNumbersCheckbox.checked = true;
            }
            if (lesson.keys.some(k => ['`', '-', '=', '[', ']', '\\', "'"].includes(k))) {
                includeSpecialChars = true;
                includeSpecialCharsCheckbox.checked = true;
            }

            // Generate practice text
            updateSelectedKeysList();
            generatePracticeText();
            renderLessons();

            // Keep sidebar open (user may want to browse courses)
            // You can optionally close it automatically with:
            // const sidebar = document.getElementById('lessonsSidebar');
            // if (sidebar) sidebar.classList.remove('open');

            // Scroll to practice area
            setTimeout(() => {
                document.querySelector('.practice-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        function updateCourseStats(wpm, accuracy) {
            if (!activeCourseId) return;

            // Update course stats
            if (!courseStats.courseData[activeCourseId]) {
                courseStats.courseData[activeCourseId] = {
                    bestWPM: 0,
                    bestAccuracy: 0,
                    sessions: 0
                };
            }

            const courseData = courseStats.courseData[activeCourseId];
            courseData.sessions++;
            if (wpm > courseData.bestWPM) courseData.bestWPM = wpm;
            if (accuracy > courseData.bestAccuracy) courseData.bestAccuracy = accuracy;

            saveCourseStats();
            renderLessons();
        }

        const keys = document.querySelectorAll('.key');
        const fingerBtns = document.querySelectorAll('.finger-btn');
        const selectedKeysList = document.getElementById('selectedKeysList');
        const generateBtn = document.getElementById('generateBtn');
        const restartBtn = document.getElementById('restartBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const targetText = document.getElementById('targetText');
        const typingInput = document.getElementById('typingInput');
        const accuracyEl = document.getElementById('accuracy');
        const progressEl = document.getElementById('progress');
        const errorsEl = document.getElementById('errors');
        const wpmEl = document.getElementById('wpm');
        const timeElapsedEl = document.getElementById('timeElapsed');
        const progressBar = document.getElementById('progressBar');
        const timerDisplay = document.getElementById('timerDisplay');
        const timeRemaining = document.getElementById('timeRemaining');

        // Settings elements
        const modeWords = document.getElementById('modeWords');
        const modeTimed = document.getElementById('modeTimed');
        const modeUnlimited = document.getElementById('modeUnlimited');
        const wordCountSetting = document.getElementById('wordCountSetting');
        const timeLimitSetting = document.getElementById('timeLimitSetting');
        const includeNumbersCheckbox = document.getElementById('includeNumbers');
        const wordSetGibberish = document.getElementById('wordSetGibberish');
        const wordSetReal = document.getElementById('wordSetReal');
        const includeCapitalsCheckbox = document.getElementById('includeCapitals');
        const includeSpecialCharsCheckbox = document.getElementById('includeSpecialChars');

        // Handle individual key selection
        keys.forEach(key => {
            key.addEventListener('click', () => {
                const keyValue = key.dataset.key;

                // Space is always available, don't allow manual selection
                if (keyValue === ' ') return;

                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];

                if (selectedKeys.has(keyValue)) {
                    selectedKeys.delete(keyValue);
                    key.classList.remove('selected');
                } else {
                    selectedKeys.add(keyValue);
                    key.classList.add('selected');

                    // Auto-enable toggles when selecting numbers or special chars
                    if (numberKeys.includes(keyValue) && !includeNumbers) {
                        includeNumbers = true;
                        includeNumbersCheckbox.checked = true;
                    }
                    if (specialChars.includes(keyValue) && !includeSpecialChars) {
                        includeSpecialChars = true;
                        includeSpecialCharsCheckbox.checked = true;
                    }
                }

                updateSelectedKeysList();
                showSaveButton();
            });
        });

        // Handle finger button selection
        fingerBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const finger = btn.dataset.finger;
                const isActive = btn.classList.contains('active');

                if (isActive) {
                    // Deselect this finger's keys
                    btn.classList.remove('active');
                    fingerMap[finger].forEach(key => {
                        selectedKeys.delete(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.remove('selected');
                    });
                } else {
                    // Select this finger's keys - respect toggle settings
                    btn.classList.add('active');
                    const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                    const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                    const capitalKeys = ['caps', 'shift', 'shift-right'];

                    fingerMap[finger].forEach(key => {
                        // Skip space - it's always available
                        if (key === ' ') return;
                        // Skip numbers if disabled
                        if (!includeNumbers && numberKeys.includes(key)) return;
                        // Skip special chars if disabled
                        if (!includeSpecialChars && specialChars.includes(key)) return;
                        // Skip caps/shift if capitals are disabled
                        if (!useCapitals && capitalKeys.includes(key)) return;

                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });
                }

                updateSelectedKeysList();
                showSaveButton();
            });
        });

        // Settings event listeners
        modeWords.addEventListener('change', () => {
            isTimedMode = false;
            isUnlimitedMode = false;
            wordCountSetting.style.display = 'flex';
            timeLimitSetting.style.display = 'none';
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        modeTimed.addEventListener('change', () => {
            isTimedMode = true;
            isUnlimitedMode = false;
            wordCountSetting.style.display = 'none';
            timeLimitSetting.style.display = 'flex';
            const selectedTime = document.querySelector('input[name="timeLimit"]:checked');
            timeLimit = parseInt(selectedTime.value);
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        modeUnlimited.addEventListener('change', () => {
            isTimedMode = false;
            isUnlimitedMode = true;
            wordCountSetting.style.display = 'none';
            timeLimitSetting.style.display = 'none';
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        document.querySelectorAll('input[name="timeLimit"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                timeLimit = parseInt(e.target.value);
                showSaveButton();
                if (isTimedMode && selectedKeys.size > 0) generatePracticeText();
            });
        });

        document.querySelectorAll('input[name="wordCount"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                wordCount = parseInt(e.target.value);
                showSaveButton();
                if (!isTimedMode && !isUnlimitedMode && selectedKeys.size > 0) generatePracticeText();
            });
        });

        includeNumbersCheckbox.addEventListener('change', (e) => {
            includeNumbers = e.target.checked;
            showSaveButton();
            const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            // Add or remove number keys based on toggle
            fingerBtns.forEach(btn => {
                if (btn.classList.contains('active')) {
                    const finger = btn.dataset.finger;
                    fingerMap[finger].forEach(key => {
                        if (numberKeys.includes(key)) {
                            const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                            if (includeNumbers) {
                                selectedKeys.add(key);
                                if (keyEl) keyEl.classList.add('selected');
                            } else {
                                selectedKeys.delete(key);
                                if (keyEl) keyEl.classList.remove('selected');
                            }
                        }
                    });
                }
            });

            updateSelectedKeysList();
        });

        wordSetGibberish.addEventListener('change', () => {
            useRealWords = false;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        wordSetReal.addEventListener('change', () => {
            useRealWords = true;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        includeCapitalsCheckbox.addEventListener('change', (e) => {
            useCapitals = e.target.checked;
            showSaveButton();
            updateKeyboardVisuals();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        includeSpecialCharsCheckbox.addEventListener('change', (e) => {
            includeSpecialChars = e.target.checked;
            showSaveButton();
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];

            // Add or remove special char keys based on toggle
            fingerBtns.forEach(btn => {
                if (btn.classList.contains('active')) {
                    const finger = btn.dataset.finger;
                    fingerMap[finger].forEach(key => {
                        if (specialChars.includes(key)) {
                            const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                            if (includeSpecialChars) {
                                selectedKeys.add(key);
                                if (keyEl) keyEl.classList.add('selected');
                            } else {
                                selectedKeys.delete(key);
                                if (keyEl) keyEl.classList.remove('selected');
                            }
                        }
                    });
                }
            });

            updateSelectedKeysList();
        });

        document.getElementById('includeSpaces').addEventListener('change', (e) => {
            includeSpaces = e.target.checked;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        // Error Mode listeners
        document.querySelectorAll('input[name="errorMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                errorMode = e.target.value;
                showSaveButton();
            });
        });

        // Word Bank listeners
        document.querySelectorAll('input[name="wordBank"]').forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const size = e.target.value;
                showSaveButton();
                await loadWordBank(size);
                // Regenerate text with new word bank if already practicing
                if (selectedKeys.size > 0 && currentText) {
                    generatePracticeText();
                }
            });
        });

        // Font size change
        document.querySelectorAll('input[name="fontSize"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                fontSize = e.target.value;
                showSaveButton();
                // Remove all font size classes
                targetText.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                // Add the selected font size class
                targetText.classList.add(`font-${fontSize}`);
            });
        });

        function updateKeyboardVisuals() {
            // Update keyboard visual highlights based on settings
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const capitalKeys = ['caps', 'shift', 'shift-right'];
            const nonTypeableKeys = ['tab', 'enter', 'backspace'];
            const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            keys.forEach(key => {
                const keyValue = key.dataset.key;
                const isSpecialChar = specialChars.includes(keyValue);
                const isCapitalKey = capitalKeys.includes(keyValue);
                const isNonTypeable = nonTypeableKeys.includes(keyValue);
                const isNumberKey = numberKeys.includes(keyValue);

                let shouldDim = false;

                // Always dim non-typeable keys (tab, enter, backspace)
                if (isNonTypeable) {
                    shouldDim = true;
                }
                // Dim number keys if disabled
                else if (!includeNumbers && isNumberKey && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }
                // Dim special chars if disabled
                else if (!includeSpecialChars && isSpecialChar && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }
                // Dim caps/shift keys if capitals are disabled
                else if (!useCapitals && isCapitalKey && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }

                // Apply or reset visual state
                if (shouldDim) {
                    key.style.opacity = '0.3';
                    key.style.filter = 'grayscale(70%)';
                } else {
                    key.style.opacity = '';
                    key.style.filter = '';
                }
            });
        }

        function updateSelectedKeysList() {
            if (selectedKeys.size === 0) {
                selectedKeysList.textContent = 'None - Click keys above or use finger shortcuts';
                generateBtn.disabled = true;
                restartBtn.disabled = true;
                targetText.innerHTML = 'Select keys above to generate practice text';
                typingInput.disabled = true;
                typingInput.value = '';
            } else {
                const nonTypeableKeys = ['tab', 'caps', 'shift', 'shift-right', 'enter', 'backspace'];
                let typeableKeys = Array.from(selectedKeys).filter(k => !nonTypeableKeys.includes(k));

                // Filter out space from display (it's always available anyway)
                typeableKeys = typeableKeys.filter(k => k !== ' ');

                // Filter out numbers if setting is disabled
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                if (!includeNumbers) {
                    typeableKeys = typeableKeys.filter(k => !numberKeys.includes(k));
                }

                // Filter out special chars if setting is disabled
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                if (!includeSpecialChars) {
                    typeableKeys = typeableKeys.filter(k => !specialChars.includes(k));
                }

                const keysArray = typeableKeys.map(k => k.toUpperCase());
                selectedKeysList.textContent = keysArray.length > 0 ? keysArray.join(', ') : 'Only disabled keys selected - enable Numbers/Special Chars to use them';
                generateBtn.disabled = typeableKeys.length === 0;
                restartBtn.disabled = typeableKeys.length === 0;

                // Auto-generate practice text when keys are selected
                if (typeableKeys.length > 0) {
                    generatePracticeText();
                }
            }

            // Update placeholder card keys display
            updatePlaceholderKeys();
        }

        function restartTest() {
            if (!currentText) return;

            // Save stats for the current session before restarting (especially important for infinite mode)
            if (startTime && currentPosition > 0) {
                const finalWPM = calculateWPM();
                const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
                saveSessionStats(finalWPM, finalAccuracy);
            }

            currentPosition = 0;
            errorCount = 0;
            totalTyped = 0;
            startTime = null;
            lastWpmUpdate = 0;
            errorPositions.clear();

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            if (isTimedMode) {
                timeRemaining.textContent = timeLimit + 's';
                timerDisplay.classList.remove('warning', 'danger');
            }

            renderText();
            updateStats();

            typingInput.value = '';
            typingInput.disabled = false;
            showOverlay();
        }

        function startTimer() {
            if (!isTimedMode) return;

            let elapsed = 0;
            timerInterval = setInterval(() => {
                elapsed++;
                const remaining = timeLimit - elapsed;
                timeRemaining.textContent = remaining + 's';

                if (remaining <= 10 && remaining > 5) {
                    timerDisplay.classList.add('warning');
                    timerDisplay.classList.remove('danger');
                } else if (remaining <= 5) {
                    timerDisplay.classList.add('danger');
                    timerDisplay.classList.remove('warning');
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    endTest();
                }
            }, 1000);
        }

        function endTest() {
            typingInput.disabled = true;
            const finalWPM = calculateWPM();
            const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);

            // Save session stats
            saveSessionStats(finalWPM, finalAccuracy);

            setTimeout(() => {
                showCompletionTooltip(finalWPM, finalAccuracy, errorCount);
            }, 100);
        }

        function calculateWPM() {
            if (!startTime) return 0;
            const timeElapsed = (Date.now() - startTime) / 1000 / 60; // minutes
            const wordsTyped = currentPosition / 5; // standard: 5 characters = 1 word
            return Math.round(wordsTyped / timeElapsed) || 0;
        }

        function getFilteredKeys() {
            // Filter out non-typeable keys
            const nonTypeableKeys = ['tab', 'caps', 'shift', 'shift-right', 'enter', 'backspace'];
            let keysArray = Array.from(selectedKeys).filter(key => !nonTypeableKeys.includes(key));

            // Filter out numbers if setting is disabled
            if (!includeNumbers) {
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                keysArray = keysArray.filter(key => !numberKeys.includes(key));
            }

            // Filter out special characters if setting is disabled
            if (!includeSpecialChars) {
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                keysArray = keysArray.filter(key => !specialChars.includes(key));
            }

            // Include space if enabled
            if (includeSpaces && !keysArray.includes(' ')) {
                keysArray.push(' ');
            }

            return keysArray;
        }

        function getFilteredRealWords(keysArray) {
            // Filter real words to only include words that can be typed with selected keys
            const keySet = new Set(keysArray);
            return realWords.filter(word => {
                // Check if all characters in the word are available in selected keys
                for (let char of word) {
                    if (!keySet.has(char.toLowerCase())) {
                        return false;
                    }
                }
                return true;
            });
        }

        function capitalizeWord(word) {
            if (word.length === 0) return word;
            return word.charAt(0).toUpperCase() + word.slice(1);
        }

        function applyCapitalization(text) {
            if (!useCapitals) return text;

            // Determine which shift keys are selected
            const hasLeftShift = selectedKeys.has('shift');
            const hasRightShift = selectedKeys.has('shift-right');

            // Define which letters belong to which hand
            const leftHandLetters = ['q', 'w', 'e', 'r', 't', 'a', 's', 'd', 'f', 'g', 'z', 'x', 'c', 'v', 'b', '1', '2', '3', '4', '5'];
            const rightHandLetters = ['y', 'u', 'i', 'o', 'p', 'h', 'j', 'k', 'l', 'n', 'm', '6', '7', '8', '9', '0'];

            const words = text.split(' ');
            let wordsSinceCapital = 0;

            for (let i = 0; i < words.length; i++) {
                // Capitalize first word, or randomly every 8-12 words (simulating sentences)
                if (i === 0 || (wordsSinceCapital >= 8 && Math.random() < 0.3)) {
                    // Capitalize word based on shift selection
                    if (hasLeftShift && hasRightShift) {
                        // Both shifts: capitalize all
                        words[i] = capitalizeWord(words[i]);
                    } else if (hasRightShift) {
                        // Right shift: capitalize left hand letters only
                        words[i] = capitalizeWordSelective(words[i], leftHandLetters);
                    } else if (hasLeftShift) {
                        // Left shift: capitalize right hand letters only
                        words[i] = capitalizeWordSelective(words[i], rightHandLetters);
                    } else {
                        // No shift selected, use regular capitalization
                        words[i] = capitalizeWord(words[i]);
                    }
                    wordsSinceCapital = 0;
                } else {
                    wordsSinceCapital++;
                }
            }

            return words.join(' ');
        }

        function capitalizeWordSelective(word, allowedLetters) {
            // Only capitalize letters that are in the allowed set
            return word.split('').map(char => {
                if (allowedLetters.includes(char.toLowerCase())) {
                    return char.toUpperCase();
                }
                return char;
            }).join('');
        }

        function generateGibberishText(keysArray, numWords) {
            // Separate letters, numbers, and special characters
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const letters = keysArray.filter(key => !specialChars.includes(key) && !numbers.includes(key));
            const availableSpecials = keysArray.filter(key => specialChars.includes(key));
            const availableNumbers = keysArray.filter(key => numbers.includes(key));

            let text = '';
            for (let i = 0; i < numWords; i++) {
                const wordLength = Math.floor(Math.random() * 7) + 2; // Random length between 2-8 characters

                // Generate word primarily from letters
                const useLettersForWord = letters.length > 0;
                const sourceArray = useLettersForWord ? letters : keysArray;

                for (let j = 0; j < wordLength; j++) {
                    const randomKey = sourceArray[Math.floor(Math.random() * sourceArray.length)];
                    text += randomKey;
                }

                // Add numbers within or after words if selected
                if (includeNumbers && availableNumbers.length > 0 && Math.random() < 0.4) {
                    const numLength = Math.floor(Math.random() * 3) + 1; // 1-3 digits
                    for (let k = 0; k < numLength; k++) {
                        const randomNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                        text += randomNum;
                    }
                }

                // Add special characters at word boundaries if enabled
                if (includeSpecialChars && availableSpecials.length > 0 && Math.random() < 0.3) {
                    const randomSpecial = availableSpecials[Math.floor(Math.random() * availableSpecials.length)];
                    text += randomSpecial;
                }

                if (i < numWords - 1 && includeSpaces) text += ' ';
            }
            return useCapitals ? applyCapitalization(text) : text;
        }

        function generateRealWordsText(keysArray, numWords) {
            const availableWords = getFilteredRealWords(keysArray);

            if (availableWords.length === 0) {
                // Fall back to gibberish if no real words available
                return generateGibberishText(keysArray, numWords);
            }

            // Get available special characters and numbers
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const availableSpecials = keysArray.filter(key => specialChars.includes(key));
            const availableNumbers = keysArray.filter(key => numbers.includes(key));
            const punctuation = availableSpecials.filter(char => [',', '.', '!', '?', ';', ':'].includes(char));

            let text = '';
            for (let i = 0; i < numWords; i++) {
                let word = availableWords[Math.floor(Math.random() * availableWords.length)];

                // Force lowercase if capitals are disabled
                if (!useCapitals) {
                    word = word.toLowerCase();
                }

                text += word;

                // Add numbers after words if selected
                if (includeNumbers && availableNumbers.length > 0 && Math.random() < 0.3) {
                    const numLength = Math.floor(Math.random() * 3) + 1; // 1-3 digits
                    for (let k = 0; k < numLength; k++) {
                        const randomNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                        text += randomNum;
                    }
                }

                // Add punctuation occasionally if special chars are enabled
                if (includeSpecialChars && punctuation.length > 0 && Math.random() < 0.2) {
                    const randomPunct = punctuation[Math.floor(Math.random() * punctuation.length)];
                    text += randomPunct;
                }

                // Add other special characters occasionally
                if (includeSpecialChars && availableSpecials.length > 0 && Math.random() < 0.15) {
                    const randomSpecial = availableSpecials[Math.floor(Math.random() * availableSpecials.length)];
                    text += randomSpecial;
                }

                if (i < numWords - 1 && includeSpaces) text += ' ';
            }
            return useCapitals ? applyCapitalization(text) : text;
        }

        function appendMoreText() {
            // Append more words to the current text for unlimited mode
            const keysArray = getFilteredKeys();
            if (keysArray.length === 0) return;

            const numWords = 50; // Add 50 more words at a time
            let newText = includeSpaces ? ' ' : ''; // Add space before new words if enabled

            if (useRealWords) {
                newText += generateRealWordsText(keysArray, numWords);
            } else {
                newText += generateGibberishText(keysArray, numWords);
            }

            // Remove any double spaces
            newText = newText.replace(/\s+/g, ' ');

            currentText += newText;
            renderText();
        }

        function generatePracticeText() {
            if (selectedKeys.size === 0) return;

            // Save stats for the current session before generating new exercise
            if (startTime && currentPosition > 0) {
                const finalWPM = calculateWPM();
                const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
                saveSessionStats(finalWPM, finalAccuracy);
            }

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const keysArray = getFilteredKeys();

            if (keysArray.length === 0) {
                showModal('Please select some typeable keys (letters, numbers, symbols)');
                return;
            }

            // Generate more words for timed/unlimited modes
            const numWords = isUnlimitedMode ? 200 : (isTimedMode ? 100 : wordCount);

            let text = '';
            if (useRealWords) {
                text = generateRealWordsText(keysArray, numWords);
            } else {
                text = generateGibberishText(keysArray, numWords);
            }

            // Remove any double spaces
            text = text.replace(/\s+/g, ' ').trim();

            currentText = text;
            currentPosition = 0;
            errorCount = 0;
            totalTyped = 0;
            startTime = null;
            lastWpmUpdate = 0;
            errorPositions.clear();

            // Setup timer display
            if (isTimedMode) {
                timerDisplay.style.display = 'block';
                timeRemaining.textContent = timeLimit + 's';
                timerDisplay.classList.remove('warning', 'danger');
            } else {
                timerDisplay.style.display = 'none';
            }

            renderText();
            updateStats();

            typingInput.value = '';
            typingInput.disabled = false;
            showOverlay();
        }

        function renderText() {
            let html = '';
            let i = 0;

            while (i < currentText.length) {
                // Start a word wrapper
                html += '<span class="word-wrapper">';

                // Collect all characters until we hit a space or end of text
                while (i < currentText.length && currentText[i] !== ' ') {
                    const char = currentText[i];
                    let className = '';
                    let displayChar = char;

                    if (i < currentPosition) {
                        if (errorPositions.has(i)) {
                            className = 'incorrect';
                            const typedChar = errorPositions.get(i);
                            displayChar = `<span class="error-typed">${typedChar}</span>${char}`;
                        } else {
                            className = 'correct';
                        }
                    } else if (i === currentPosition) {
                        className = 'current';
                    } else {
                        className = 'upcoming';
                    }

                    html += `<span class="${className}" data-index="${i}">${displayChar}</span>`;
                    i++;
                }

                html += '</span>';

                // Handle space if present
                if (i < currentText.length && currentText[i] === ' ') {
                    let className = '';
                    if (i < currentPosition) {
                        className = errorPositions.has(i) ? 'incorrect' : 'correct';
                    } else if (i === currentPosition) {
                        className = 'current';
                    } else {
                        className = 'upcoming';
                    }
                    className += ' space-char';

                    html += `<span class="${className}" data-index="${i}"> </span>`;
                    i++;
                }
            }

            targetText.innerHTML = html;

            // Auto-scroll to keep current character visible
            setTimeout(() => {
                const currentSpan = targetText.querySelector('.current');
                if (currentSpan) {
                    const container = targetText;
                    const spanTop = currentSpan.offsetTop;
                    const spanHeight = currentSpan.offsetHeight;
                    const containerHeight = container.clientHeight;
                    const scrollTop = container.scrollTop;

                    // In unlimited mode, keep current line in the top 1/3 of the visible area
                    // This ensures you can always see plenty of upcoming text
                    const targetScrollPosition = spanTop - containerHeight * 0.25;

                    // Scroll if current character is outside the comfortable viewing area
                    if (spanTop < scrollTop + spanHeight ||
                        spanTop > scrollTop + containerHeight * 0.6) {
                        container.scrollTop = Math.max(0, targetScrollPosition);
                    }
                }
            }, 0);
        }

        function updateStats() {
            const accuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
            accuracyEl.textContent = accuracy + '%';
            progressEl.textContent = `${currentPosition}/${currentText.length}`;
            errorsEl.textContent = errorCount;

            // Update WPM only every 5 seconds
            const now = Date.now();
            if (now - lastWpmUpdate >= 5000) {
                const wpm = calculateWPM();
                wpmEl.textContent = wpm;
                lastWpmUpdate = now;
            }

            // Update time elapsed
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeElapsedEl.textContent = elapsed + 's';
            } else {
                timeElapsedEl.textContent = '0s';
            }

            // Update progress bar
            let progressPercent = 0;
            if (isTimedMode && startTime) {
                // In timed mode, show time progress
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                progressPercent = Math.min((elapsed / timeLimit) * 100, 100);
            } else {
                // In word/unlimited mode, show typing progress
                progressPercent = currentText.length > 0 ? (currentPosition / currentText.length) * 100 : 0;
            }
            progressBar.style.width = progressPercent + '%';
        }

        typingInput.addEventListener('input', (e) => {
            const typedValue = e.target.value;
            const typedChar = typedValue[typedValue.length - 1];

            // Start timer on first keystroke
            if (!startTime && typedValue.length === 1) {
                startTime = Date.now();
                if (isTimedMode) {
                    startTimer();
                }
            }

            if (typedValue.length > currentPosition) {
                totalTyped++;

                if (typedChar === currentText[currentPosition]) {
                    // Correct character typed
                    playCorrectSound();
                    flashKey(typedChar, true);

                    // If this position was previously an error, remove it
                    if (errorPositions.has(currentPosition)) {
                        errorPositions.delete(currentPosition);
                    }
                    currentPosition++;

                    // In unlimited mode, append more text when getting close to the end
                    if (isUnlimitedMode && currentPosition > currentText.length - 100) {
                        appendMoreText();
                    }

                    if (currentPosition === currentText.length) {
                        // Completed!
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }

                        if (isUnlimitedMode) {
                            // Unlimited mode - just append more text
                            appendMoreText();
                        } else if (!isTimedMode) {
                            // Word count mode - save stats and auto-generate new exercise
                            const finalWPM = calculateWPM();
                            const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
                            saveSessionStats(finalWPM, finalAccuracy);

                            setTimeout(() => {
                                generatePracticeText();
                            }, 500);
                        } else {
                            // Timed mode - show completion message
                            typingInput.disabled = true;
                            const finalWPM = calculateWPM();
                            const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);

                            // Save session stats
                            saveSessionStats(finalWPM, finalAccuracy);

                            setTimeout(() => {
                                showCompletionTooltip(finalWPM, finalAccuracy, errorCount);
                            }, 100);
                        }
                    }
                } else {
                    errorCount++;

                    // Play error feedback
                    playErrorSound();
                    flashKey(currentText[currentPosition], false);

                    // Track which key had the error
                    const expectedKey = currentText[currentPosition].toLowerCase();
                    if (!sessionKeyErrors[expectedKey]) {
                        sessionKeyErrors[expectedKey] = 0;
                    }
                    sessionKeyErrors[expectedKey]++;

                    // Handle different error modes
                    if (errorMode === 'block') {
                        // Block mode: Don't advance position, remove incorrect character
                        e.target.value = typedValue.slice(0, -1);
                    } else if (errorMode === 'backspace') {
                        // Backspace mode: Mark as error, allow backspace to correct
                        errorPositions.set(currentPosition, typedChar);
                        currentPosition++;
                    }
                }

                renderText();
                updateStats();
            }
        });

        // Handle backspace for backspace error mode
        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && errorMode === 'backspace') {
                const typedValue = e.target.value;
                if (typedValue.length < currentPosition && currentPosition > 0) {
                    // Allow going back
                    currentPosition--;
                    // Remove from error positions if correcting
                    errorPositions.delete(currentPosition);
                    renderText();
                    updateStats();
                }
            }
        });

        generateBtn.addEventListener('click', generatePracticeText);
        restartBtn.addEventListener('click', restartTest);
        saveSettingsBtn.addEventListener('click', () => {
            saveSettings();
            hideSaveButton();
        });

        // Click on target text to focus input and start typing
        targetText.addEventListener('click', () => {
            if (!typingInput.disabled) {
                typingInput.focus();
            }
        });

        // Make the entire practice area focusable - click anywhere to start typing
        document.addEventListener('click', (e) => {
            // Only auto-focus if we have text and input is enabled
            if (currentText && !typingInput.disabled && !e.target.closest('button') && !e.target.closest('input') && !e.target.closest('.key') && !e.target.closest('.finger-btn')) {
                typingInput.focus();
            }
        });

        // Update stats continuously for real-time WPM and time display
        setInterval(() => {
            if (startTime && !typingInput.disabled) {
                updateStats();
            }
        }, 100);

        // Settings Dropdown
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        // Stats Modal
        const statsModal = document.getElementById('statsModal');
        const statsBtn = document.getElementById('statsBtn');
        const statsClose = document.getElementById('statsClose');
        const resetStatsBtn = document.getElementById('resetStatsBtn');

        statsBtn.addEventListener('click', () => {
            displayStats();
            statsModal.classList.add('show');
        });

        statsClose.addEventListener('click', () => {
            statsModal.classList.remove('show');
        });

        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) {
                statsModal.classList.remove('show');
            }
        });

        resetStatsBtn.addEventListener('click', () => {
            resetStats();
        });

        // Lessons Sidebar
        const lessonsSidebar = document.getElementById('lessonsSidebar');
        const lessonsToggle = document.getElementById('lessonsToggle');
        const sidebarClose = document.getElementById('sidebarClose');

        function openLessonsSidebar() {
            lessonsSidebar.classList.add('open');
        }

        function closeLessonsSidebar() {
            lessonsSidebar.classList.remove('open');
        }

        function toggleLessonsSidebar() {
            lessonsSidebar.classList.toggle('open');

            // Toggle active course title visibility
            const activeCourseTitle = document.getElementById('activeCourseTitle');
            if (activeCourseTitle) {
                activeCourseTitle.classList.toggle('hidden');
            }
        }

        lessonsToggle.addEventListener('click', toggleLessonsSidebar);
        sidebarClose.addEventListener('click', closeLessonsSidebar);

        // Close sidebar on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lessonsSidebar.classList.contains('open')) {
                closeLessonsSidebar();
            }
        });

        // Focus Mode
        const focusToggle = document.getElementById('focusToggle');
        const focusHint = document.querySelector('.focus-hint');
        let isFocusMode = false;
        let focusHintTimeout = null;

        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            document.body.classList.toggle('focus-mode', isFocusMode);
            focusToggle.checked = isFocusMode;

            // Clear any existing timeout
            if (focusHintTimeout) {
                clearTimeout(focusHintTimeout);
                focusHintTimeout = null;
            }

            if (isFocusMode) {
                // Show the hint and hide it after 3 seconds
                focusHint.classList.remove('hidden');
                focusHintTimeout = setTimeout(() => {
                    focusHint.classList.add('hidden');
                }, 3000);
            } else {
                // Remove the hidden class when exiting focus mode
                focusHint.classList.remove('hidden');
            }
        }

        focusToggle.addEventListener('change', () => {
            toggleFocusMode();
        });

        // Reset Button
        const resetBtn = document.getElementById('resetBtn');
        resetBtn.addEventListener('click', () => {
            if (confirm('Reset all settings? This will clear your saved preferences and selected keys, then refresh the page.')) {
                localStorage.clear();
                location.reload();
            }
        });

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        // Default to dark mode if not set in localStorage
        let isDarkMode = localStorage.getItem('darkMode') !== null
            ? localStorage.getItem('darkMode') === 'true'
            : true;

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            darkModeToggle.checked = isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Initialize dark mode
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        }

        darkModeToggle.addEventListener('change', () => {
            toggleDarkMode();
        });

        // Sound Feedback Toggle
        const soundFeedbackToggle = document.getElementById('soundFeedbackToggle');
        soundFeedbackToggle.addEventListener('change', () => {
            soundFeedbackEnabled = soundFeedbackToggle.checked;
            showSaveButton();
        });

        // Sound Type Cycle Button
        const soundTypes = ['classic', 'mechanical', 'soft', 'minimal'];
        const soundTypeLabels = {
            'classic': 'Classic',
            'mechanical': 'Mechanical',
            'soft': 'Soft',
            'minimal': 'Minimal'
        };

        window.cycleSoundType = function() {
            const currentIndex = soundTypes.indexOf(soundType);
            const nextIndex = (currentIndex + 1) % soundTypes.length;
            soundType = soundTypes[nextIndex];

            const btn = document.getElementById('soundTypeCycle');
            if (btn) {
                btn.textContent = soundTypeLabels[soundType];
            }

            // Play a preview of the selected sound
            playCorrectSound();

            showSaveButton();
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape - Toggle focus mode
            if (e.key === 'Escape') {
                e.preventDefault();
                if (isFocusMode) {
                    toggleFocusMode();
                }
            }

            // Tab+Enter or Shift+Enter - Restart test
            if ((e.shiftKey || e.key === 'Tab') && e.key === 'Enter') {
                e.preventDefault();
                if (!restartBtn.disabled) {
                    restartTest();
                }
            }

            // Enter after Tab - Restart test
            if (e.key === 'Enter' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                const activeEl = document.activeElement;
                // Check if Tab was pressed recently (within 500ms)
                if (window.lastTabPress && Date.now() - window.lastTabPress < 500) {
                    e.preventDefault();
                    if (!restartBtn.disabled) {
                        restartTest();
                    }
                }
            }

            // Track Tab key press
            if (e.key === 'Tab') {
                window.lastTabPress = Date.now();
            }

            // Cmd+N (Mac) or Alt+N (Windows) - Generate new exercise
            if ((e.metaKey || e.altKey) && e.key === 'n') {
                e.preventDefault();
                if (!generateBtn.disabled) {
                    generatePracticeText();
                }
            }

            // Cmd+K (Mac) or Alt+K (Windows) - Focus input and scroll to practice area
            if ((e.metaKey || e.altKey) && e.key === 'k') {
                e.preventDefault();
                if (!typingInput.disabled) {
                    // Scroll to practice area
                    const practiceArea = document.querySelector('.practice-area');
                    if (practiceArea) {
                        practiceArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    // Focus input after a short delay to ensure scroll completes
                    setTimeout(() => {
                        typingInput.focus();
                    }, 100);
                }
            }
        });

        // Prevent backspace in typing input
        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                e.preventDefault();
            }
        });

        // Typing Overlay
        const typingOverlay = document.getElementById('typingOverlay');

        function hideOverlay() {
            if (typingOverlay && !typingOverlay.classList.contains('hidden')) {
                typingOverlay.classList.add('hidden');
                if (!typingInput.disabled) {
                    typingInput.focus();
                }
            }
        }

        function showOverlay() {
            if (typingOverlay && currentText) {
                typingOverlay.classList.remove('hidden');
            }
        }

        // Hide overlay on click
        if (typingOverlay) {
            typingOverlay.addEventListener('click', hideOverlay);
        }

        // Hide overlay on any keypress
        document.addEventListener('keydown', (e) => {
            if (typingOverlay && !typingOverlay.classList.contains('hidden') && currentText) {
                // Don't hide for modifier keys only
                if (!['Shift', 'Control', 'Alt', 'Meta'].includes(e.key)) {
                    hideOverlay();
                }
            }
        });

        // Custom Modal
        const customModal = document.getElementById('customModal');
        const modalBody = document.getElementById('modalBody');
        const modalBtn = document.getElementById('modalBtn');

        function showModal(message) {
            // Check if message contains HTML
            if (message.includes('<')) {
                modalBody.innerHTML = message;
            } else {
                modalBody.textContent = message;
            }
            customModal.classList.add('show');
        }

        function hideModal() {
            customModal.classList.remove('show');
        }

        function showCompletionTooltip(wpm, accuracy, errors) {
            const tooltip = document.getElementById('completionTooltip');
            if (!tooltip) return;

            // Create stats HTML with title
            tooltip.innerHTML = `
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #e2b714;">
                    âœ“ Session Complete
                </div>
                <div class="stats-line">
                    <span class="stat-label">WPM:</span>
                    <span class="stat-value">${wpm}</span>
                </div>
                <div class="stats-line">
                    <span class="stat-label">Accuracy:</span>
                    <span class="stat-value">${accuracy}%</span>
                </div>
                <div class="stats-line">
                    <span class="stat-label">Errors:</span>
                    <span class="stat-value">${errors}</span>
                </div>
                <div style="font-size: 11px; margin-top: 12px; opacity: 0.6; text-align: center;">
                    Press Shift+Enter to restart
                </div>
            `;

            // Position in center of viewport
            tooltip.style.left = '50%';
            tooltip.style.top = '40%';
            tooltip.style.transform = 'translateX(-50%) translateY(-50%) translateY(10px) scale(0.95)';

            // Show tooltip
            setTimeout(() => {
                tooltip.classList.add('show');
            }, 10);

            // Hide after 5 seconds
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 5000);
        }

        // Close modal on button click
        if (modalBtn) {
            modalBtn.addEventListener('click', hideModal);
        }

        // Close modal on backdrop click
        if (customModal) {
            customModal.addEventListener('click', (e) => {
                if (e.target === customModal) {
                    hideModal();
                }
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && customModal.classList.contains('show')) {
                hideModal();
            }
        });

        // Close modal on Enter key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && customModal.classList.contains('show')) {
                hideModal();
            }
        });

        // Save button visibility
        function showSaveButton() {
            saveSettingsBtn.classList.add('visible');
        }

        function hideSaveButton() {
            saveSettingsBtn.classList.remove('visible');
        }

        // LocalStorage functions
        function saveSettings() {
            const settings = {
                mode: isTimedMode ? 'timed' : (isUnlimitedMode ? 'unlimited' : 'words'),
                wordCount: wordCount,
                timeLimit: timeLimit,
                includeNumbers: includeNumbers,
                useRealWords: useRealWords,
                includeCapitals: useCapitals,
                includeSpecialChars: includeSpecialChars,
                includeSpaces: includeSpaces,
                errorMode: errorMode,
                wordBankSize: wordBankSize,
                fontSize: fontSize,
                soundFeedbackEnabled: soundFeedbackEnabled,
                soundType: soundType,
                selectedKeys: Array.from(selectedKeys)
            };
            localStorage.setItem('typingPracticeSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('typingPracticeSettings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                // Apply mode settings
                if (settings.mode === 'timed') {
                    isTimedMode = true;
                    isUnlimitedMode = false;
                    modeTimed.checked = true;
                } else if (settings.mode === 'unlimited') {
                    isTimedMode = false;
                    isUnlimitedMode = true;
                    modeUnlimited.checked = true;
                } else {
                    isTimedMode = false;
                    isUnlimitedMode = false;
                    modeWords.checked = true;
                }

                // Apply word count
                if (settings.wordCount !== undefined) {
                    wordCount = settings.wordCount;
                    const wordCountRadio = document.getElementById(`wordCount${settings.wordCount}`);
                    if (wordCountRadio) wordCountRadio.checked = true;
                }

                // Apply time limit
                if (settings.timeLimit !== undefined) {
                    timeLimit = settings.timeLimit;
                    const timeLimitRadio = document.getElementById(`time${settings.timeLimit}`);
                    if (timeLimitRadio) timeLimitRadio.checked = true;
                }

                // Apply toggles
                if (settings.includeNumbers !== undefined) {
                    includeNumbers = settings.includeNumbers;
                    includeNumbersCheckbox.checked = settings.includeNumbers;
                }

                if (settings.useRealWords !== undefined) {
                    useRealWords = settings.useRealWords;
                    if (settings.useRealWords) {
                        wordSetReal.checked = true;
                    } else {
                        wordSetGibberish.checked = true;
                    }
                }

                if (settings.includeCapitals !== undefined) {
                    includeCapitals = settings.includeCapitals;
                    includeCapitalsCheckbox.checked = settings.includeCapitals;
                }

                if (settings.includeSpecialChars !== undefined) {
                    includeSpecialChars = settings.includeSpecialChars;
                    includeSpecialCharsCheckbox.checked = settings.includeSpecialChars;
                }

                if (settings.includeSpaces !== undefined) {
                    includeSpaces = settings.includeSpaces;
                    document.getElementById('includeSpaces').checked = settings.includeSpaces;
                }

                // Apply error mode
                if (settings.errorMode !== undefined) {
                    errorMode = settings.errorMode;
                    if (settings.errorMode === 'backspace') {
                        errorModeBackspace.checked = true;
                    } else {
                        errorModeBlock.checked = true;
                    }
                }

                // Apply word bank size
                if (settings.wordBankSize !== undefined) {
                    wordBankSize = settings.wordBankSize;
                    const wordBankRadio = document.getElementById(`wordBank${settings.wordBankSize}`);
                    if (wordBankRadio) wordBankRadio.checked = true;
                }

                // Apply font size
                if (settings.fontSize !== undefined) {
                    fontSize = settings.fontSize;
                    const fontSizeRadio = document.getElementById(`fontSize${settings.fontSize.charAt(0).toUpperCase() + settings.fontSize.slice(1)}`);
                    if (fontSizeRadio) fontSizeRadio.checked = true;
                    // Remove all font size classes and add the selected one
                    targetText.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                    targetText.classList.add(`font-${fontSize}`);
                }

                // Apply sound feedback setting
                if (settings.soundFeedbackEnabled !== undefined) {
                    soundFeedbackEnabled = settings.soundFeedbackEnabled;
                    document.getElementById('soundFeedbackToggle').checked = settings.soundFeedbackEnabled;
                }

                // Apply sound type setting
                if (settings.soundType !== undefined) {
                    soundType = settings.soundType;
                    const btn = document.getElementById('soundTypeCycle');
                    if (btn) {
                        const labels = { 'classic': 'Classic', 'mechanical': 'Mechanical', 'soft': 'Soft', 'minimal': 'Minimal' };
                        btn.textContent = labels[settings.soundType] || 'Classic';
                    }
                }

                // Restore selected keys
                if (settings.selectedKeys && Array.isArray(settings.selectedKeys)) {
                    // Clear current selection
                    selectedKeys.clear();
                    document.querySelectorAll('.key.selected').forEach(key => {
                        key.classList.remove('selected');
                    });
                    document.querySelectorAll('.finger-btn.active').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Restore selected keys
                    settings.selectedKeys.forEach(key => {
                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });

                    // Activate finger buttons based on selected keys
                    const fingerBtns = document.querySelectorAll('.finger-btn');
                    fingerBtns.forEach(btn => {
                        const finger = btn.dataset.finger;
                        const fingerKeys = fingerMap[finger];
                        // Check if any key from this finger is selected
                        const hasSelectedKeys = fingerKeys.some(key => selectedKeys.has(key));
                        if (hasSelectedKeys) {
                            btn.classList.add('active');
                        }
                    });

                    // Update the selected keys list display
                    updateSelectedKeysList();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Stats Functions
        function loadStats() {
            const saved = localStorage.getItem('typingStats');
            if (saved) {
                try {
                    typingStats = JSON.parse(saved);
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
        }

        function saveStats() {
            localStorage.setItem('typingStats', JSON.stringify(typingStats));
        }

        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        }

        function calculateCurrentStreak() {
            if (!typingStats.practiceDates || typingStats.practiceDates.length === 0) {
                return 0;
            }

            // Sort dates in descending order (newest first)
            const sortedDates = [...new Set(typingStats.practiceDates)].sort((a, b) =>
                new Date(b) - new Date(a)
            );

            const today = getTodayDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // Check if user practiced today or yesterday
            const mostRecentDate = sortedDates[0];
            if (mostRecentDate !== today && mostRecentDate !== yesterdayStr) {
                return 0; // Streak broken
            }

            // Count consecutive days
            let streak = 0;
            let currentDate = new Date(mostRecentDate);

            for (const dateStr of sortedDates) {
                const expectedDateStr = currentDate.toISOString().split('T')[0];
                if (dateStr === expectedDateStr) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        function calculateLongestStreak() {
            if (!typingStats.practiceDates || typingStats.practiceDates.length === 0) {
                return 0;
            }

            // Get unique dates and sort ascending
            const sortedDates = [...new Set(typingStats.practiceDates)].sort((a, b) =>
                new Date(a) - new Date(b)
            );

            let longestStreak = 1;
            let currentStreak = 1;

            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = new Date(sortedDates[i - 1]);
                const currDate = new Date(sortedDates[i]);

                // Calculate day difference
                const diffTime = currDate - prevDate;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);

                if (diffDays === 1) {
                    // Consecutive day
                    currentStreak++;
                    longestStreak = Math.max(longestStreak, currentStreak);
                } else {
                    // Streak broken
                    currentStreak = 1;
                }
            }

            return longestStreak;
        }

        function saveSessionStats(wpm, accuracy) {
            if (!startTime) return; // No session to save

            const timeElapsed = (Date.now() - startTime) / 1000; // seconds

            // Update totals
            typingStats.totalSessions++;
            typingStats.totalCharactersTyped += currentPosition;
            typingStats.totalErrors += errorCount;
            typingStats.totalTimeSeconds += timeElapsed;

            // Update bests
            if (wpm > typingStats.bestWPM) {
                typingStats.bestWPM = wpm;
            }
            if (accuracy > typingStats.bestAccuracy) {
                typingStats.bestAccuracy = accuracy;
            }

            // Merge session key errors into global key error counts
            for (const [key, count] of Object.entries(sessionKeyErrors)) {
                if (!typingStats.keyErrorCounts[key]) {
                    typingStats.keyErrorCounts[key] = 0;
                }
                typingStats.keyErrorCounts[key] += count;
            }

            // Add to session history (keep last 100 sessions)
            typingStats.sessionHistory.push({
                date: new Date().toISOString(),
                wpm: wpm,
                accuracy: accuracy,
                characters: currentPosition,
                errors: errorCount,
                timeSeconds: timeElapsed
            });

            // Keep only last 100 sessions
            if (typingStats.sessionHistory.length > 100) {
                typingStats.sessionHistory = typingStats.sessionHistory.slice(-100);
            }

            // Track practice date for streaks
            const today = getTodayDateString();
            if (!typingStats.practiceDates) {
                typingStats.practiceDates = [];
            }
            if (!typingStats.practiceDates.includes(today)) {
                typingStats.practiceDates.push(today);
            }

            // Update longest streak
            const newLongest = calculateLongestStreak();
            if (newLongest > typingStats.longestStreak) {
                typingStats.longestStreak = newLongest;
            }

            // Reset session tracking
            sessionKeyErrors = {};

            // Update course stats if in a course
            updateCourseStats(wpm, accuracy);

            // Save to localStorage
            saveStats();
        }

        function displayStats() {
            const statsGrid = document.getElementById('statsGrid');
            const insightsContainer = document.getElementById('insightsContainer');
            const errorKeysList = document.getElementById('errorKeysList');

            // Calculate average stats
            const avgWPM = typingStats.sessionHistory.length > 0
                ? Math.round(typingStats.sessionHistory.reduce((sum, s) => sum + s.wpm, 0) / typingStats.sessionHistory.length)
                : 0;
            const avgAccuracy = typingStats.sessionHistory.length > 0
                ? Math.round(typingStats.sessionHistory.reduce((sum, s) => sum + s.accuracy, 0) / typingStats.sessionHistory.length)
                : 0;
            const totalHours = Math.floor(typingStats.totalTimeSeconds / 3600);
            const totalMinutes = Math.floor((typingStats.totalTimeSeconds % 3600) / 60);
            const currentStreak = calculateCurrentStreak();

            // Display main stats
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${typingStats.totalSessions}</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${typingStats.bestWPM}</div>
                    <div class="stat-label">Best WPM</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${typingStats.bestAccuracy}%</div>
                    <div class="stat-label">Best Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgWPM}</div>
                    <div class="stat-label">Avg WPM</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgAccuracy}%</div>
                    <div class="stat-label">Avg Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${typingStats.totalCharactersTyped.toLocaleString()}</div>
                    <div class="stat-label">Chars Typed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${typingStats.totalErrors.toLocaleString()}</div>
                    <div class="stat-label">Total Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalHours}h ${totalMinutes}m</div>
                    <div class="stat-label">Time Spent</div>
                </div>
            `;

            // Display streaks
            const streaksContainer = document.getElementById('streaksContainer');
            let streakMessage = '';

            if (currentStreak === 0) {
                streakMessage = 'Start your streak today!';
            } else if (currentStreak === 1) {
                streakMessage = 'Great start! Come back tomorrow!';
            } else if (currentStreak < 7) {
                streakMessage = 'Keep going strong!';
            } else if (currentStreak < 30) {
                streakMessage = 'You\'re on fire!';
            } else {
                streakMessage = 'Legendary dedication!';
            }

            streaksContainer.innerHTML = `
                <div class="streak-card">
                    <span class="streak-icon">ðŸ”¥</span>
                    <div class="streak-value">${currentStreak}</div>
                    <div class="streak-label">Current Streak</div>
                    <div class="streak-message">${streakMessage}</div>
                </div>
                <div class="streak-card">
                    <span class="streak-icon">ðŸ†</span>
                    <div class="streak-value">${typingStats.longestStreak}</div>
                    <div class="streak-label">Longest Streak</div>
                    <div class="streak-message">${currentStreak === typingStats.longestStreak && currentStreak > 0 ? 'New record!' : 'Your best!'}</div>
                </div>
            `;

            // Generate insights
            const insights = generateInsights();
            if (insights.length > 0) {
                insightsContainer.innerHTML = insights.map(insight =>
                    `<div class="insight-card"><p>${insight}</p></div>`
                ).join('');
                document.getElementById('insightsSection').style.display = 'block';
            } else {
                document.getElementById('insightsSection').style.display = 'none';
            }

            // Display most frequent error keys
            const errorKeys = Object.entries(typingStats.keyErrorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (errorKeys.length > 0) {
                errorKeysList.innerHTML = errorKeys.map(([key, count]) => {
                    const displayKey = key === ' ' ? 'Space' : key.toUpperCase();
                    return `
                        <div class="error-key-item">
                            <span class="error-key-name">${displayKey}</span>
                            <span class="error-key-count">${count} errors</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('errorsSection').style.display = 'block';
            } else {
                document.getElementById('errorsSection').style.display = 'none';
            }

            // Render keyboard heatmap
            renderKeyboardHeatmap();
        }

        function renderKeyboardHeatmap() {
            const heatmapKeys = document.querySelectorAll('.heatmap-key');
            const errorCounts = typingStats.keyErrorCounts;

            // If no errors yet, hide the heatmap section
            if (Object.keys(errorCounts).length === 0) {
                document.getElementById('heatmapSection').style.display = 'none';
                return;
            }

            document.getElementById('heatmapSection').style.display = 'block';

            // Find the max error count for scaling
            const maxErrors = Math.max(...Object.values(errorCounts), 1);

            // Color each key based on error frequency
            heatmapKeys.forEach(keyElement => {
                const key = keyElement.getAttribute('data-key');
                const errorCount = errorCounts[key] || 0;

                // Reset previous styling
                keyElement.removeAttribute('data-error-level');
                keyElement.removeAttribute('data-error-count');

                if (errorCount > 0) {
                    // Calculate error level (1-7) based on percentage of max
                    const percentage = errorCount / maxErrors;
                    let errorLevel;
                    if (percentage < 0.15) errorLevel = 1;
                    else if (percentage < 0.3) errorLevel = 2;
                    else if (percentage < 0.45) errorLevel = 3;
                    else if (percentage < 0.6) errorLevel = 4;
                    else if (percentage < 0.75) errorLevel = 5;
                    else if (percentage < 0.9) errorLevel = 6;
                    else errorLevel = 7;

                    keyElement.setAttribute('data-error-level', errorLevel);
                    keyElement.setAttribute('data-error-count', errorCount);
                }
            });
        }

        function generateInsights() {
            const insights = [];

            if (typingStats.totalSessions === 0) {
                insights.push("Complete your first session to see personalized insights!");
                return insights;
            }

            // Improvement insights
            if (typingStats.sessionHistory.length >= 5) {
                const recent5 = typingStats.sessionHistory.slice(-5);
                const older5 = typingStats.sessionHistory.slice(-10, -5);
                if (older5.length === 5) {
                    const recentAvgWPM = recent5.reduce((sum, s) => sum + s.wpm, 0) / 5;
                    const olderAvgWPM = older5.reduce((sum, s) => sum + s.wpm, 0) / 5;
                    const improvement = ((recentAvgWPM - olderAvgWPM) / olderAvgWPM * 100).toFixed(1);

                    if (improvement > 5) {
                        insights.push(`ðŸš€ You're improving! Your WPM has increased by ${improvement}% in recent sessions.`);
                    } else if (improvement < -5) {
                        insights.push(`ðŸŽ¯ Your WPM has decreased by ${Math.abs(improvement)}% recently. Take a break or slow down to focus on accuracy.`);
                    } else {
                        insights.push(`ðŸ“Š Your typing speed is consistent. Keep practicing to push past plateaus!`);
                    }
                }
            }

            // Accuracy insight
            const avgAccuracy = typingStats.sessionHistory.length > 0
                ? typingStats.sessionHistory.reduce((sum, s) => sum + s.accuracy, 0) / typingStats.sessionHistory.length
                : 0;

            if (avgAccuracy < 90) {
                insights.push(`âš ï¸ Your average accuracy is ${avgAccuracy.toFixed(1)}%. Slow down and focus on accuracy before speed!`);
            } else if (avgAccuracy >= 95) {
                insights.push(`âœ¨ Excellent accuracy at ${avgAccuracy.toFixed(1)}%! You're a precision typist.`);
            }

            // Error patterns
            const topErrors = Object.entries(typingStats.keyErrorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            if (topErrors.length > 0) {
                const topKey = topErrors[0][0] === ' ' ? 'Space' : topErrors[0][0].toUpperCase();
                const errorRate = ((topErrors[0][1] / typingStats.totalCharactersTyped) * 100).toFixed(1);
                insights.push(`ðŸŽ¯ Your most problematic key is "${topKey}" with ${topErrors[0][1]} errors (${errorRate}% error rate). Practice words containing this key!`);
            }

            // Milestone celebrations
            if (typingStats.totalSessions === 10) {
                insights.push(`ðŸŽ‰ Milestone achieved! You've completed 10 sessions. Keep up the great work!`);
            } else if (typingStats.totalSessions === 50) {
                insights.push(`ðŸ† Amazing! 50 sessions completed. You're dedicated to improving your typing!`);
            } else if (typingStats.totalSessions === 100) {
                insights.push(`ðŸŒŸ Century club! 100 sessions completed. You're a typing champion!`);
            }

            // WPM milestones
            if (typingStats.bestWPM >= 100) {
                insights.push(`âš¡ You've reached ${typingStats.bestWPM} WPM! That's professional-level typing speed!`);
            } else if (typingStats.bestWPM >= 60) {
                insights.push(`ðŸ’ª Your best speed is ${typingStats.bestWPM} WPM. You're above average! Push to 80+ for expert level.`);
            }

            // Streak insights
            const currentStreak = calculateCurrentStreak();
            const today = getTodayDateString();
            const practicedToday = typingStats.practiceDates && typingStats.practiceDates.includes(today);

            if (currentStreak >= 30) {
                insights.push(`ðŸ”¥ Incredible! ${currentStreak}-day streak! You're a dedicated typing master!`);
            } else if (currentStreak >= 14) {
                insights.push(`ðŸ”¥ Amazing! ${currentStreak}-day streak! Two weeks of consistent practice!`);
            } else if (currentStreak >= 7) {
                insights.push(`ðŸ”¥ Great streak! ${currentStreak} days in a row! Keep the momentum going!`);
            } else if (currentStreak >= 3) {
                insights.push(`ðŸ”¥ Nice! ${currentStreak}-day streak. You're building a habit!`);
            } else if (currentStreak === 0 && !practicedToday) {
                insights.push(`ðŸ’¡ Your streak ended. Start a new one today by practicing!`);
            }

            // Longest streak achievement
            if (typingStats.longestStreak >= 30) {
                insights.push(`ðŸ‘‘ Your longest streak is ${typingStats.longestStreak} days! That's legendary consistency!`);
            } else if (typingStats.longestStreak >= 14) {
                insights.push(`ðŸ… Your longest streak is ${typingStats.longestStreak} days! Can you beat it?`);
            }

            // Streak motivation
            if (currentStreak > 0 && currentStreak === typingStats.longestStreak) {
                insights.push(`â­ You're on your longest streak ever! Keep going!`);
            }

            return insights;
        }

        function resetStats() {
            if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {
                typingStats = {
                    totalSessions: 0,
                    totalCharactersTyped: 0,
                    totalErrors: 0,
                    totalTimeSeconds: 0,
                    keyErrorCounts: {},
                    sessionHistory: [],
                    bestWPM: 0,
                    bestAccuracy: 0,
                    practiceDates: [],
                    longestStreak: 0
                };
                sessionKeyErrors = {};
                saveStats();
                displayStats();
            }
        }

        // Initialize settings display based on defaults
        function initializeSettingsDisplay() {
            // Set up display based on default mode (Infinited)
            if (isUnlimitedMode) {
                wordCountSetting.style.display = 'none';
                timeLimitSetting.style.display = 'none';
            } else if (isTimedMode) {
                wordCountSetting.style.display = 'none';
                timeLimitSetting.style.display = 'flex';
            } else {
                wordCountSetting.style.display = 'flex';
                timeLimitSetting.style.display = 'none';
            }
        }

        // Initialize: Auto-select all fingers on page load (only if no saved selection)
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize default font size
            targetText.classList.add('font-medium');

            // Load saved settings and stats
            loadSettings();
            loadStats();
            loadCourseStats();
            loadCustomCourses();

            // Initialize settings display based on loaded settings
            initializeSettingsDisplay();

            // Render lessons
            renderLessons();

            // Only auto-select all fingers if there are no saved keys
            if (selectedKeys.size === 0) {
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                const capitalKeys = ['caps', 'shift', 'shift-right'];

                fingerBtns.forEach(btn => {
                    const finger = btn.dataset.finger;
                    btn.classList.add('active');
                    fingerMap[finger].forEach(key => {
                        // Skip space - it's always available
                        if (key === ' ') return;
                        // Skip numbers if disabled
                        if (!includeNumbers && numberKeys.includes(key)) return;
                        // Skip special chars if disabled
                        if (!includeSpecialChars && specialChars.includes(key)) return;
                        // Skip caps/shift if capitals are disabled
                        if (!useCapitals && capitalKeys.includes(key)) return;

                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });
                });
                updateSelectedKeysList();
            }
        });
    </script>
</body>
</html>