<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better QWERTY - Improve Your Typing Skills</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f8f8;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
            border-radius: 0;
            padding: 48px 24px;
            box-shadow: none;
        }

        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 2.25em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .subtitle {
            text-align: center;
            color: #737373;
            margin-bottom: 40px;
            font-size: 1em;
            font-weight: 400;
        }

        .finger-selector {
            margin-bottom: 24px;
            padding: 20px 24px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .finger-buttons {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .hand-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hand-label {
            font-weight: 500;
            color: #525252;
            font-size: 0.875em;
            white-space: nowrap;
        }

        .fingers-visual {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }

        .keyboard {
            margin: 16px 0;
            padding: 32px;
            background: white;
            border-radius: 16px;
            width: 100%;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .keyboard-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            justify-content: center;
        }

        .keyboard-row:nth-child(2) {
            margin-left: 30px;
        }

        .keyboard-row:nth-child(3) {
            margin-left: 45px;
        }

        .keyboard-row:nth-child(4) {
            margin-left: 60px;
        }

        .key {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f8f8;
            border: 1.5px solid #ececec;
            border-radius: 10px;
            color: #525252;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            position: relative;
        }

        .key:hover {
            background: #f0f0f0;
            border-color: #e0e0e0;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .key.selected {
            background: white;
            border-color: #e2b714;
            border-width: 2px;
            color: #404040;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(226, 183, 20, 0.15);
        }

        .key.space {
            width: 350px;
            opacity: 0.6;
            cursor: default;
        }

        .key.space:hover {
            transform: none;
        }

        .key.tab {
            width: 80px;
        }

        .key.caps {
            width: 90px;
        }

        .key.shift-left {
            width: 105px;
        }

        .key.shift-right {
            width: 120px;
        }

        .key.backspace {
            width: 90px;
        }

        .key.enter {
            width: 100px;
        }

        .key-label {
            font-size: 0.7em;
            position: absolute;
            top: 5px;
            left: 8px;
            opacity: 0.6;
        }

        .key-main {
            font-size: 1.15em;
            margin-top: 10px;
        }

        .key.tab, .key.caps, .key.shift-left, .key.shift-right,
        .key.backspace, .key.enter {
            font-size: 0.75em;
            background: #efefef;
            color: #737373;
            font-weight: 500;
        }

        .key.tab:hover, .key.caps:hover, .key.shift-left:hover,
        .key.shift-right:hover, .key.backspace:hover, .key.enter:hover {
            background: #e5e5e5;
            color: #525252;
        }

        .key.tab.selected, .key.caps.selected, .key.shift-left.selected,
        .key.shift-right.selected, .key.backspace.selected, .key.enter.selected {
            background: white;
            border-color: #e2b714;
            border-width: 2px;
            color: #404040;
        }

        .key.home-row {
            position: relative;
        }

        .key.home-row::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #95a5a6;
            border-radius: 2px;
        }

        .key.home-row.selected::after {
            background: white;
        }

        /* Finger color coding - ONLY when selected */
        .key.selected[data-finger="left-pinky"] {
            background: #ec4899;
            border-color: #db2777;
            color: #831843;
        }

        .key.selected[data-finger="left-ring"] {
            background: #8b5cf6;
            border-color: #7c3aed;
            color: #4c1d95;
        }

        .key.selected[data-finger="left-middle"] {
            background: #3b82f6;
            border-color: #2563eb;
            color: #1e3a8a;
        }

        .key.selected[data-finger="left-index"] {
            background: #10b981;
            border-color: #059669;
            color: #064e3b;
        }

        .key.selected[data-finger="right-index"] {
            background: #e2b714;
            border-color: #d1a513;
            color: #78350f;
        }

        .key.selected[data-finger="right-middle"] {
            background: #ef4444;
            border-color: #dc2626;
            color: #7f1d1d;
        }

        .key.selected[data-finger="right-ring"] {
            background: #ec4899;
            border-color: #db2777;
            color: #831843;
        }

        .key.selected[data-finger="right-pinky"] {
            background: #8b5cf6;
            border-color: #7c3aed;
            color: #4c1d95;
        }

        .key.selected[data-finger] {
            transform: translateY(-2px);
            filter: none;
        }

        .key.selected[data-finger]:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        .key.selected[data-finger="left-pinky"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        .key.selected[data-finger="left-ring"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        .key.selected[data-finger="left-middle"]:hover {
            background: #60a5fa;
            border-color: #93c5fd;
        }

        .key.selected[data-finger="left-index"]:hover {
            background: #34d399;
            border-color: #6ee7b7;
        }

        .key.selected[data-finger="right-index"]:hover {
            background: #fbbf24;
            border-color: #fcd34d;
        }

        .key.selected[data-finger="right-middle"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        .key.selected[data-finger="right-ring"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        .key.selected[data-finger="right-pinky"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        .finger-btn {
            width: 28px;
            border: none;
            border-radius: 14px 14px 4px 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            overflow: visible;
        }

        .finger-visual {
            width: 100%;
            border-radius: 14px 14px 4px 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0;
            transition: all 0.15s ease;
            opacity: 0.85;
        }

        .finger-label {
            display: none;
        }

        /* Compact finger heights */
        .finger-btn[data-finger="left-pinky"] .finger-visual,
        .finger-btn[data-finger="right-pinky"] .finger-visual {
            height: 35px;
        }

        .finger-btn[data-finger="left-ring"] .finger-visual,
        .finger-btn[data-finger="right-ring"] .finger-visual {
            height: 45px;
        }

        .finger-btn[data-finger="left-middle"] .finger-visual,
        .finger-btn[data-finger="right-middle"] .finger-visual {
            height: 50px;
        }

        .finger-btn[data-finger="left-index"] .finger-visual,
        .finger-btn[data-finger="right-index"] .finger-visual {
            height: 42px;
        }

        /* Finger colors */
        .finger-btn[data-finger="left-pinky"] .finger-visual {
            background: #ec4899;
        }

        .finger-btn[data-finger="left-ring"] .finger-visual {
            background: #8b5cf6;
        }

        .finger-btn[data-finger="left-middle"] .finger-visual {
            background: #3b82f6;
        }

        .finger-btn[data-finger="left-index"] .finger-visual {
            background: #10b981;
        }

        .finger-btn[data-finger="right-index"] .finger-visual {
            background: #e2b714;
        }

        .finger-btn[data-finger="right-middle"] .finger-visual {
            background: #ef4444;
        }

        .finger-btn[data-finger="right-ring"] .finger-visual {
            background: #ec4899;
        }

        .finger-btn[data-finger="right-pinky"] .finger-visual {
            background: #8b5cf6;
        }

        .finger-btn:hover {
            transform: translateY(-1px);
        }

        .finger-btn:hover .finger-visual {
            opacity: 1;
        }

        .finger-btn.active {
            transform: translateY(-2px);
        }

        .finger-btn.active .finger-visual {
            opacity: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .finger-btn.active::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .selected-keys {
            text-align: center;
            margin: 24px 0;
            padding: 20px 24px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e8e8e8;
            font-size: 0.95em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .selected-keys strong {
            color: #262626;
            font-weight: 600;
        }

        .practice-area {
            margin-top: 48px;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .practice-area h2 {
            color: #737373;
            margin-bottom: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.7;
        }

        .target-text {
            font-size: 2.8em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            margin-bottom: 24px;
            transition: font-size 0.2s ease;
            padding: 0;
            padding-left: 2px;
            padding-right: 8px;
            background: transparent;
            border-radius: 0;
            line-height: 1.75;
            max-height: 25.2em;
            overflow-y: auto;
            overflow-x: hidden;
            letter-spacing: 0.01em;
            word-break: break-word;
            white-space: pre-wrap;
            text-align: left;
            color: #262626;
            font-weight: 400;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.08) transparent;
        }

        .target-text::-webkit-scrollbar {
            width: 6px;
        }

        .target-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .target-text::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .target-text::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .target-text.font-small {
            font-size: 1.8em;
        }

        .target-text.font-medium {
            font-size: 2.2em;
        }

        .target-text.font-large {
            font-size: 2.6em;
        }

        .target-text.font-xlarge {
            font-size: 3.0em;
        }

        .target-text span {
            transition: all 0.15s ease;
        }

        .target-text .correct {
            color: #2d3748;
            font-weight: 400;
            opacity: 1;
        }

        .target-text .error {
            color: #ef4444;
            font-weight: 400;
            background: #fef2f2;
            padding: 0 2px;
            border-radius: 2px;
        }

        .target-text .current {
            background: transparent;
            color: #a0aec0;
            font-weight: 400;
            opacity: 0.7;
            border-left: 3px solid #2d3748;
            padding-left: 2px;
            margin-left: -3px;
            border-radius: 0;
            animation: blink-cursor 1.2s ease-in-out infinite;
        }

        .target-text .upcoming {
            color: #a0aec0;
            font-weight: 400;
            opacity: 0.7;
        }

        /* Space character styling */
        .target-text .space-char {
            opacity: 0.4;
            font-size: 0.9em;
        }

        /* Word wrapper to prevent mid-word breaks */
        .word-wrapper {
            display: inline-block;
        }

        /* Error typed character display */
        .error-typed {
            position: absolute;
            top: -0.7em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            color: #ca4754;
            font-weight: 600;
            opacity: 0.9;
            text-decoration: line-through;
        }

        .target-text .incorrect {
            position: relative;
        }

        @keyframes blink-cursor {
            0%, 49% { border-left-color: #2d3748; }
            50%, 100% { border-left-color: transparent; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .practice-area {
            cursor: text;
        }

        .input-area {
            position: relative;
        }

        .typing-input {
            position: fixed;
            top: -100px;
            left: -100px;
            opacity: 0;
            pointer-events: none;
            width: 1px;
            height: 1px;
            border: none;
            padding: 0;
        }

        .typing-input:focus {
            outline: none;
        }

        .stats {
            display: flex;
            gap: 32px;
            margin-bottom: 32px;
            padding: 0;
            border: none;
            flex-wrap: wrap;
            align-items: center;
            opacity: 0.8;
        }

        .stat-box {
            padding: 0;
            background: transparent;
            border-radius: 0;
            text-align: left;
            box-shadow: none;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .stat-label {
            color: #737373;
            font-size: 0.75em;
            margin-bottom: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .stat-value {
            color: #262626;
            font-size: 1em;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .practice-header h2 {
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin: 0;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .button-group:hover {
            opacity: 1;
        }

        .btn-generate, .btn-restart {
            padding: 8px 16px;
            background: white;
            color: #525252;
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .btn-restart {
            color: #737373;
        }

        .btn-generate:hover {
            background: #f8f8f8;
            border-color: #d4d4d4;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .btn-restart:hover {
            background: #f8f8f8;
            border-color: #d4d4d4;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .btn-generate:disabled, .btn-restart:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .settings-container {
            position: relative;
        }

        .instructions {
            text-align: left;
            color: #cbd5e0;
            margin-top: 12px;
            font-style: normal;
            font-size: 0.7em;
        }

        .shortcuts {
            text-align: left;
            margin-top: 6px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            font-size: 0.7em;
            color: #cbd5e0;
        }

        .shortcuts strong {
            color: #a0aec0;
            font-weight: 500;
        }

        .shortcut-key {
            display: inline-block;
            padding: 2px 4px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 2px;
            font-family: monospace;
            font-weight: normal;
            margin: 0 1px;
            box-shadow: none;
            font-size: 0.85em;
        }

        .settings-panel {
            margin-bottom: 12px;
            padding: 15px 20px;
            background: #e8e8e8;
            border-radius: 8px;
        }

        .settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item.full-width {
            flex-basis: 100%;
            width: 100%;
        }

        .setting-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Compact Mode Toggle */
        .mode-toggle {
            display: flex;
            background: transparent;
            border-radius: 6px;
            padding: 0;
            gap: 6px;
        }

        .mode-toggle input[type="radio"] {
            display: none;
        }

        .mode-toggle label {
            padding: 6px 14px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
            transition: all 0.2s;
            color: #4b5563;
            user-select: none;
            background: white;
            border: 1px solid #d0d0d0;
        }

        .mode-toggle input[type="radio"]:checked + label {
            background: #fffbeb;
            color: #92400e;
            border-color: #e2b714;
            box-shadow: 0 1px 3px rgba(226, 183, 20, 0.1);
        }

        .mode-toggle input[type="radio"]:checked + label:hover {
            background: #fef9c3;
            color: #78350f;
            border-color: #d1a513;
        }

        /* Compact Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider {
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2d3748;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2d3748;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.85em;
        }

        /* Compact Radio Buttons */
        .radio-group {
            display: flex;
            gap: 6px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 6px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            color: #6c757d;
            transition: all 0.2s;
            user-select: none;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #fffbeb;
            color: #92400e;
            border-color: #e2b714;
            box-shadow: 0 1px 3px rgba(226, 183, 20, 0.1);
        }

        .radio-option input[type="radio"]:checked + label:hover {
            background: #fef9c3;
            color: #78350f;
            border-color: #d1a513;
        }

        /* Compact Toggle Switch */
        .toggle-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e8e8e8;
            border: none;
            transition: background 0.3s;
            border-radius: 11px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: transform 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #e2b714;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
        }

        .progress-bar-container {
            width: 100%;
            height: 2px;
            background: #e9ecef;
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: #2d3748;
            transition: width 0.3s ease;
            border-radius: 0;
        }

        .timer-display {
            font-size: 0.9em;
            font-weight: 500;
            color: #6c757d;
            text-align: left;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .timer-display.warning {
            color: #f39c12;
            animation: none;
        }

        .timer-display.danger {
            color: #e74c3c;
            animation: none;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Focus Mode */
        body.focus-mode h1,
        body.focus-mode .subtitle,
        body.focus-mode .settings-panel,
        body.focus-mode .finger-selector,
        body.focus-mode .keyboard,
        body.focus-mode .selected-keys {
            display: none;
        }

        body.focus-mode .container {
            padding: 20px;
        }

        body.focus-mode .practice-area {
            margin-top: 0;
            padding: 60px 0;
        }

        body.focus-mode .practice-area h2 {
            display: none;
        }

        body.focus-mode .stats {
            margin-bottom: 40px;
        }

        .focus-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 24px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            z-index: 1000;
        }

        .focus-toggle:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.02);
        }

        .focus-toggle:active {
            transform: translateY(0) scale(1);
        }

        body.focus-mode .focus-toggle {
            background: #e8e8e8;
        }

        body.focus-mode .focus-toggle:hover {
            background: #f5f5f5;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 18px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 24px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            z-index: 1000;
        }

        .dark-mode-toggle:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.02);
        }

        .dark-mode-toggle:active {
            transform: translateY(0) scale(1);
        }

        body.dark-mode .focus-toggle {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .focus-toggle:hover {
            background: #3a3c3f;
        }

        body.dark-mode.focus-mode .focus-toggle {
            background: #3a3c3f;
            color: #d1d0c5;
        }

        body.dark-mode.focus-mode .focus-toggle:hover {
            background: #4a4c4f;
        }

        body.dark-mode .dark-mode-toggle {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: #3a3c3f;
        }

        /* Settings Dropdown */
        .settings-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .settings-btn {
            padding: 10px;
            background: white;
            color: #2d3748;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px) scale(1.05);
        }

        .settings-btn:active {
            transform: translateY(0) scale(1);
        }

        .settings-menu {
            position: absolute;
            top: 54px;
            right: 0;
            background: white;
            border-radius: 16px;
            padding: 20px;
            min-width: 320px;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-8px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid #e8e8e8;
        }

        .settings-menu.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .settings-menu-item {
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.15s ease;
        }

        .settings-menu-item:hover {
            background: #fafafa;
        }

        .settings-menu-divider {
            height: 1px;
            background: #e5e5e5;
            margin: 12px 0;
        }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            color: #dc2626;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .reset-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }

        .reset-btn svg {
            flex-shrink: 0;
        }

        /* Settings header */
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .settings-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: #262626;
        }

        .save-btn-dropdown {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #e2b714;
            color: #78350f;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .save-btn-dropdown.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .save-btn-dropdown:hover {
            background: #d1a513;
            color: #451a03;
            transform: translateY(-1px);
        }

        .save-btn-dropdown:active {
            transform: translateY(0);
        }

        .save-btn-dropdown svg {
            flex-shrink: 0;
        }

        /* Settings sections and items */
        .settings-section {
            margin-bottom: 8px;
        }

        .setting-item-dropdown {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            gap: 12px;
        }

        .setting-label-dropdown {
            font-size: 13px;
            font-weight: 500;
            min-width: 90px;
            flex-shrink: 0;
        }

        .toggle-switch-small {
            position: relative;
            width: 42px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle-switch-small input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-small {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0e0e0;
            border: none;
            transition: background 0.3s;
            border-radius: 11px;
        }

        .toggle-slider-small::before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: transform 0.3s;
            border-radius: 50%;
        }

        .toggle-switch-small input:checked + .toggle-slider-small {
            background: #e2b714;
        }

        .toggle-switch-small input:checked + .toggle-slider-small::before {
            transform: translateX(20px);
        }

        .settings-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .settings-switch input[type="checkbox"] {
            display: none;
        }

        .settings-slider {
            position: relative;
            width: 40px;
            height: 22px;
            background: #e0e0e0;
            border-radius: 11px;
            transition: background 0.3s;
        }

        .settings-slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .settings-switch input[type="checkbox"]:checked + .settings-slider {
            background: #e2b714;
        }

        .settings-switch input[type="checkbox"]:checked + .settings-slider::after {
            transform: translateX(18px);
        }

        .settings-label {
            font-size: 0.9em;
            font-weight: 500;
            color: #2d3748;
        }

        /* Dark mode styles */
        body.dark-mode .settings-btn {
            background: #2c2e31;
            color: #d1d0c5;
        }

        body.dark-mode .settings-btn:hover {
            background: #3a3c3f;
        }

        body.dark-mode .settings-menu {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .settings-menu-item:hover {
            background: #2a2a2a;
        }

        body.dark-mode .settings-menu-divider {
            background: #404040;
        }

        body.dark-mode .reset-btn {
            color: #f87171;
        }

        body.dark-mode .reset-btn:hover {
            background: #3a1f1f;
            color: #fca5a5;
        }

        body.dark-mode .settings-header {
            border-bottom-color: #404040;
        }

        body.dark-mode .settings-header h3 {
            color: #fafafa;
        }

        body.dark-mode .save-btn-dropdown {
            background: #e2b714;
            color: #78350f;
        }

        body.dark-mode .save-btn-dropdown:hover {
            background: #d1a513;
            color: #451a03;
        }

        body.dark-mode .setting-label-dropdown {
            color: #d1d0c5;
        }

        body.dark-mode .toggle-slider-small {
            background: #646669;
        }

        body.dark-mode .toggle-switch-small input:checked + .toggle-slider-small {
            background: #e2b714;
        }

        body.dark-mode .settings-slider {
            background: #646669;
        }

        body.dark-mode .settings-slider::after {
            background: #d1d0c5;
        }

        body.dark-mode .settings-label {
            color: #d1d0c5;
        }

        .focus-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.05);
            color: #a0aec0;
            border-radius: 4px;
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        body.focus-mode .focus-hint {
            opacity: 1;
        }

        .focus-hint.hidden {
            opacity: 0 !important;
        }

        .focus-hint kbd {
            display: inline-block;
            padding: 2px 6px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 0 2px;
        }

        /* Typing Overlay */
        .typing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }

        .typing-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .overlay-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
        }

        .overlay-content svg {
            color: #666;
        }

        .typing-area {
            position: relative;
        }

        /* Custom Modal */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .custom-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.2s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-body {
            color: #2d3748;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 24px;
            white-space: pre-line;
            text-align: center;
        }

        .modal-btn {
            width: 100%;
            padding: 12px 24px;
            background: #e2b714;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }

        .modal-btn:hover {
            background: #d4a912;
            transform: translateY(-2px);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
            color: #e5e5e5;
        }

        body.dark-mode h1 {
            color: #fafafa;
        }

        body.dark-mode .subtitle {
            color: #a3a3a3;
        }

        body.dark-mode .settings-panel {
            background: #262626;
            border: 1px solid #404040;
        }

        body.dark-mode .finger-selector {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .setting-label {
            color: #a3a3a3;
        }

        body.dark-mode .hand-label {
            color: #a3a3a3;
        }

        body.dark-mode .mode-toggle label {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
        }

        body.dark-mode .mode-toggle label:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .mode-toggle input:checked + label {
            background: #2a2a2a;
            color: #fbbf24;
            border-color: #e2b714;
        }

        body.dark-mode .mode-toggle input:checked + label:hover {
            background: #333333;
            color: #fcd34d;
            border-color: #e2b714;
        }

        body.dark-mode .radio-option label {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
        }

        body.dark-mode .radio-option label:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .radio-option input:checked + label {
            background: #e2b714;
            color: white;
            border-color: #e2b714;
        }

        body.dark-mode .radio-option input:checked + label:hover {
            background: #f0c520;
            border-color: #f0c520;
        }

        body.dark-mode .toggle-slider {
            background-color: #525252;
        }

        body.dark-mode .toggle-slider:before {
            background-color: #e5e5e5;
        }

        body.dark-mode input:checked + .toggle-slider {
            background-color: #e2b714;
        }

        body.dark-mode input:checked + .toggle-slider:before {
            background-color: white;
        }

        body.dark-mode .slider {
            background: #2c2e31;
        }

        body.dark-mode .slider::-webkit-slider-thumb {
            background: #e2b714;
        }

        body.dark-mode .slider::-moz-range-thumb {
            background: #e2b714;
        }

        body.dark-mode .slider-value {
            color: #d1d0c5;
            background: #2c2e31;
            border-color: #646669;
        }

        body.dark-mode .finger-btn {
            background: #2c2e31;
            color: #646669;
            border-color: #646669;
        }

        body.dark-mode .finger-btn:hover {
            background: #646669;
            border-color: #646669;
            color: #d1d0c5;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .finger-btn.active {
            color: white;
        }

        body.dark-mode .finger-btn.active:hover {
            transform: translateY(-1px);
        }

        body.dark-mode .selected-keys {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .selected-keys strong {
            color: #fafafa;
        }

        body.dark-mode .selected-keys-list {
            color: #a3a3a3;
        }

        body.dark-mode .key-chip {
            background: #333333;
            color: #e5e5e5;
            border-color: #525252;
        }

        body.dark-mode .keyboard {
            background: #262626;
            border: 1px solid #404040;
            box-shadow: none;
        }

        body.dark-mode .key {
            background: #333333;
            color: #a3a3a3;
            border-color: #525252;
        }

        body.dark-mode .key:hover {
            background: #3a3a3a;
            color: #e5e5e5;
            border-color: #737373;
            transform: translateY(-1px);
        }

        body.dark-mode .key.selected[data-finger]:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        body.dark-mode .key.selected[data-finger="left-pinky"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        body.dark-mode .key.selected[data-finger="left-ring"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        body.dark-mode .key.selected[data-finger="left-middle"]:hover {
            background: #60a5fa;
            border-color: #93c5fd;
        }

        body.dark-mode .key.selected[data-finger="left-index"]:hover {
            background: #34d399;
            border-color: #6ee7b7;
        }

        body.dark-mode .key.selected[data-finger="right-index"]:hover {
            background: #fbbf24;
            border-color: #fcd34d;
        }

        body.dark-mode .key.selected[data-finger="right-middle"]:hover {
            background: #f87171;
            border-color: #fca5a5;
        }

        body.dark-mode .key.selected[data-finger="right-ring"]:hover {
            background: #f472b6;
            border-color: #f9a8d4;
        }

        body.dark-mode .key.selected[data-finger="right-pinky"]:hover {
            background: #a78bfa;
            border-color: #c4b5fd;
        }

        body.dark-mode .key.disabled {
            background: #2c2e31;
            color: #3a3a3d;
        }

        body.dark-mode .key.disabled:hover {
            transform: none;
        }

        body.dark-mode .typing-area {
            background: #2c2e31;
            border: none;
        }

        body.dark-mode .progress-bar-container {
            background: #2c2e31;
        }

        body.dark-mode .progress-bar {
            background: #646669;
        }

        body.dark-mode .target-text {
            color: #737373;
        }

        body.dark-mode .target-text .correct {
            color: #e5e5e5;
        }

        body.dark-mode .target-text .incorrect {
            color: #f87171;
            background: rgba(248, 113, 113, 0.15);
        }

        body.dark-mode .target-text .upcoming {
            color: #737373;
            opacity: 1;
        }

        body.dark-mode .target-text .current {
            color: #737373;
            opacity: 1;
            background: transparent;
            font-weight: 400;
            border-left-color: #e2b714;
            animation: blink-cursor-dark 1.2s ease-in-out infinite;
        }

        @keyframes blink-cursor-dark {
            0%, 49% { border-left-color: #e2b714; }
            50%, 100% { border-left-color: transparent; }
        }

        body.dark-mode .typing-input {
            background: #2c2e31;
            color: #d1d0c5;
            border: none;
        }

        body.dark-mode .stats {
            background: transparent;
            border: none;
        }

        body.dark-mode .stats h3 {
            color: #d1d0c5;
        }

        body.dark-mode .stat-item {
            color: #a3a3a3;
        }

        body.dark-mode .stat-value {
            color: #fafafa;
        }

        body.dark-mode .stat-label {
            color: #a3a3a3;
        }

        body.dark-mode .restart-btn {
            background: #e2b714;
            color: white;
            border-color: #e2b714;
        }

        body.dark-mode .restart-btn:hover {
            background: #c29a12;
            border-color: #c29a12;
        }

        body.dark-mode .btn-generate,
        body.dark-mode .btn-restart {
            background: #262626;
            color: #a3a3a3;
            border-color: #404040;
            box-shadow: none;
        }

        body.dark-mode .btn-generate:hover,
        body.dark-mode .btn-restart:hover {
            background: #2a2a2a;
            border-color: #525252;
            color: #e5e5e5;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .btn-generate:disabled,
        body.dark-mode .btn-restart:disabled {
            opacity: 0.3;
            color: #3a3a3d;
        }

        body.dark-mode .instructions {
            color: #646669;
        }

        body.dark-mode .shortcuts {
            color: #646669;
        }

        body.dark-mode .shortcuts strong {
            color: #646669;
        }

        body.dark-mode .shortcut-key {
            background: #2c2e31;
            border-color: #646669;
            color: #d1d0c5;
        }

        body.dark-mode .focus-hint {
            background: rgba(0, 0, 0, 0.5);
            color: #646669;
        }

        body.dark-mode .focus-hint kbd {
            background: #2c2e31;
            border-color: #646669;
            color: #d1d0c5;
        }

        body.dark-mode .typing-overlay {
            background: rgba(50, 52, 55, 0.8);
            backdrop-filter: blur(8px);
        }

        body.dark-mode .overlay-content {
            color: #d1d0c5;
        }

        body.dark-mode .overlay-content svg {
            color: #d1d0c5;
        }

        body.dark-mode .modal-content {
            background: #2c2e31;
        }

        body.dark-mode .modal-body {
            color: #d1d0c5;
        }

        body.dark-mode .key.home-row::after {
            background: #646669;
        }

        body.dark-mode .key.home-row.selected::after {
            background: #d1d0c5;
        }
    </style>
</head>
<body>
    <!-- Settings Dropdown -->
    <div class="settings-dropdown">
        <button class="settings-btn" id="settingsBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="save-btn-dropdown" id="saveSettingsBtn" title="Save Settings">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>

            <!-- App Settings -->
            <div class="settings-section">
                <div class="settings-menu-item">
                    <label class="settings-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="settings-slider"></span>
                        <span class="settings-label">Dark Mode</span>
                    </label>
                </div>
                <div class="settings-menu-item">
                    <label class="settings-switch">
                        <input type="checkbox" id="focusToggle">
                        <span class="settings-slider"></span>
                        <span class="settings-label">Focus Mode</span>
                    </label>
                </div>
            </div>

            <div class="settings-menu-divider"></div>

            <!-- Practice Settings -->
            <div class="settings-section">
                <h4 style="margin: 8px 0; font-size: 13px; font-weight: 600; opacity: 0.7;">Practice Settings</h4>

                <!-- Mode -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Mode:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="modeWords" name="mode" value="words">
                        <label for="modeWords">Words</label>
                        <input type="radio" id="modeTimed" name="mode" value="timed">
                        <label for="modeTimed">Time</label>
                        <input type="radio" id="modeUnlimited" name="mode" value="unlimited" checked>
                        <label for="modeUnlimited">Infinited</label>
                    </div>
                </div>

                <!-- Word Count -->
                <div class="setting-item-dropdown" id="wordCountSetting" style="display: none;">
                    <span class="setting-label-dropdown">Words:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordCount10" name="wordCount" value="10" checked>
                        <label for="wordCount10">10</label>
                        <input type="radio" id="wordCount25" name="wordCount" value="25">
                        <label for="wordCount25">25</label>
                        <input type="radio" id="wordCount50" name="wordCount" value="50">
                        <label for="wordCount50">50</label>
                        <input type="radio" id="wordCount100" name="wordCount" value="100">
                        <label for="wordCount100">100</label>
                    </div>
                </div>

                <!-- Time Limit -->
                <div class="setting-item-dropdown" id="timeLimitSetting" style="display: none;">
                    <span class="setting-label-dropdown">Time:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="time15" name="timeLimit" value="15">
                        <label for="time15">15</label>
                        <input type="radio" id="time30" name="timeLimit" value="30" checked>
                        <label for="time30">30</label>
                        <input type="radio" id="time60" name="timeLimit" value="60">
                        <label for="time60">60</label>
                        <input type="radio" id="time120" name="timeLimit" value="120">
                        <label for="time120">120</label>
                    </div>
                </div>

                <!-- Numbers Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Numbers:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeNumbers">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Word Set -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Words:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordSetGibberish" name="wordSet" value="gibberish">
                        <label for="wordSetGibberish">Gibberish</label>
                        <input type="radio" id="wordSetReal" name="wordSet" value="real" checked>
                        <label for="wordSetReal">Real</label>
                    </div>
                </div>

                <!-- Capitals Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Capitals:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeCapitals">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Special Characters Toggle -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Special Chars:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeSpecialChars">
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Spaces:</span>
                    <label class="toggle-switch-small">
                        <input type="checkbox" id="includeSpaces" checked>
                        <span class="toggle-slider-small"></span>
                    </label>
                </div>

                <!-- Error Mode -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Error Mode:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="errorModeBlock" name="errorMode" value="block" checked>
                        <label for="errorModeBlock">Block</label>
                        <input type="radio" id="errorModeBackspace" name="errorMode" value="backspace">
                        <label for="errorModeBackspace">Continue</label>
                    </div>
                </div>

                <!-- Word Bank -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Word Bank:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="wordBank1k" name="wordBank" value="1k">
                        <label for="wordBank1k">1K</label>
                        <input type="radio" id="wordBank10k" name="wordBank" value="10k" checked>
                        <label for="wordBank10k">10K</label>
                        <input type="radio" id="wordBank25k" name="wordBank" value="25k">
                        <label for="wordBank25k">25K</label>
                        <input type="radio" id="wordBank450k" name="wordBank" value="450k">
                        <label for="wordBank450k">450K</label>
                    </div>
                </div>

                <!-- Font Size -->
                <div class="setting-item-dropdown">
                    <span class="setting-label-dropdown">Font Size:</span>
                    <div class="mode-toggle">
                        <input type="radio" id="fontSizeSmall" name="fontSize" value="small">
                        <label for="fontSizeSmall">S</label>
                        <input type="radio" id="fontSizeMedium" name="fontSize" value="medium" checked>
                        <label for="fontSizeMedium">M</label>
                        <input type="radio" id="fontSizeLarge" name="fontSize" value="large">
                        <label for="fontSizeLarge">L</label>
                        <input type="radio" id="fontSizeXLarge" name="fontSize" value="xlarge">
                        <label for="fontSizeXLarge">XL</label>
                    </div>
                </div>
            </div>

            <div class="settings-menu-divider"></div>

            <!-- Reset -->
            <div class="settings-menu-item">
                <button class="reset-btn" id="resetBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    Reset All Settings
                </button>
            </div>
        </div>
    </div>
    <div class="focus-hint">Press <kbd>Esc</kbd> to exit focus mode</div>

    <div class="container">
        <h1>Better QWERTY</h1>
        <p class="subtitle">Improve your typing skills by practicing specific keys and fingers</p>

        <div class="finger-selector">
            <div class="finger-buttons">
                <div class="hand-section">
                    <span class="hand-label">Left:</span>
                    <div class="fingers-visual">
                        <button class="finger-btn" data-finger="left-pinky" title="Pinky: 1, Q, A, Z">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-ring" title="Ring: 2, W, S, X">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-middle" title="Middle: 3, E, D, C">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="left-index" title="Index: 4, 5, R, T, F, G, V, B">
                            <div class="finger-visual"></div>
                        </button>
                    </div>
                </div>
                <div class="hand-section">
                    <span class="hand-label">Right:</span>
                    <div class="fingers-visual">
                        <button class="finger-btn" data-finger="right-index" title="Index: 6, 7, Y, U, H, J, N, M">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-middle" title="Middle: 8, I, K, ,">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-ring" title="Ring: 9, O, L, .">
                            <div class="finger-visual"></div>
                        </button>
                        <button class="finger-btn" data-finger="right-pinky" title="Pinky: 0, -, =, P, [, ], \, ;, '">
                            <div class="finger-visual"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="keyboard">
            <!-- Number Row -->
            <div class="keyboard-row">
                <div class="key" data-key="`" data-finger="left-pinky"><span class="key-label">~</span><span class="key-main">`</span></div>
                <div class="key" data-key="1" data-finger="left-pinky"><span class="key-label">!</span><span class="key-main">1</span></div>
                <div class="key" data-key="2" data-finger="left-ring"><span class="key-label">@</span><span class="key-main">2</span></div>
                <div class="key" data-key="3" data-finger="left-middle"><span class="key-label">#</span><span class="key-main">3</span></div>
                <div class="key" data-key="4" data-finger="left-index"><span class="key-label">$</span><span class="key-main">4</span></div>
                <div class="key" data-key="5" data-finger="left-index"><span class="key-label">%</span><span class="key-main">5</span></div>
                <div class="key" data-key="6" data-finger="right-index"><span class="key-label">^</span><span class="key-main">6</span></div>
                <div class="key" data-key="7" data-finger="right-index"><span class="key-label">&</span><span class="key-main">7</span></div>
                <div class="key" data-key="8" data-finger="right-middle"><span class="key-label">*</span><span class="key-main">8</span></div>
                <div class="key" data-key="9" data-finger="right-ring"><span class="key-label">(</span><span class="key-main">9</span></div>
                <div class="key" data-key="0" data-finger="right-pinky"><span class="key-label">)</span><span class="key-main">0</span></div>
                <div class="key" data-key="-" data-finger="right-pinky"><span class="key-label">_</span><span class="key-main">-</span></div>
                <div class="key" data-key="=" data-finger="right-pinky"><span class="key-label">+</span><span class="key-main">=</span></div>
                <div class="key backspace" data-key="backspace" data-finger="right-pinky"></div>
            </div>

            <!-- QWERTY Row -->
            <div class="keyboard-row">
                <div class="key tab" data-key="tab" data-finger="left-pinky">Tab</div>
                <div class="key" data-key="q" data-finger="left-pinky">Q</div>
                <div class="key" data-key="w" data-finger="left-ring">W</div>
                <div class="key" data-key="e" data-finger="left-middle">E</div>
                <div class="key" data-key="r" data-finger="left-index">R</div>
                <div class="key" data-key="t" data-finger="left-index">T</div>
                <div class="key" data-key="y" data-finger="right-index">Y</div>
                <div class="key" data-key="u" data-finger="right-index">U</div>
                <div class="key" data-key="i" data-finger="right-middle">I</div>
                <div class="key" data-key="o" data-finger="right-ring">O</div>
                <div class="key" data-key="p" data-finger="right-pinky">P</div>
                <div class="key" data-key="[" data-finger="right-pinky"><span class="key-label">{</span><span class="key-main">[</span></div>
                <div class="key" data-key="]" data-finger="right-pinky"><span class="key-label">}</span><span class="key-main">]</span></div>
                <div class="key" data-key="\" data-finger="right-pinky"><span class="key-label">|</span><span class="key-main">\</span></div>
            </div>

            <!-- ASDF Row (Home Row) -->
            <div class="keyboard-row">
                <div class="key caps" data-key="caps" data-finger="left-pinky">Caps</div>
                <div class="key" data-key="a" data-finger="left-pinky">A</div>
                <div class="key" data-key="s" data-finger="left-ring">S</div>
                <div class="key" data-key="d" data-finger="left-middle">D</div>
                <div class="key home-row" data-key="f" data-finger="left-index">F</div>
                <div class="key" data-key="g" data-finger="left-index">G</div>
                <div class="key" data-key="h" data-finger="right-index">H</div>
                <div class="key home-row" data-key="j" data-finger="right-index">J</div>
                <div class="key" data-key="k" data-finger="right-middle">K</div>
                <div class="key" data-key="l" data-finger="right-ring">L</div>
                <div class="key" data-key=";" data-finger="right-pinky"><span class="key-label">:</span><span class="key-main">;</span></div>
                <div class="key" data-key="'" data-finger="right-pinky"><span class="key-label">"</span><span class="key-main">'</span></div>
                <div class="key enter" data-key="enter" data-finger="right-pinky">Enter</div>
            </div>

            <!-- ZXCV Row -->
            <div class="keyboard-row">
                <div class="key shift-left" data-key="shift" data-finger="left-pinky">Shift</div>
                <div class="key" data-key="z" data-finger="left-pinky">Z</div>
                <div class="key" data-key="x" data-finger="left-ring">X</div>
                <div class="key" data-key="c" data-finger="left-middle">C</div>
                <div class="key" data-key="v" data-finger="left-index">V</div>
                <div class="key" data-key="b" data-finger="left-index">B</div>
                <div class="key" data-key="n" data-finger="right-index">N</div>
                <div class="key" data-key="m" data-finger="right-index">M</div>
                <div class="key" data-key="," data-finger="right-middle"><span class="key-label">&lt;</span><span class="key-main">,</span></div>
                <div class="key" data-key="." data-finger="right-ring"><span class="key-label">&gt;</span><span class="key-main">.</span></div>
                <div class="key" data-key="/" data-finger="right-pinky"><span class="key-label">?</span><span class="key-main">/</span></div>
                <div class="key shift-right" data-key="shift-right" data-finger="right-pinky">Shift</div>
            </div>

            <!-- Space Row -->
            <div class="keyboard-row" style="justify-content: center; margin-left: 0;">
                <div class="key space" data-key=" " style="background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%); border-color: #b2bec3;">SPACE</div>
            </div>
        </div>

        <div class="selected-keys">
            <strong>Selected Keys:</strong> <span id="selectedKeysList">None - Click keys above or use finger shortcuts</span>
        </div>

        <div class="practice-area">
            <div class="practice-header">
                <h2>Typing Practice</h2>
                <div class="button-group">
                    <button class="btn-restart" id="restartBtn" disabled>Restart Test</button>
                    <button class="btn-generate" id="generateBtn" disabled>Generate New Exercise</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">WPM</div>
                    <div class="stat-value" id="wpm">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" id="accuracy">100%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progress">0/0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Errors</div>
                    <div class="stat-value" id="errors">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value" id="timeElapsed">0s</div>
                </div>
            </div>

            <div class="timer-display" id="timerDisplay" style="display: none;">
                Time: <span id="timeRemaining">--</span>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>

            <div class="target-text" id="targetText">
                <div class="typing-overlay" id="typingOverlay">
                    <div class="overlay-content">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                        </svg>
                        <span>Click here or press any key to focus</span>
                    </div>
                </div>
                Select keys above to generate practice text
            </div>
            <div class="input-area">
                <input type="text" class="typing-input" id="typingInput" placeholder="Start typing here..." disabled>
            </div>

            <p class="instructions">Select keys and start typing! Use buttons or keyboard shortcuts below.</p>
            <div class="shortcuts">
                <strong>Keyboard Shortcuts:</strong>
                <span class="shortcut-key">F</span> Focus Mode 
                <span class="shortcut-key">Shift</span>+<span class="shortcut-key">Enter</span> Restart 
                <span class="shortcut-key" id="modKey1">Cmd</span>+<span class="shortcut-key">N</span> New 
                <span class="shortcut-key" id="modKey2">Cmd</span>+<span class="shortcut-key">K</span> Focus Input
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-body" id="modalBody"></div>
            <button class="modal-btn" id="modalBtn">OK</button>
        </div>
    </div>

    <script>
        // Detect platform and update modifier key display
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const modifierKeyName = isMac ? 'Cmd' : 'Alt';

        // Update modifier key displays on page load
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modKey1').textContent = modifierKeyName;
            document.getElementById('modKey2').textContent = modifierKeyName;
            // Load default word bank
            loadWordBank('10k');
        });

        // Function to load word bank from Monkeytype
        async function loadWordBank(size) {
            const urls = {
                '1k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_1k.json',
                '10k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_10k.json',
                '25k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_25k.json',
                '450k': 'https://raw.githubusercontent.com/monkeytypegame/monkeytype/refs/heads/master/frontend/static/languages/english_450k.json'
            };

            try {
                const response = await fetch(urls[size]);
                const data = await response.json();
                realWords = data.words;
                wordBankSize = size;
                console.log(`Loaded ${realWords.length} words from ${size} word bank`);
            } catch (error) {
                console.error('Failed to load word bank, using fallback:', error);
                realWords = fallbackWords;
            }
        }

        const fingerMap = {
            'left-pinky': ['`', '1', 'q', 'a', 'z', 'tab', 'caps', 'shift'],
            'left-ring': ['2', 'w', 's', 'x'],
            'left-middle': ['3', 'e', 'd', 'c'],
            'left-index': ['4', '5', 'r', 't', 'f', 'g', 'v', 'b'],
            'right-index': ['6', '7', 'y', 'u', 'h', 'j', 'n', 'm'],
            'right-middle': ['8', 'i', 'k', ','],
            'right-ring': ['9', 'o', 'l', '.'],
            'right-pinky': ['0', '-', '=', 'p', '[', ']', '\\', ';', "'", '/', 'enter', 'backspace', 'shift-right']
        };

        // Fallback word list
        const fallbackWords = [
            'the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at', 'this',
            'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there', 'their', 'what', 'so',
            'up', 'out', 'if', 'about', 'who', 'get', 'which', 'go', 'me', 'when', 'make', 'can', 'like', 'time', 'no', 'just', 'him', 'know', 'take', 'people',
            'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 'other', 'than', 'then', 'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also', 'back',
            'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well', 'way', 'even', 'new', 'want', 'because', 'any', 'these', 'give', 'day', 'most', 'us', 'is',
            'was', 'are', 'been', 'has', 'had', 'were', 'said', 'did', 'may', 'should', 'could', 'being', 'does', 'am', 'might', 'must', 'shall', 'having', 'been', 'able',
            'need', 'man', 'find', 'here', 'thing', 'give', 'many', 'well', 'only', 'those', 'tell', 'very', 'even', 'back', 'good', 'woman', 'through', 'us', 'life', 'child',
            'there', 'work', 'down', 'call', 'come', 'still', 'try', 'last', 'ask', 'need', 'too', 'feel', 'three', 'when', 'state', 'never', 'become', 'between', 'high', 'really',
            'something', 'most', 'another', 'much', 'family', 'own', 'leave', 'put', 'old', 'while', 'mean', 'keep', 'student', 'great', 'same', 'big', 'group', 'begin', 'seem', 'country',
            'help', 'talk', 'where', 'turn', 'problem', 'every', 'start', 'hand', 'might', 'show', 'part', 'against', 'place', 'over', 'such', 'again', 'few', 'case', 'week', 'company',
            'where', 'system', 'each', 'right', 'program', 'hear', 'question', 'during', 'work', 'play', 'government', 'run', 'small', 'number', 'off', 'always', 'move', 'night', 'live', 'point',
            'believe', 'hold', 'today', 'bring', 'happen', 'next', 'without', 'before', 'large', 'must', 'home', 'under', 'water', 'room', 'write', 'mother', 'area', 'money', 'story', 'young',
            'fact', 'month', 'different', 'lot', 'study', 'book', 'eye', 'job', 'word', 'though', 'business', 'issue', 'side', 'kind', 'four', 'head', 'far', 'black', 'long', 'both',
            'little', 'house', 'yes', 'since', 'provide', 'service', 'around', 'friend', 'important', 'father', 'sit', 'away', 'until', 'power', 'hour', 'game', 'often', 'yet', 'line', 'political',
            'end', 'among', 'ever', 'stand', 'bad', 'lose', 'however', 'member', 'pay', 'law', 'meet', 'car', 'city', 'almost', 'include', 'continue', 'set', 'later', 'community', 'name',
            'five', 'once', 'white', 'least', 'president', 'learn', 'real', 'change', 'team', 'minute', 'best', 'several', 'idea', 'kid', 'body', 'information', 'nothing', 'ago', 'lead', 'social',
            'understand', 'whether', 'watch', 'together', 'follow', 'around', 'parent', 'only', 'stop', 'face', 'anything', 'create', 'public', 'already', 'speak', 'others', 'read', 'level', 'allow', 'add',
            'office', 'spend', 'door', 'health', 'person', 'art', 'sure', 'war', 'history', 'party', 'within', 'grow', 'result', 'open', 'morning', 'walk', 'reason', 'low', 'win', 'research',
            'girl', 'guy', 'early', 'food', 'moment', 'himself', 'air', 'teacher', 'force', 'offer', 'enough', 'both', 'across', 'although', 'remember', 'foot', 'second', 'boy', 'maybe', 'toward',
            'able', 'age', 'policy', 'everything', 'love', 'process', 'music', 'including', 'consider', 'appear', 'actually', 'buy', 'probably', 'human', 'wait', 'serve', 'market', 'die', 'send', 'expect',
            'sense', 'build', 'stay', 'fall', 'oh', 'nation', 'plan', 'cut', 'college', 'interest', 'death', 'course', 'someone', 'experience', 'behind', 'reach', 'local', 'kill', 'six', 'remain',
            'effect', 'yeah', 'suggest', 'class', 'control', 'raise', 'care', 'perhaps', 'little', 'late', 'hard', 'field', 'else', 'pass', 'former', 'sell', 'major', 'sometimes', 'require', 'along',
            'development', 'themselves', 'report', 'role', 'better', 'economic', 'effort', 'decide', 'rate', 'strong', 'possible', 'heart', 'drug', 'leader', 'light', 'voice', 'wife', 'whole', 'police', 'mind',
            'finally', 'pull', 'return', 'free', 'military', 'price', 'less', 'according', 'decision', 'explain', 'son', 'hope', 'develop', 'view', 'relationship', 'carry', 'town', 'road', 'drive', 'arm',
            'true', 'federal', 'break', 'difference', 'thank', 'receive', 'value', 'international', 'building', 'action', 'full', 'model', 'join', 'season', 'society', 'tax', 'director', 'position', 'player', 'agree',
            'especially', 'record', 'pick', 'wear', 'paper', 'special', 'space', 'ground', 'form', 'support', 'event', 'official', 'whose', 'matter', 'everyone', 'center', 'couple', 'site', 'project', 'hit',
            'base', 'activity', 'star', 'table', 'court', 'produce', 'eat', 'teach', 'half', 'situation', 'easy', 'cost', 'industry', 'figure', 'street', 'image', 'itself', 'phone', 'either', 'data',
            'cover', 'quite', 'picture', 'clear', 'practice', 'piece', 'land', 'recent', 'describe', 'product', 'doctor', 'wall', 'patient', 'worker', 'news', 'test', 'movie', 'certain', 'north', 'simply',
            'third', 'technology', 'catch', 'step', 'baby', 'computer', 'type', 'attention', 'draw', 'film', 'Republican', 'tree', 'source', 'red', 'nearly', 'organization', 'choose', 'cause', 'hair', 'century',
            'evidence', 'window', 'difficult', 'listen', 'soon', 'culture', 'billion', 'chance', 'brother', 'energy', 'period', 'summer', 'realize', 'hundred', 'available', 'plant', 'likely', 'opportunity', 'term', 'short',
            'letter', 'condition', 'choice', 'place', 'single', 'rule', 'daughter', 'administration', 'south', 'husband', 'Congress', 'floor', 'campaign', 'material', 'population', 'economy', 'medical', 'hospital', 'church', 'close',
            'thousand', 'risk', 'current', 'fire', 'future', 'wrong', 'involve', 'defense', 'anyone', 'increase', 'security', 'bank', 'myself', 'certainly', 'west', 'sport', 'board', 'seek', 'per', 'subject',
            'officer', 'private', 'rest', 'behavior', 'deal', 'performance', 'fight', 'throw', 'top', 'quickly', 'past', 'goal', 'bed', 'order', 'author', 'fill', 'represent', 'focus', 'foreign', 'drop',
            'plan', 'blood', 'upon', 'agency', 'push', 'nature', 'color', 'recently', 'store', 'reduce', 'sound', 'note', 'fine', 'near', 'movement', 'page', 'enter', 'share', 'common', 'poor',
            'natural', 'race', 'concern', 'series', 'significant', 'similar', 'hot', 'language', 'each', 'usually', 'response', 'dead', 'rise', 'animal', 'factor', 'decade', 'article', 'shoot', 'east', 'save',
            'seven', 'artist', 'scene', 'stock', 'career', 'despite', 'central', 'eight', 'thus', 'treatment', 'beyond', 'happy', 'exactly', 'protect', 'approach', 'lie', 'size', 'dog', 'fund', 'serious',
            'occur', 'media', 'ready', 'sign', 'thought', 'list', 'individual', 'simple', 'quality', 'pressure', 'accept', 'answer', 'resource', 'identify', 'left', 'meeting', 'determine', 'prepare', 'disease', 'whatever',
            'success', 'argue', 'cup', 'particularly', 'amount', 'ability', 'staff', 'recognize', 'indicate', 'character', 'growth', 'loss', 'degree', 'wonder', 'attack', 'herself', 'region', 'television', 'box', 'TV',
            'training', 'pretty', 'trade', 'election', 'everybody', 'physical', 'lay', 'general', 'feeling', 'standard', 'bill', 'message', 'fail', 'outside', 'arrive', 'analysis', 'benefit', 'sex', 'forward', 'lawyer',
            'present', 'section', 'environmental', 'glass', 'skill', 'sister', 'PM', 'professor', 'operation', 'financial', 'crime', 'stage', 'compare', 'authority', 'miss', 'design', 'sort', 'act', 'ten', 'knowledge',
            'gun', 'station', 'blue', 'strategy', 'clearly', 'discuss', 'indeed', 'truth', 'song', 'example', 'democratic', 'check', 'environment', 'leg', 'dark', 'various', 'rather', 'laugh', 'guess', 'executive',
            'prove', 'hang', 'entire', 'rock', 'forget', 'claim', 'remove', 'manager', 'enjoy', 'network', 'legal', 'religious', 'cold', 'form', 'final', 'main', 'science', 'green', 'memory', 'card',
            'above', 'seat', 'cell', 'establish', 'nice', 'trial', 'expert', 'spring', 'firm', 'Democrat', 'radio', 'visit', 'management', 'avoid', 'imagine', 'tonight', 'huge', 'ball', 'finish', 'yourself',
            'theory', 'impact', 'respond', 'statement', 'maintain', 'charge', 'popular', 'traditional', 'onto', 'reveal', 'direction', 'weapon', 'employee', 'cultural', 'contain', 'peace', 'head', 'control', 'base', 'pain',
            'apply', 'play', 'measure', 'wide', 'shake', 'fly', 'interview', 'manage', 'chair', 'fish', 'particular', 'camera', 'structure', 'politics', 'perform', 'bit', 'weight', 'suddenly', 'discover', 'candidate',
            'production', 'treat', 'trip', 'evening', 'affect', 'inside', 'conference', 'unit', 'best', 'style', 'adult', 'worry', 'range', 'mention', 'rather', 'deep', 'edge', 'specific', 'writer', 'trouble',
            'necessary', 'throughout', 'challenge', 'fear', 'shoulder', 'institution', 'middle', 'sea', 'dream', 'bar', 'beautiful', 'property', 'instead', 'improve', 'stuff', 'claim', 'professor', 'else', 'magazine', 'hotel',
            'soldier', 'reflect', 'heavy', 'sexual', 'bag', 'heat', 'marriage', 'tough', 'sing', 'surface', 'purpose', 'exist', 'pattern', 'whom', 'skin', 'agent', 'owner', 'machine', 'gas', 'ahead',
            'generation', 'commercial', 'address', 'cancer', 'item', 'reality', 'coach', 'Mrs', 'yard', 'beat', 'violence', 'total', 'tend', 'investment', 'discussion', 'finger', 'garden', 'notice', 'collection', 'modern',
            'task', 'partner', 'positive', 'civil', 'kitchen', 'consumer', 'shot', 'budget', 'wish', 'painting', 'scientist', 'safe', 'agreement', 'capital', 'mouth', 'nor', 'victim', 'newspaper', 'threat', 'responsibility',
            'smile', 'attorney', 'score', 'account', 'interesting', 'break', 'audience', 'rich', 'dinner', 'figure', 'vote', 'western', 'relate', 'travel', 'debate', 'prevent', 'citizen', 'majority', 'none', 'front',
            'born', 'admit', 'senior', 'assume', 'wind', 'key', 'professional', 'mission', 'fast', 'alone', 'customer', 'suffer', 'speech', 'successful', 'option', 'participant', 'southern', 'fresh', 'eventually', 'forest',
            'video', 'global', 'reform', 'access', 'restaurant', 'judge', 'publish', 'cost', 'relation', 'like', 'release', 'own', 'bird', 'opinion', 'credit', 'critical', 'corner', 'concerned', 'recall', 'version',
            'stare', 'safety', 'effective', 'neighborhood', 'original', 'act', 'troop', 'income', 'directly', 'hurt', 'species', 'immediately', 'track', 'basic', 'strike', 'hope', 'freedom', 'absolutely', 'plane', 'nobody',
            'achieve', 'object', 'attitude', 'labor', 'refer', 'concept', 'client', 'powerful', 'perfect', 'nine', 'therefore', 'conduct', 'announce', 'conversation', 'examine', 'touch', 'please', 'attend', 'completely', 'vote',
            'variety', 'sleep', 'turn', 'involved', 'investigation', 'nuclear', 'researcher', 'press', 'conflict', 'spirit', 'replace', 'British', 'encourage', 'argument', 'by', 'once', 'camp', 'brain', 'feature', 'afternoon',
            'AM', 'weekend', 'dozen', 'possibility', 'insurance', 'department', 'battle', 'beginning', 'date', 'generally', 'African', 'very', 'sorry', 'crisis', 'complete', 'fan', 'stick', 'define', 'easily', 'through',
            'hole', 'element', 'vision', 'status', 'normal', 'Chinese', 'ship', 'solution', 'stone', 'slowly', 'scale', 'driver', 'attempt', 'park', 'spot', 'lack', 'ice', 'boat', 'drink', 'sun',
            'front', 'distance', 'wood', 'handle', 'truck', 'mountain', 'survey', 'supposed', 'tradition', 'winter', 'village', 'Soviet', 'refuse', 'sales', 'roll', 'communication', 'run', 'screen', 'gain', 'resident',
            'hide', 'gold', 'club', 'farm', 'potential', 'increase', 'middle', 'European', 'presence', 'independent', 'district', 'shape', 'reader', 'Ms', 'contract', 'crowd', 'Christian', 'express', 'apartment', 'willing',
            'strength', 'previous', 'band', 'obviously', 'horse', 'interested', 'target', 'prison', 'ride', 'guard', 'terms', 'demand', 'reporter', 'deliver', 'text', 'tool', 'wild', 'vehicle', 'observe', 'flight',
            'facility', 'understanding', 'average', 'emerge', 'advantage', 'quick', 'light', 'leadership', 'earn', 'pound', 'basis', 'bright', 'operate', 'guest', 'sample', 'contribute', 'tiny', 'block', 'protection', 'settle',
            'feed', 'collect', 'additional', 'while', 'highly', 'identity', 'title', 'mostly', 'lesson', 'faith', 'river', 'promote', 'living', 'count', 'unless', 'marry', 'tomorrow', 'technique', 'path', 'ear',
            'shop', 'folk', 'principle', 'survive', 'lift', 'border', 'competition', 'jump', 'gather', 'limit', 'fit', 'claim', 'cry', 'equipment', 'worth', 'associate', 'critic', 'warm', 'aspect', 'result',
            'insist', 'failure', 'annual', 'French', 'Christmas', 'comment', 'responsible', 'affair', 'procedure', 'regular', 'spread', 'chairman', 'baseball', 'soft', 'ignore', 'egg', 'belief', 'demonstrate', 'anybody', 'murder',
            'gift', 'religion', 'review', 'editor', 'engage', 'coffee', 'document', 'speed', 'cross', 'influence', 'anyway', 'threaten', 'commit', 'female', 'youth', 'wave', 'afraid', 'quarter', 'background', 'native',
            'broad', 'wonderful', 'deny', 'apparently', 'slightly', 'reaction', 'twice', 'suit', 'perspective', 'growing', 'blow', 'construction', 'kind', 'intelligence', 'destroy', 'cook', 'connection', 'burn', 'shoe', 'grade',
            'context', 'committee', 'hey', 'mistake', 'focus', 'smile', 'location', 'clothes', 'Indian', 'quiet', 'dress', 'promise', 'aware', 'neighbor', 'function', 'bone', 'active', 'extend', 'chief', 'combine',
            'wine', 'below', 'cool', 'voter', 'learning', 'bus', 'hell', 'dangerous', 'remind', 'moral', 'United', 'category', 'relatively', 'victory', 'academic', 'Internet', 'healthy', 'negative', 'following', 'historical',
            'medicine', 'tour', 'depend', 'photo', 'finding', 'grab', 'direct', 'classroom', 'contact', 'justice', 'participate', 'daily', 'fair', 'pair', 'famous', 'separate', 'quote', 'German', 'pound', 'double',
            'conversation', 'develop', 'seek', 'connection', 'works', 'brown', 'lead', 'trouble', 'action', 'propose', 'next', 'careful', 'driver', 'conservative', 'present', 'liberal', 'lip', 'launch', 'accurate', 'career',
            'dog', 'scene', 'peace', 'citizen', 'weapon', 'perspective', 'advantage', 'tone', 'ocean', 'signal', 'sentence', 'discipline', 'elsewhere', 'iron', 'perception', 'pack', 'contempor'
        ];

        // Real words - loaded from Monkeytype API
        let realWords = fallbackWords;
        let wordBankSize = '10k'; // Default to 10K

        let selectedKeys = new Set();
        let currentText = '';
        let currentPosition = 0;
        let errorCount = 0;
        let totalTyped = 0;
        let startTime = null;
        let lastWpmUpdate = 0;
        let timerInterval = null;
        let errorPositions = new Map(); // Track positions with errors and what was typed
        let timeLimit = 30;
        let isTimedMode = false;
        let isUnlimitedMode = true;

        // Settings
        let wordCount = 10;
        let includeNumbers = false;
        let useRealWords = true;
        let useCapitals = false;
        let includeSpecialChars = false;
        let includeSpaces = true;
        let errorMode = 'block'; // 'block', 'skip', 'backspace'
        let fontSize = 'medium'; // 'small', 'medium', 'large', 'xlarge'

        const keys = document.querySelectorAll('.key');
        const fingerBtns = document.querySelectorAll('.finger-btn');
        const selectedKeysList = document.getElementById('selectedKeysList');
        const generateBtn = document.getElementById('generateBtn');
        const restartBtn = document.getElementById('restartBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const targetText = document.getElementById('targetText');
        const typingInput = document.getElementById('typingInput');
        const accuracyEl = document.getElementById('accuracy');
        const progressEl = document.getElementById('progress');
        const errorsEl = document.getElementById('errors');
        const wpmEl = document.getElementById('wpm');
        const timeElapsedEl = document.getElementById('timeElapsed');
        const progressBar = document.getElementById('progressBar');
        const timerDisplay = document.getElementById('timerDisplay');
        const timeRemaining = document.getElementById('timeRemaining');

        // Settings elements
        const modeWords = document.getElementById('modeWords');
        const modeTimed = document.getElementById('modeTimed');
        const modeUnlimited = document.getElementById('modeUnlimited');
        const wordCountSetting = document.getElementById('wordCountSetting');
        const timeLimitSetting = document.getElementById('timeLimitSetting');
        const includeNumbersCheckbox = document.getElementById('includeNumbers');
        const wordSetGibberish = document.getElementById('wordSetGibberish');
        const wordSetReal = document.getElementById('wordSetReal');
        const includeCapitalsCheckbox = document.getElementById('includeCapitals');
        const includeSpecialCharsCheckbox = document.getElementById('includeSpecialChars');

        // Handle individual key selection
        keys.forEach(key => {
            key.addEventListener('click', () => {
                const keyValue = key.dataset.key;

                // Space is always available, don't allow manual selection
                if (keyValue === ' ') return;

                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];

                if (selectedKeys.has(keyValue)) {
                    selectedKeys.delete(keyValue);
                    key.classList.remove('selected');
                } else {
                    selectedKeys.add(keyValue);
                    key.classList.add('selected');

                    // Auto-enable toggles when selecting numbers or special chars
                    if (numberKeys.includes(keyValue) && !includeNumbers) {
                        includeNumbers = true;
                        includeNumbersCheckbox.checked = true;
                    }
                    if (specialChars.includes(keyValue) && !includeSpecialChars) {
                        includeSpecialChars = true;
                        includeSpecialCharsCheckbox.checked = true;
                    }
                }

                updateSelectedKeysList();
                showSaveButton();
            });
        });

        // Handle finger button selection
        fingerBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const finger = btn.dataset.finger;
                const isActive = btn.classList.contains('active');

                if (isActive) {
                    // Deselect this finger's keys
                    btn.classList.remove('active');
                    fingerMap[finger].forEach(key => {
                        selectedKeys.delete(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.remove('selected');
                    });
                } else {
                    // Select this finger's keys - respect toggle settings
                    btn.classList.add('active');
                    const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                    const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                    const capitalKeys = ['caps', 'shift', 'shift-right'];

                    fingerMap[finger].forEach(key => {
                        // Skip space - it's always available
                        if (key === ' ') return;
                        // Skip numbers if disabled
                        if (!includeNumbers && numberKeys.includes(key)) return;
                        // Skip special chars if disabled
                        if (!includeSpecialChars && specialChars.includes(key)) return;
                        // Skip caps/shift if capitals are disabled
                        if (!useCapitals && capitalKeys.includes(key)) return;

                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });
                }

                updateSelectedKeysList();
                showSaveButton();
            });
        });

        // Settings event listeners
        modeWords.addEventListener('change', () => {
            isTimedMode = false;
            isUnlimitedMode = false;
            wordCountSetting.style.display = 'flex';
            timeLimitSetting.style.display = 'none';
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        modeTimed.addEventListener('change', () => {
            isTimedMode = true;
            isUnlimitedMode = false;
            wordCountSetting.style.display = 'none';
            timeLimitSetting.style.display = 'flex';
            const selectedTime = document.querySelector('input[name="timeLimit"]:checked');
            timeLimit = parseInt(selectedTime.value);
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        modeUnlimited.addEventListener('change', () => {
            isTimedMode = false;
            isUnlimitedMode = true;
            wordCountSetting.style.display = 'none';
            timeLimitSetting.style.display = 'none';
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        document.querySelectorAll('input[name="timeLimit"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                timeLimit = parseInt(e.target.value);
                showSaveButton();
                if (isTimedMode && selectedKeys.size > 0) generatePracticeText();
            });
        });

        document.querySelectorAll('input[name="wordCount"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                wordCount = parseInt(e.target.value);
                showSaveButton();
                if (!isTimedMode && !isUnlimitedMode && selectedKeys.size > 0) generatePracticeText();
            });
        });

        includeNumbersCheckbox.addEventListener('change', (e) => {
            includeNumbers = e.target.checked;
            showSaveButton();
            const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            // Add or remove number keys based on toggle
            fingerBtns.forEach(btn => {
                if (btn.classList.contains('active')) {
                    const finger = btn.dataset.finger;
                    fingerMap[finger].forEach(key => {
                        if (numberKeys.includes(key)) {
                            const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                            if (includeNumbers) {
                                selectedKeys.add(key);
                                if (keyEl) keyEl.classList.add('selected');
                            } else {
                                selectedKeys.delete(key);
                                if (keyEl) keyEl.classList.remove('selected');
                            }
                        }
                    });
                }
            });

            updateSelectedKeysList();
        });

        wordSetGibberish.addEventListener('change', () => {
            useRealWords = false;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        wordSetReal.addEventListener('change', () => {
            useRealWords = true;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        includeCapitalsCheckbox.addEventListener('change', (e) => {
            useCapitals = e.target.checked;
            showSaveButton();
            updateKeyboardVisuals();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        includeSpecialCharsCheckbox.addEventListener('change', (e) => {
            includeSpecialChars = e.target.checked;
            showSaveButton();
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];

            // Add or remove special char keys based on toggle
            fingerBtns.forEach(btn => {
                if (btn.classList.contains('active')) {
                    const finger = btn.dataset.finger;
                    fingerMap[finger].forEach(key => {
                        if (specialChars.includes(key)) {
                            const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                            if (includeSpecialChars) {
                                selectedKeys.add(key);
                                if (keyEl) keyEl.classList.add('selected');
                            } else {
                                selectedKeys.delete(key);
                                if (keyEl) keyEl.classList.remove('selected');
                            }
                        }
                    });
                }
            });

            updateSelectedKeysList();
        });

        document.getElementById('includeSpaces').addEventListener('change', (e) => {
            includeSpaces = e.target.checked;
            showSaveButton();
            if (selectedKeys.size > 0) generatePracticeText();
        });

        // Error Mode listeners
        document.querySelectorAll('input[name="errorMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                errorMode = e.target.value;
                showSaveButton();
            });
        });

        // Word Bank listeners
        document.querySelectorAll('input[name="wordBank"]').forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const size = e.target.value;
                showSaveButton();
                await loadWordBank(size);
                // Regenerate text with new word bank if already practicing
                if (selectedKeys.size > 0 && currentText) {
                    generatePracticeText();
                }
            });
        });

        // Font size change
        document.querySelectorAll('input[name="fontSize"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                fontSize = e.target.value;
                showSaveButton();
                // Remove all font size classes
                targetText.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                // Add the selected font size class
                targetText.classList.add(`font-${fontSize}`);
            });
        });

        function updateKeyboardVisuals() {
            // Update keyboard visual highlights based on settings
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const capitalKeys = ['caps', 'shift', 'shift-right'];
            const nonTypeableKeys = ['tab', 'enter', 'backspace'];
            const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            keys.forEach(key => {
                const keyValue = key.dataset.key;
                const isSpecialChar = specialChars.includes(keyValue);
                const isCapitalKey = capitalKeys.includes(keyValue);
                const isNonTypeable = nonTypeableKeys.includes(keyValue);
                const isNumberKey = numberKeys.includes(keyValue);

                let shouldDim = false;

                // Always dim non-typeable keys (tab, enter, backspace)
                if (isNonTypeable) {
                    shouldDim = true;
                }
                // Dim number keys if disabled
                else if (!includeNumbers && isNumberKey && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }
                // Dim special chars if disabled
                else if (!includeSpecialChars && isSpecialChar && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }
                // Dim caps/shift keys if capitals are disabled
                else if (!useCapitals && isCapitalKey && selectedKeys.has(keyValue)) {
                    shouldDim = true;
                }

                // Apply or reset visual state
                if (shouldDim) {
                    key.style.opacity = '0.3';
                    key.style.filter = 'grayscale(70%)';
                } else {
                    key.style.opacity = '';
                    key.style.filter = '';
                }
            });
        }

        function updateSelectedKeysList() {
            if (selectedKeys.size === 0) {
                selectedKeysList.textContent = 'None - Click keys above or use finger shortcuts';
                generateBtn.disabled = true;
                restartBtn.disabled = true;
                targetText.innerHTML = 'Select keys above to generate practice text';
                typingInput.disabled = true;
                typingInput.value = '';
            } else {
                const nonTypeableKeys = ['tab', 'caps', 'shift', 'shift-right', 'enter', 'backspace'];
                let typeableKeys = Array.from(selectedKeys).filter(k => !nonTypeableKeys.includes(k));

                // Filter out space from display (it's always available anyway)
                typeableKeys = typeableKeys.filter(k => k !== ' ');

                // Filter out numbers if setting is disabled
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                if (!includeNumbers) {
                    typeableKeys = typeableKeys.filter(k => !numberKeys.includes(k));
                }

                // Filter out special chars if setting is disabled
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                if (!includeSpecialChars) {
                    typeableKeys = typeableKeys.filter(k => !specialChars.includes(k));
                }

                const keysArray = typeableKeys.map(k => k.toUpperCase());
                selectedKeysList.textContent = keysArray.length > 0 ? keysArray.join(', ') : 'Only disabled keys selected - enable Numbers/Special Chars to use them';
                generateBtn.disabled = typeableKeys.length === 0;
                restartBtn.disabled = typeableKeys.length === 0;

                // Auto-generate practice text when keys are selected
                if (typeableKeys.length > 0) {
                    generatePracticeText();
                }
            }
        }

        function restartTest() {
            if (!currentText) return;

            currentPosition = 0;
            errorCount = 0;
            totalTyped = 0;
            startTime = null;
            lastWpmUpdate = 0;
            errorPositions.clear();

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            if (isTimedMode) {
                timeRemaining.textContent = timeLimit + 's';
                timerDisplay.classList.remove('warning', 'danger');
            }

            renderText();
            updateStats();

            typingInput.value = '';
            typingInput.disabled = false;
            showOverlay();
        }

        function startTimer() {
            if (!isTimedMode) return;

            let elapsed = 0;
            timerInterval = setInterval(() => {
                elapsed++;
                const remaining = timeLimit - elapsed;
                timeRemaining.textContent = remaining + 's';

                if (remaining <= 10 && remaining > 5) {
                    timerDisplay.classList.add('warning');
                    timerDisplay.classList.remove('danger');
                } else if (remaining <= 5) {
                    timerDisplay.classList.add('danger');
                    timerDisplay.classList.remove('warning');
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    endTest();
                }
            }, 1000);
        }

        function endTest() {
            typingInput.disabled = true;
            const finalWPM = calculateWPM();
            const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);

            setTimeout(() => {
                showModal(`Time's up!\n\nWPM: ${finalWPM}\nAccuracy: ${finalAccuracy}%\nErrors: ${errorCount}\n\nClick "Generate New Exercise" to try again!`);
            }, 100);
        }

        function calculateWPM() {
            if (!startTime) return 0;
            const timeElapsed = (Date.now() - startTime) / 1000 / 60; // minutes
            const wordsTyped = currentPosition / 5; // standard: 5 characters = 1 word
            return Math.round(wordsTyped / timeElapsed) || 0;
        }

        function getFilteredKeys() {
            // Filter out non-typeable keys
            const nonTypeableKeys = ['tab', 'caps', 'shift', 'shift-right', 'enter', 'backspace'];
            let keysArray = Array.from(selectedKeys).filter(key => !nonTypeableKeys.includes(key));

            // Filter out numbers if setting is disabled
            if (!includeNumbers) {
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                keysArray = keysArray.filter(key => !numberKeys.includes(key));
            }

            // Filter out special characters if setting is disabled
            if (!includeSpecialChars) {
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                keysArray = keysArray.filter(key => !specialChars.includes(key));
            }

            // Include space if enabled
            if (includeSpaces && !keysArray.includes(' ')) {
                keysArray.push(' ');
            }

            return keysArray;
        }

        function getFilteredRealWords(keysArray) {
            // Filter real words to only include words that can be typed with selected keys
            const keySet = new Set(keysArray);
            return realWords.filter(word => {
                // Check if all characters in the word are available in selected keys
                for (let char of word) {
                    if (!keySet.has(char.toLowerCase())) {
                        return false;
                    }
                }
                return true;
            });
        }

        function capitalizeWord(word) {
            if (word.length === 0) return word;
            return word.charAt(0).toUpperCase() + word.slice(1);
        }

        function applyCapitalization(text) {
            if (!useCapitals) return text;

            // Determine which shift keys are selected
            const hasLeftShift = selectedKeys.has('shift');
            const hasRightShift = selectedKeys.has('shift-right');

            // Define which letters belong to which hand
            const leftHandLetters = ['q', 'w', 'e', 'r', 't', 'a', 's', 'd', 'f', 'g', 'z', 'x', 'c', 'v', 'b', '1', '2', '3', '4', '5'];
            const rightHandLetters = ['y', 'u', 'i', 'o', 'p', 'h', 'j', 'k', 'l', 'n', 'm', '6', '7', '8', '9', '0'];

            const words = text.split(' ');
            let wordsSinceCapital = 0;

            for (let i = 0; i < words.length; i++) {
                // Capitalize first word, or randomly every 8-12 words (simulating sentences)
                if (i === 0 || (wordsSinceCapital >= 8 && Math.random() < 0.3)) {
                    // Capitalize word based on shift selection
                    if (hasLeftShift && hasRightShift) {
                        // Both shifts: capitalize all
                        words[i] = capitalizeWord(words[i]);
                    } else if (hasRightShift) {
                        // Right shift: capitalize left hand letters only
                        words[i] = capitalizeWordSelective(words[i], leftHandLetters);
                    } else if (hasLeftShift) {
                        // Left shift: capitalize right hand letters only
                        words[i] = capitalizeWordSelective(words[i], rightHandLetters);
                    } else {
                        // No shift selected, use regular capitalization
                        words[i] = capitalizeWord(words[i]);
                    }
                    wordsSinceCapital = 0;
                } else {
                    wordsSinceCapital++;
                }
            }

            return words.join(' ');
        }

        function capitalizeWordSelective(word, allowedLetters) {
            // Only capitalize letters that are in the allowed set
            return word.split('').map(char => {
                if (allowedLetters.includes(char.toLowerCase())) {
                    return char.toUpperCase();
                }
                return char;
            }).join('');
        }

        function generateGibberishText(keysArray, numWords) {
            // Separate letters, numbers, and special characters
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const letters = keysArray.filter(key => !specialChars.includes(key) && !numbers.includes(key));
            const availableSpecials = keysArray.filter(key => specialChars.includes(key));
            const availableNumbers = keysArray.filter(key => numbers.includes(key));

            let text = '';
            for (let i = 0; i < numWords; i++) {
                const wordLength = Math.floor(Math.random() * 7) + 2; // Random length between 2-8 characters

                // Generate word primarily from letters
                const useLettersForWord = letters.length > 0;
                const sourceArray = useLettersForWord ? letters : keysArray;

                for (let j = 0; j < wordLength; j++) {
                    const randomKey = sourceArray[Math.floor(Math.random() * sourceArray.length)];
                    text += randomKey;
                }

                // Add numbers within or after words if selected
                if (includeNumbers && availableNumbers.length > 0 && Math.random() < 0.4) {
                    const numLength = Math.floor(Math.random() * 3) + 1; // 1-3 digits
                    for (let k = 0; k < numLength; k++) {
                        const randomNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                        text += randomNum;
                    }
                }

                // Add special characters at word boundaries if enabled
                if (includeSpecialChars && availableSpecials.length > 0 && Math.random() < 0.3) {
                    const randomSpecial = availableSpecials[Math.floor(Math.random() * availableSpecials.length)];
                    text += randomSpecial;
                }

                if (i < numWords - 1 && includeSpaces) text += ' ';
            }
            return useCapitals ? applyCapitalization(text) : text;
        }

        function generateRealWordsText(keysArray, numWords) {
            const availableWords = getFilteredRealWords(keysArray);

            if (availableWords.length === 0) {
                // Fall back to gibberish if no real words available
                return generateGibberishText(keysArray, numWords);
            }

            // Get available special characters and numbers
            const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const availableSpecials = keysArray.filter(key => specialChars.includes(key));
            const availableNumbers = keysArray.filter(key => numbers.includes(key));
            const punctuation = availableSpecials.filter(char => [',', '.', '!', '?', ';', ':'].includes(char));

            let text = '';
            for (let i = 0; i < numWords; i++) {
                let word = availableWords[Math.floor(Math.random() * availableWords.length)];

                // Force lowercase if capitals are disabled
                if (!useCapitals) {
                    word = word.toLowerCase();
                }

                text += word;

                // Add numbers after words if selected
                if (includeNumbers && availableNumbers.length > 0 && Math.random() < 0.3) {
                    const numLength = Math.floor(Math.random() * 3) + 1; // 1-3 digits
                    for (let k = 0; k < numLength; k++) {
                        const randomNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                        text += randomNum;
                    }
                }

                // Add punctuation occasionally if special chars are enabled
                if (includeSpecialChars && punctuation.length > 0 && Math.random() < 0.2) {
                    const randomPunct = punctuation[Math.floor(Math.random() * punctuation.length)];
                    text += randomPunct;
                }

                // Add other special characters occasionally
                if (includeSpecialChars && availableSpecials.length > 0 && Math.random() < 0.15) {
                    const randomSpecial = availableSpecials[Math.floor(Math.random() * availableSpecials.length)];
                    text += randomSpecial;
                }

                if (i < numWords - 1 && includeSpaces) text += ' ';
            }
            return useCapitals ? applyCapitalization(text) : text;
        }

        function appendMoreText() {
            // Append more words to the current text for unlimited mode
            const keysArray = getFilteredKeys();
            if (keysArray.length === 0) return;

            const numWords = 50; // Add 50 more words at a time
            let newText = includeSpaces ? ' ' : ''; // Add space before new words if enabled

            if (useRealWords) {
                newText += generateRealWordsText(keysArray, numWords);
            } else {
                newText += generateGibberishText(keysArray, numWords);
            }

            // Remove any double spaces
            newText = newText.replace(/\s+/g, ' ');

            currentText += newText;
            renderText();
        }

        function generatePracticeText() {
            if (selectedKeys.size === 0) return;

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const keysArray = getFilteredKeys();

            if (keysArray.length === 0) {
                showModal('Please select some typeable keys (letters, numbers, symbols)');
                return;
            }

            // Generate more words for timed/unlimited modes
            const numWords = isUnlimitedMode ? 200 : (isTimedMode ? 100 : wordCount);

            let text = '';
            if (useRealWords) {
                text = generateRealWordsText(keysArray, numWords);
            } else {
                text = generateGibberishText(keysArray, numWords);
            }

            // Remove any double spaces
            text = text.replace(/\s+/g, ' ').trim();

            currentText = text;
            currentPosition = 0;
            errorCount = 0;
            totalTyped = 0;
            startTime = null;
            lastWpmUpdate = 0;
            errorPositions.clear();

            // Setup timer display
            if (isTimedMode) {
                timerDisplay.style.display = 'block';
                timeRemaining.textContent = timeLimit + 's';
                timerDisplay.classList.remove('warning', 'danger');
            } else {
                timerDisplay.style.display = 'none';
            }

            renderText();
            updateStats();

            typingInput.value = '';
            typingInput.disabled = false;
            showOverlay();
        }

        function renderText() {
            let html = '';
            let i = 0;

            while (i < currentText.length) {
                // Start a word wrapper
                html += '<span class="word-wrapper">';

                // Collect all characters until we hit a space or end of text
                while (i < currentText.length && currentText[i] !== ' ') {
                    const char = currentText[i];
                    let className = '';
                    let displayChar = char;

                    if (i < currentPosition) {
                        if (errorPositions.has(i)) {
                            className = 'incorrect';
                            const typedChar = errorPositions.get(i);
                            displayChar = `<span class="error-typed">${typedChar}</span>${char}`;
                        } else {
                            className = 'correct';
                        }
                    } else if (i === currentPosition) {
                        className = 'current';
                    } else {
                        className = 'upcoming';
                    }

                    html += `<span class="${className}" data-index="${i}">${displayChar}</span>`;
                    i++;
                }

                html += '</span>';

                // Handle space if present
                if (i < currentText.length && currentText[i] === ' ') {
                    let className = '';
                    if (i < currentPosition) {
                        className = errorPositions.has(i) ? 'incorrect' : 'correct';
                    } else if (i === currentPosition) {
                        className = 'current';
                    } else {
                        className = 'upcoming';
                    }
                    className += ' space-char';

                    html += `<span class="${className}" data-index="${i}"> </span>`;
                    i++;
                }
            }

            targetText.innerHTML = html;

            // Auto-scroll to keep current character visible
            setTimeout(() => {
                const currentSpan = targetText.querySelector('.current');
                if (currentSpan) {
                    const container = targetText;
                    const spanTop = currentSpan.offsetTop;
                    const spanHeight = currentSpan.offsetHeight;
                    const containerHeight = container.clientHeight;
                    const scrollTop = container.scrollTop;

                    // In unlimited mode, keep current line in the top 1/3 of the visible area
                    // This ensures you can always see plenty of upcoming text
                    const targetScrollPosition = spanTop - containerHeight * 0.25;

                    // Scroll if current character is outside the comfortable viewing area
                    if (spanTop < scrollTop + spanHeight ||
                        spanTop > scrollTop + containerHeight * 0.6) {
                        container.scrollTop = Math.max(0, targetScrollPosition);
                    }
                }
            }, 0);
        }

        function updateStats() {
            const accuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
            accuracyEl.textContent = accuracy + '%';
            progressEl.textContent = `${currentPosition}/${currentText.length}`;
            errorsEl.textContent = errorCount;

            // Update WPM only every 5 seconds
            const now = Date.now();
            if (now - lastWpmUpdate >= 5000) {
                const wpm = calculateWPM();
                wpmEl.textContent = wpm;
                lastWpmUpdate = now;
            }

            // Update time elapsed
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeElapsedEl.textContent = elapsed + 's';
            } else {
                timeElapsedEl.textContent = '0s';
            }

            // Update progress bar
            const progressPercent = currentText.length > 0 ? (currentPosition / currentText.length) * 100 : 0;
            progressBar.style.width = progressPercent + '%';
        }

        typingInput.addEventListener('input', (e) => {
            const typedValue = e.target.value;
            const typedChar = typedValue[typedValue.length - 1];

            // Start timer on first keystroke
            if (!startTime && typedValue.length === 1) {
                startTime = Date.now();
                if (isTimedMode) {
                    startTimer();
                }
            }

            if (typedValue.length > currentPosition) {
                totalTyped++;

                if (typedChar === currentText[currentPosition]) {
                    // Correct character typed
                    // If this position was previously an error, remove it
                    if (errorPositions.has(currentPosition)) {
                        errorPositions.delete(currentPosition);
                    }
                    currentPosition++;

                    // In unlimited mode, append more text when getting close to the end
                    if (isUnlimitedMode && currentPosition > currentText.length - 100) {
                        appendMoreText();
                    }

                    if (currentPosition === currentText.length) {
                        // Completed!
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }

                        if (isUnlimitedMode) {
                            // Unlimited mode - just append more text
                            appendMoreText();
                        } else if (!isTimedMode) {
                            // Word count mode - auto-generate new exercise
                            setTimeout(() => {
                                generatePracticeText();
                            }, 500);
                        } else {
                            // Timed mode - show completion message
                            typingInput.disabled = true;
                            const finalWPM = calculateWPM();
                            const finalAccuracy = totalTyped === 0 ? 100 : Math.round(((totalTyped - errorCount) / totalTyped) * 100);
                            setTimeout(() => {
                                showModal(`Great job!\n\nWPM: ${finalWPM}\nAccuracy: ${finalAccuracy}%\nErrors: ${errorCount}\n\nClick "Generate New Exercise" for another round!`);
                            }, 100);
                        }
                    }
                } else {
                    errorCount++;

                    // Handle different error modes
                    if (errorMode === 'block') {
                        // Block mode: Don't advance position, remove incorrect character
                        e.target.value = typedValue.slice(0, -1);
                    } else if (errorMode === 'backspace') {
                        // Backspace mode: Mark as error, allow backspace to correct
                        errorPositions.set(currentPosition, typedChar);
                        currentPosition++;
                    }
                }

                renderText();
                updateStats();
            }
        });

        // Handle backspace for backspace error mode
        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && errorMode === 'backspace') {
                const typedValue = e.target.value;
                if (typedValue.length < currentPosition && currentPosition > 0) {
                    // Allow going back
                    currentPosition--;
                    // Remove from error positions if correcting
                    errorPositions.delete(currentPosition);
                    renderText();
                    updateStats();
                }
            }
        });

        generateBtn.addEventListener('click', generatePracticeText);
        restartBtn.addEventListener('click', restartTest);
        saveSettingsBtn.addEventListener('click', () => {
            saveSettings();
            hideSaveButton();
        });

        // Click on target text to focus input and start typing
        targetText.addEventListener('click', () => {
            if (!typingInput.disabled) {
                typingInput.focus();
            }
        });

        // Make the entire practice area focusable - click anywhere to start typing
        document.addEventListener('click', (e) => {
            // Only auto-focus if we have text and input is enabled
            if (currentText && !typingInput.disabled && !e.target.closest('button') && !e.target.closest('input') && !e.target.closest('.key') && !e.target.closest('.finger-btn')) {
                typingInput.focus();
            }
        });

        // Update stats continuously for real-time WPM and time display
        setInterval(() => {
            if (startTime && !typingInput.disabled) {
                updateStats();
            }
        }, 100);

        // Settings Dropdown
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        // Focus Mode
        const focusToggle = document.getElementById('focusToggle');
        const focusHint = document.querySelector('.focus-hint');
        let isFocusMode = false;
        let focusHintTimeout = null;

        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            document.body.classList.toggle('focus-mode', isFocusMode);
            focusToggle.checked = isFocusMode;

            // Clear any existing timeout
            if (focusHintTimeout) {
                clearTimeout(focusHintTimeout);
                focusHintTimeout = null;
            }

            if (isFocusMode) {
                // Show the hint and hide it after 3 seconds
                focusHint.classList.remove('hidden');
                focusHintTimeout = setTimeout(() => {
                    focusHint.classList.add('hidden');
                }, 3000);
            } else {
                // Remove the hidden class when exiting focus mode
                focusHint.classList.remove('hidden');
            }
        }

        focusToggle.addEventListener('change', () => {
            toggleFocusMode();
        });

        // Reset Button
        const resetBtn = document.getElementById('resetBtn');
        resetBtn.addEventListener('click', () => {
            if (confirm('Reset all settings? This will clear your saved preferences and selected keys, then refresh the page.')) {
                localStorage.clear();
                location.reload();
            }
        });

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        // Default to dark mode if not set in localStorage
        let isDarkMode = localStorage.getItem('darkMode') !== null
            ? localStorage.getItem('darkMode') === 'true'
            : true;

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            darkModeToggle.checked = isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Initialize dark mode
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        }

        darkModeToggle.addEventListener('change', () => {
            toggleDarkMode();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape - Toggle focus mode
            if (e.key === 'Escape') {
                e.preventDefault();
                if (isFocusMode) {
                    toggleFocusMode();
                }
            }

            // Tab+Enter or Shift+Enter - Restart test
            if ((e.shiftKey || e.key === 'Tab') && e.key === 'Enter') {
                e.preventDefault();
                if (!restartBtn.disabled) {
                    restartTest();
                }
            }

            // Enter after Tab - Restart test
            if (e.key === 'Enter' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                const activeEl = document.activeElement;
                // Check if Tab was pressed recently (within 500ms)
                if (window.lastTabPress && Date.now() - window.lastTabPress < 500) {
                    e.preventDefault();
                    if (!restartBtn.disabled) {
                        restartTest();
                    }
                }
            }

            // Track Tab key press
            if (e.key === 'Tab') {
                window.lastTabPress = Date.now();
            }

            // Cmd+N (Mac) or Alt+N (Windows) - Generate new exercise
            if ((e.metaKey || e.altKey) && e.key === 'n') {
                e.preventDefault();
                if (!generateBtn.disabled) {
                    generatePracticeText();
                }
            }

            // Cmd+K (Mac) or Alt+K (Windows) - Focus input and scroll to practice area
            if ((e.metaKey || e.altKey) && e.key === 'k') {
                e.preventDefault();
                if (!typingInput.disabled) {
                    // Scroll to practice area
                    const practiceArea = document.querySelector('.practice-area');
                    if (practiceArea) {
                        practiceArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    // Focus input after a short delay to ensure scroll completes
                    setTimeout(() => {
                        typingInput.focus();
                    }, 100);
                }
            }
        });

        // Prevent backspace in typing input
        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                e.preventDefault();
            }
        });

        // Typing Overlay
        const typingOverlay = document.getElementById('typingOverlay');

        function hideOverlay() {
            if (typingOverlay && !typingOverlay.classList.contains('hidden')) {
                typingOverlay.classList.add('hidden');
                if (!typingInput.disabled) {
                    typingInput.focus();
                }
            }
        }

        function showOverlay() {
            if (typingOverlay && currentText) {
                typingOverlay.classList.remove('hidden');
            }
        }

        // Hide overlay on click
        if (typingOverlay) {
            typingOverlay.addEventListener('click', hideOverlay);
        }

        // Hide overlay on any keypress
        document.addEventListener('keydown', (e) => {
            if (typingOverlay && !typingOverlay.classList.contains('hidden') && currentText) {
                // Don't hide for modifier keys only
                if (!['Shift', 'Control', 'Alt', 'Meta'].includes(e.key)) {
                    hideOverlay();
                }
            }
        });

        // Custom Modal
        const customModal = document.getElementById('customModal');
        const modalBody = document.getElementById('modalBody');
        const modalBtn = document.getElementById('modalBtn');

        function showModal(message) {
            modalBody.textContent = message;
            customModal.classList.add('show');
        }

        function hideModal() {
            customModal.classList.remove('show');
        }

        // Close modal on button click
        if (modalBtn) {
            modalBtn.addEventListener('click', hideModal);
        }

        // Close modal on backdrop click
        if (customModal) {
            customModal.addEventListener('click', (e) => {
                if (e.target === customModal) {
                    hideModal();
                }
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && customModal.classList.contains('show')) {
                hideModal();
            }
        });

        // Close modal on Enter key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && customModal.classList.contains('show')) {
                hideModal();
            }
        });

        // Save button visibility
        function showSaveButton() {
            saveSettingsBtn.classList.add('visible');
        }

        function hideSaveButton() {
            saveSettingsBtn.classList.remove('visible');
        }

        // LocalStorage functions
        function saveSettings() {
            const settings = {
                mode: isTimedMode ? 'timed' : (isUnlimitedMode ? 'unlimited' : 'words'),
                wordCount: wordCount,
                timeLimit: timeLimit,
                includeNumbers: includeNumbers,
                useRealWords: useRealWords,
                includeCapitals: useCapitals,
                includeSpecialChars: includeSpecialChars,
                includeSpaces: includeSpaces,
                errorMode: errorMode,
                wordBankSize: wordBankSize,
                fontSize: fontSize,
                selectedKeys: Array.from(selectedKeys)
            };
            localStorage.setItem('typingPracticeSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('typingPracticeSettings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                // Apply mode settings
                if (settings.mode === 'timed') {
                    isTimedMode = true;
                    isUnlimitedMode = false;
                    modeTimed.checked = true;
                } else if (settings.mode === 'unlimited') {
                    isTimedMode = false;
                    isUnlimitedMode = true;
                    modeUnlimited.checked = true;
                } else {
                    isTimedMode = false;
                    isUnlimitedMode = false;
                    modeWords.checked = true;
                }

                // Apply word count
                if (settings.wordCount !== undefined) {
                    wordCount = settings.wordCount;
                    const wordCountRadio = document.getElementById(`wordCount${settings.wordCount}`);
                    if (wordCountRadio) wordCountRadio.checked = true;
                }

                // Apply time limit
                if (settings.timeLimit !== undefined) {
                    timeLimit = settings.timeLimit;
                    const timeLimitRadio = document.getElementById(`time${settings.timeLimit}`);
                    if (timeLimitRadio) timeLimitRadio.checked = true;
                }

                // Apply toggles
                if (settings.includeNumbers !== undefined) {
                    includeNumbers = settings.includeNumbers;
                    includeNumbersCheckbox.checked = settings.includeNumbers;
                }

                if (settings.useRealWords !== undefined) {
                    useRealWords = settings.useRealWords;
                    if (settings.useRealWords) {
                        wordSetReal.checked = true;
                    } else {
                        wordSetGibberish.checked = true;
                    }
                }

                if (settings.includeCapitals !== undefined) {
                    includeCapitals = settings.includeCapitals;
                    includeCapitalsCheckbox.checked = settings.includeCapitals;
                }

                if (settings.includeSpecialChars !== undefined) {
                    includeSpecialChars = settings.includeSpecialChars;
                    includeSpecialCharsCheckbox.checked = settings.includeSpecialChars;
                }

                if (settings.includeSpaces !== undefined) {
                    includeSpaces = settings.includeSpaces;
                    document.getElementById('includeSpaces').checked = settings.includeSpaces;
                }

                // Apply error mode
                if (settings.errorMode !== undefined) {
                    errorMode = settings.errorMode;
                    if (settings.errorMode === 'backspace') {
                        errorModeBackspace.checked = true;
                    } else {
                        errorModeBlock.checked = true;
                    }
                }

                // Apply word bank size
                if (settings.wordBankSize !== undefined) {
                    wordBankSize = settings.wordBankSize;
                    const wordBankRadio = document.getElementById(`wordBank${settings.wordBankSize}`);
                    if (wordBankRadio) wordBankRadio.checked = true;
                }

                // Apply font size
                if (settings.fontSize !== undefined) {
                    fontSize = settings.fontSize;
                    const fontSizeRadio = document.getElementById(`fontSize${settings.fontSize.charAt(0).toUpperCase() + settings.fontSize.slice(1)}`);
                    if (fontSizeRadio) fontSizeRadio.checked = true;
                    // Remove all font size classes and add the selected one
                    targetText.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                    targetText.classList.add(`font-${fontSize}`);
                }

                // Restore selected keys
                if (settings.selectedKeys && Array.isArray(settings.selectedKeys)) {
                    // Clear current selection
                    selectedKeys.clear();
                    document.querySelectorAll('.key.selected').forEach(key => {
                        key.classList.remove('selected');
                    });
                    document.querySelectorAll('.finger-btn.active').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Restore selected keys
                    settings.selectedKeys.forEach(key => {
                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });

                    // Activate finger buttons based on selected keys
                    const fingerBtns = document.querySelectorAll('.finger-btn');
                    fingerBtns.forEach(btn => {
                        const finger = btn.dataset.finger;
                        const fingerKeys = fingerMap[finger];
                        // Check if any key from this finger is selected
                        const hasSelectedKeys = fingerKeys.some(key => selectedKeys.has(key));
                        if (hasSelectedKeys) {
                            btn.classList.add('active');
                        }
                    });

                    // Update the selected keys list display
                    updateSelectedKeysList();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Initialize settings display based on defaults
        function initializeSettingsDisplay() {
            // Set up display based on default mode (Infinited)
            if (isUnlimitedMode) {
                wordCountSetting.style.display = 'none';
                timeLimitSetting.style.display = 'none';
            } else if (isTimedMode) {
                wordCountSetting.style.display = 'none';
                timeLimitSetting.style.display = 'flex';
            } else {
                wordCountSetting.style.display = 'flex';
                timeLimitSetting.style.display = 'none';
            }
        }

        // Initialize: Auto-select all fingers on page load (only if no saved selection)
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize default font size
            targetText.classList.add('font-medium');

            // Load saved settings first
            loadSettings();

            // Initialize settings display based on loaded settings
            initializeSettingsDisplay();

            // Only auto-select all fingers if there are no saved keys
            if (selectedKeys.size === 0) {
                const numberKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                const specialChars = ['`', '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', '[', ']', '{', '}', '\\', '|', ';', ':', "'", '"', ',', '<', '.', '>', '/', '?'];
                const capitalKeys = ['caps', 'shift', 'shift-right'];

                fingerBtns.forEach(btn => {
                    const finger = btn.dataset.finger;
                    btn.classList.add('active');
                    fingerMap[finger].forEach(key => {
                        // Skip space - it's always available
                        if (key === ' ') return;
                        // Skip numbers if disabled
                        if (!includeNumbers && numberKeys.includes(key)) return;
                        // Skip special chars if disabled
                        if (!includeSpecialChars && specialChars.includes(key)) return;
                        // Skip caps/shift if capitals are disabled
                        if (!useCapitals && capitalKeys.includes(key)) return;

                        selectedKeys.add(key);
                        const keyEl = document.querySelector(`.key[data-key="${key}"]`);
                        if (keyEl) keyEl.classList.add('selected');
                    });
                });
                updateSelectedKeysList();
            }
        });
    </script>
</body>
</html>